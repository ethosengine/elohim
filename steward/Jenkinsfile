/**
 * Elohim Steward Pipeline
 *
 * Builds steward apps (desktop + mobile) using tauri-plugin-holochain.
 * For those who run their own Holochain nodes as stewards of co-creation.
 *
 * This is a multibranch pipeline within the elohim mono-repo.
 * Jenkins job configured to look at steward/Jenkinsfile
 *
 * Platforms:
 *   - Linux: AppImage, .deb (default)
 *   - macOS: .dmg (future, requires macOS agent)
 *   - Windows: .exe (future, requires Windows agent)
 *   - Android: .apk (future, requires Android SDK)
 *
 * Dependencies (fetched from other pipelines in mono-repo):
 *   - lamad.happ from elohim/holochain pipeline artifacts
 *   - Angular dist from elohim/elohim-app pipeline artifacts
 */

pipeline {
    agent {
        kubernetes {
            cloud 'kubernetes'
            yaml '''
apiVersion: v1
kind: Pod
spec:
  serviceAccount: jenkins-deployer
  nodeSelector:
    node-type: operations
  tolerations:
    - key: "workload-type"
      operator: "Equal"
      value: "build"
      effect: "NoSchedule"
  volumes:
    - name: cargo-cache
      persistentVolumeClaim:
        claimName: cargo-cache-holochain
  containers:
    - name: builder
      image: harbor.ethosengine.com/ethosengine/ci-builder-nix:latest
      command: [cat]
      tty: true
      resources:
        requests:
          memory: "8Gi"
          cpu: "4"
        limits:
          memory: "16Gi"
          cpu: "8"
      volumeMounts:
        - name: cargo-cache
          mountPath: /root/.cargo
'''
        }
    }

    environment {
        PATH = "/nix/var/nix/profiles/default/bin:${env.PATH}"
        BRANCH_NAME = "${env.BRANCH_NAME ?: 'main'}"
        // Required for AppImage bundling in containerized environments without FUSE
        APPIMAGE_EXTRACT_AND_RUN = '1'
    }

    options {
        timeout(time: 90, unit: 'MINUTES')
        disableConcurrentBuilds()
    }

    parameters {
        string(
            name: 'HAPP_VERSION',
            defaultValue: 'dev-latest',
            description: 'hApp version/tag to fetch from holochain pipeline'
        )
        string(
            name: 'UI_VERSION',
            defaultValue: 'dev-latest',
            description: 'UI version/tag to fetch from elohim-app pipeline'
        )
        booleanParam(
            name: 'PUBLISH_RELEASE',
            defaultValue: false,
            description: 'Publish to GitHub Releases'
        )
    }

    stages {
        stage('Checkout') {
            steps {
                container('builder') {
                    script {
                        sh 'git config --global --add safe.directory "*"'
                        checkout scm

                        echo """
                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        ğŸ“¦ STEWARD BUILD CONTEXT
                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        Branch: ${env.BRANCH_NAME}
                        hApp Version: ${params.HAPP_VERSION}
                        UI Version: ${params.UI_VERSION}
                        Publish Release: ${params.PUBLISH_RELEASE}
                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        """
                    }
                }
            }
        }

        stage('Setup Nix Cache') {
            when {
                anyOf {
                    branch 'main'
                    branch 'dev'
                    changeset "steward/**"
                    changeset "holochain/dna/**"
                    changeset "elohim-app/src/**"
                    changeset "VERSION"
                }
            }
            steps {
                container('builder') {
                    dir('steward') {
                        script {
                            echo 'Configuring Nix with Holochain and Darksoil Cachix...'
                            sh '''
                                nix --version
                                echo "Nix config:"
                                nix show-config | grep -E "(substituters|trusted-public-keys)" || true
                            '''
                        }
                    }
                }
            }
        }

        stage('ğŸ“¦ Fetch hApp Artifact') {
            when {
                anyOf {
                    branch 'main'
                    branch 'dev'
                    changeset "steward/**"
                    changeset "holochain/dna/**"
                    changeset "elohim-app/src/**"
                    changeset "VERSION"
                }
            }
            steps {
                container('builder') {
                    dir('steward') {
                        script {
                            echo """
                            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            ğŸ“¦ FETCHING hApp ARTIFACT
                            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            Target version: ${params.HAPP_VERSION}
                            Branch: ${env.BRANCH_NAME}
                            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            """

                            // Strategy: Three-tier fallback for maximum reliability
                            // 1. Fetch from Jenkins artifacts (fast, ~30 sec)
                            // 2. Fall back to local build (slow, ~20-40 min)
                            // 3. Error if neither works

                            def artifactUrl = "https://jenkins.ethosengine.com/job/elohim-holochain/job/${env.BRANCH_NAME}/lastSuccessfulBuild/artifact/holochain/dna/lamad-spike/lamad-spike.happ"

                            // Ensure workdir exists
                            sh 'mkdir -p workdir'

                            // Strategy 1: Try to fetch from Jenkins artifacts
                            echo """
                            ğŸ”„ STRATEGY 1: Fetching from Jenkins artifacts...
                            URL: ${artifactUrl}
                            """

                            def fetched = sh(
                                script: """
                                    set +e
                                    wget --timeout=30 --tries=3 -O workdir/lamad.happ '${artifactUrl}' 2>&1
                                    exit_code=\$?
                                    set -e
                                    exit \$exit_code
                                """,
                                returnStatus: true
                            ) == 0

                            if (fetched && fileExists('workdir/lamad.happ')) {
                                def fileSize = sh(script: 'ls -lh workdir/lamad.happ | awk \'{print \$5}\'', returnStdout: true).trim()
                                echo """
                                âœ… hApp fetched from Jenkins artifacts (${fileSize})

                                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                â±ï¸  Artifact fetch completed in ~30 seconds
                                ğŸ’° Saved ~35 minutes vs local build!
                                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                """
                            } else {
                                // Strategy 2: Fallback to local build
                                echo """
                                âš ï¸  STRATEGY 2: Artifact not found in Jenkins
                                âš ï¸  Falling back to local hApp build (20-40 minutes)

                                This should rarely happen. If you see this often:
                                - Check holochain pipeline succeeded
                                - Verify artifacts are archived correctly
                                - Check network connectivity to Jenkins
                                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                """

                                sh '''#!/usr/bin/env bash
                                    set -euo pipefail

                                    export HOME="${HOME:-/root}"
                                    mkdir -p "$HOME"
                                    echo "[safe]" > "$HOME/.gitconfig"
                                    echo "    directory = *" >> "$HOME/.gitconfig"
                                    export GIT_CONFIG_GLOBAL="$HOME/.gitconfig"

                                    cd ../holochain/dna/lamad-spike

                                    echo "Building hApp from source (this will take 20-40 minutes)..."
                                    nix develop --accept-flake-config --command bash -c '
                                        set -euo pipefail
                                        cargo build --release --target wasm32-unknown-unknown
                                        hc dna pack . -o workdir/lamad_spike.dna
                                        hc app pack workdir -o lamad-spike.happ
                                    '

                                    cp lamad-spike.happ ../../../steward/workdir/lamad.happ
                                    echo "âœ… Local hApp build completed"
                                '''
                            }

                            // Strategy 3: Verify artifact exists (error if missing)
                            if (!fileExists('workdir/lamad.happ')) {
                                error "hApp artifact not found after fetch/build attempt"
                            }

                            sh 'echo "Final artifact:"; ls -lh workdir/lamad.happ'
                        }
                    }
                }
            }
        }

        stage('ğŸ“¦ Fetch UI') {
            when {
                anyOf {
                    branch 'main'
                    branch 'dev'
                    changeset "steward/**"
                    changeset "elohim-app/src/**"
                    changeset "VERSION"
                }
            }
            steps {
                container('builder') {
                    dir('steward') {
                        script {
                            echo """
                            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            ğŸ“± FETCHING UI
                            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            """

                            // Try to find UI from elohim-app build output
                            def uiFound = sh(script: '''
                                if [ -d ../elohim-app/dist/elohim-app/browser ]; then
                                    mkdir -p ui
                                    cp -r ../elohim-app/dist/elohim-app/browser/* ui/
                                    echo "âœ… UI copied from local elohim-app build"
                                    exit 0
                                else
                                    echo "âš ï¸  No local UI found - using placeholder"
                                    mkdir -p ui
                                    echo "<html><body><h1>Elohim Steward</h1><p>UI not bundled</p></body></html>" > ui/index.html
                                    exit 0
                                fi
                            ''', returnStatus: true)

                            sh 'echo "UI directory:"; ls -la ui/'
                        }
                    }
                }
            }
        }

        stage('Build Steward App - Linux') {
            when {
                anyOf {
                    branch 'main'
                    branch 'dev'
                    changeset "steward/**"
                    changeset "holochain/dna/**"
                    changeset "elohim-app/src/**"
                    changeset "VERSION"
                }
            }
            steps {
                container('builder') {
                    dir('steward') {
                        script {
                            echo 'Building Steward app with Nix + Tauri...'
                            echo 'First build may take 30-60 minutes. Subsequent builds use cache.'

                            sh '''#!/usr/bin/env bash
                                set -euo pipefail

                                # Fix git safe.directory for containerized builds where workspace owner differs
                                # Create explicit gitconfig file and point GIT_CONFIG_GLOBAL to it
                                export HOME="${HOME:-/root}"
                                mkdir -p "$HOME"
                                echo "[safe]" > "$HOME/.gitconfig"
                                echo "    directory = *" >> "$HOME/.gitconfig"
                                export GIT_CONFIG_GLOBAL="$HOME/.gitconfig"

                                echo "=== Git config set ==="
                                cat "$GIT_CONFIG_GLOBAL"

                                echo "=== Entering Nix development shell ==="
                                nix develop --accept-flake-config --command bash -c '
                                    set -euo pipefail

                                    echo "=== Installing npm dependencies ==="
                                    npm install

                                    echo ""
                                    echo "=== Generating app icons ==="
                                    # Use Elohim logo from elohim-app as source (no lettering, better for icons)
                                    ICON_SOURCE="../elohim-app/public/images/elohim_logo_dark.png"
                                    if [ -f "$ICON_SOURCE" ]; then
                                        # Make square by padding to largest dimension (692x573 -> 692x692)
                                        mkdir -p src-tauri/icons
                                        convert "$ICON_SOURCE" -gravity center -background transparent -extent 692x692 src-tauri/icons/icon-square.png
                                        npx tauri icon src-tauri/icons/icon-square.png
                                        echo "Icons generated from elohim_logo_dark.png (padded to square)"
                                    else
                                        echo "Warning: Source icon not found at $ICON_SOURCE"
                                        echo "Build may fail without icons"
                                    fi

                                    echo ""
                                    echo "=== Building Tauri app ==="
                                    # Required for AppImage bundling in containers without FUSE
                                    export APPIMAGE_EXTRACT_AND_RUN=1
                                    # Prevent strip failures on Nix-built binaries with .relr.dyn sections
                                    export NO_STRIP=true
                                    npm run tauri:build

                                    echo ""
                                    echo "=== Build artifacts ==="
                                    ls -lh src-tauri/target/release/bundle/appimage/ || true
                                    ls -lh src-tauri/target/release/bundle/deb/ || true
                                '
                            '''

                            // Archive artifacts
                            archiveArtifacts artifacts: 'src-tauri/target/release/bundle/**/*', allowEmptyArchive: true
                            stash name: 'steward-linux', includes: 'src-tauri/target/release/bundle/**/*.AppImage,src-tauri/target/release/bundle/**/*.deb', allowEmpty: true

                            echo 'Steward build complete!'
                        }
                    }
                }
            }
        }

        stage('Publish GitHub Release') {
            when {
                allOf {
                    branch 'main'
                    expression { return params.PUBLISH_RELEASE == true }
                }
            }
            steps {
                container('builder') {
                    dir('steward') {
                        script {
                            def version = readFile('VERSION').trim()
                            echo "Publishing release steward-v${version} to GitHub..."

                            withCredentials([string(credentialsId: 'github-release-token', variable: 'GH_TOKEN')]) {
                                sh """#!/usr/bin/env bash
                                    set -euo pipefail

                                    # Install GitHub CLI if needed
                                    which gh || nix-env -iA nixpkgs.gh

                                    # Create release and upload assets (to elohim mono-repo)
                                    gh release create steward-v${version} \\
                                        --repo ethosengine/elohim \\
                                        --title "Elohim Steward v${version}" \\
                                        --generate-notes \\
                                        src-tauri/target/release/bundle/deb/*.deb \\
                                        src-tauri/target/release/bundle/appimage/*.AppImage
                                """
                            }

                            echo "Release steward-v${version} published!"
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Steward pipeline completed successfully"
        }
        failure {
            echo "Steward pipeline failed"
            echo "If this is a first-time build, it may need more time/resources for cache population"
        }
    }
}
