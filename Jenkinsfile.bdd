// ============================================================================
// BDD PRODUCT TEST PIPELINE
// ============================================================================
// Standalone parameterized pipeline for running BDD product tests
// against any target host. Fetches Gherkin features from the running app
// (dogfooding approach) and executes them as Cypress tests.
// ============================================================================

def runBDDTests(String targetHost, String doorwayHost, String testTags) {
    echo "Running BDD tests against ${targetHost}"

    def specPattern = 'cypress/e2e/features/**/*.feature'
    def tagFilter = testTags ? "--env tags='${testTags}'" : ''

    sh """#!/bin/bash
        set -e
        export CYPRESS_baseUrl=${targetHost}
        export CYPRESS_DOORWAY_HOST=${doorwayHost}
        export CYPRESS_ENV=bdd-pipeline
        export NO_COLOR=1
        export DISPLAY=:99

        # Start Xvfb for headless browser
        Xvfb :99 -screen 0 1280x720x24 -ac > /dev/null 2>&1 &
        XVFB_PID=\$!
        sleep 2

        # Verify Cypress installation
        npx cypress verify > /dev/null
        mkdir -p cypress/reports

        # Run BDD tests
        npx cypress run \\
            --headless \\
            --browser chromium \\
            --spec "${specPattern}" \\
            ${tagFilter} \\
            || TEST_EXIT_CODE=\$?

        # Cleanup
        kill \$XVFB_PID 2>/dev/null || true

        # Exit with test result
        exit \${TEST_EXIT_CODE:-0}
    """
}

def publishBDDReports(String targetHost) {
    echo 'ğŸ“Š Publishing BDD test reports...'

    // Debug: Show report directory contents
    sh 'ls -la cypress/reports/ 2>/dev/null || echo "No reports directory"'

    if (fileExists('cypress/reports/cucumber-report.json')) {
        cucumber([
            reportTitle: "BDD Product Tests - ${targetHost}",
            fileIncludePattern: 'cucumber-report.json',
            jsonReportDirectory: 'cypress/reports',
            buildStatus: 'UNSTABLE',
            failedFeaturesNumber: 0,
            failedScenariosNumber: 0,
            failedStepsNumber: 0,
            skippedStepsNumber: -1,
            pendingStepsNumber: -1
        ])
        echo 'âœ… Cucumber reports published'
    } else {
        echo 'âš ï¸ No cucumber-report.json found'
    }

    // Archive test artifacts
    archiveArtifacts artifacts: 'cypress/screenshots/**/*.png', allowEmptyArchive: true
    archiveArtifacts artifacts: 'cypress/videos/**/*.mp4', allowEmptyArchive: true
    archiveArtifacts artifacts: 'cypress/reports/**/*', allowEmptyArchive: true
    archiveArtifacts artifacts: 'cypress/e2e/features/dynamic/**/*.feature', allowEmptyArchive: true
}

pipeline {
    agent {
        kubernetes {
            cloud 'kubernetes'
            yaml '''
apiVersion: v1
kind: Pod
spec:
  serviceAccount: jenkins-deployer
  nodeSelector:
    node-type: edge
  containers:
  - name: builder
    image: harbor.ethosengine.com/ethosengine/ci-builder:latest
    command:
    - cat
    tty: true
    resources:
      requests:
        ephemeral-storage: "2Gi"
        memory: "2Gi"
      limits:
        ephemeral-storage: "5Gi"
        memory: "4Gi"
'''
        }
    }

    parameters {
        string(
            name: 'TARGET_HOST',
            defaultValue: 'https://staging.elohim.host',
            description: 'Target host URL to test against (e.g., https://alpha.elohim.host, https://staging.elohim.host)'
        )
        string(
            name: 'DOORWAY_HOST',
            defaultValue: '',
            description: 'Doorway API host (auto-detected from TARGET_HOST if not specified)'
        )
        string(
            name: 'TEST_PATH_ID',
            defaultValue: 'bdd-smoke-tests',
            description: 'ID of the test path to fetch from the content graph'
        )
        string(
            name: 'TEST_TAGS',
            defaultValue: '',
            description: 'Cucumber tags to filter tests (e.g., @smoke, @lamad, @critical)'
        )
        booleanParam(
            name: 'FETCH_DYNAMIC_FEATURES',
            defaultValue: true,
            description: 'Fetch feature files from the running app (dogfooding mode)'
        )
        booleanParam(
            name: 'INCLUDE_STATIC_FEATURES',
            defaultValue: true,
            description: 'Include static feature files from cypress/e2e/features/'
        )
    }

    environment {
        NO_COLOR = '1'
    }

    options {
        skipDefaultCheckout(true)
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '20'))
    }

    stages {
        stage('Checkout') {
            steps {
                container('builder') {
                    script {
                        sh 'git config --global --add safe.directory "*"'

                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: "*/${env.BRANCH_NAME ?: 'dev'}"]],
                            extensions: [
                                [$class: 'CloneOption', shallow: true, noTags: true, depth: 1],
                                [$class: 'CleanBeforeCheckout']
                            ],
                            userRemoteConfigs: [[
                                url: 'https://github.com/ethosengine/elohim.git',
                                credentialsId: 'ee-bot-pat'
                            ]]
                        ])

                        echo """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§ª BDD PRODUCT TEST PIPELINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Target Host: ${params.TARGET_HOST}
Test Path: ${params.TEST_PATH_ID}
Tags: ${params.TEST_TAGS ?: '(all)'}
Fetch Dynamic: ${params.FETCH_DYNAMIC_FEATURES}
Include Static: ${params.INCLUDE_STATIC_FEATURES}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        """
                    }
                }
            }
        }

        stage('Resolve Doorway Host') {
            steps {
                container('builder') {
                    script {
                        def targetHost = params.TARGET_HOST
                        def doorwayHost = params.DOORWAY_HOST

                        if (!doorwayHost) {
                            // Auto-detect doorway host from target host
                            if (targetHost.contains('alpha.elohim.host')) {
                                doorwayHost = 'https://doorway-dev.elohim.host'
                            } else if (targetHost.contains('staging.elohim.host')) {
                                doorwayHost = 'https://doorway-staging.elohim.host'
                            } else if (targetHost.contains('elohim.host') && !targetHost.contains('doorway')) {
                                doorwayHost = 'https://doorway.elohim.host'
                            } else {
                                // For custom hosts, try doorway subdomain
                                doorwayHost = targetHost.replaceFirst('://', '://doorway.')
                            }
                        }

                        env.RESOLVED_DOORWAY_HOST = doorwayHost
                        echo "âœ… Doorway API: ${doorwayHost}"
                    }
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                container('builder') {
                    dir('elohim-app') {
                        sh '''
                            echo "Installing dependencies..."
                            npm ci --prefer-offline

                            # Verify Cypress is installed
                            npx cypress verify
                            echo "âœ… Dependencies installed"
                        '''
                    }
                }
            }
        }

        stage('Verify Target Health') {
            steps {
                container('builder') {
                    script {
                        def targetHost = params.TARGET_HOST
                        def doorwayHost = env.RESOLVED_DOORWAY_HOST

                        echo "Verifying target site: ${targetHost}"
                        sh """
                            timeout 120s bash -c 'until curl -sf -o /dev/null "${targetHost}"; do
                                echo "Waiting for target site..."
                                sleep 5
                            done'
                            echo "âœ… Target site responding: ${targetHost}"
                        """

                        echo "Verifying Doorway API: ${doorwayHost}"
                        sh """
                            timeout 60s bash -c 'until curl -sf -o /dev/null "${doorwayHost}/health"; do
                                echo "Waiting for Doorway API..."
                                sleep 5
                            done'
                            echo "âœ… Doorway API responding: ${doorwayHost}"
                        """
                    }
                }
            }
        }

        stage('Fetch Dynamic Features') {
            when {
                expression { params.FETCH_DYNAMIC_FEATURES }
            }
            steps {
                container('builder') {
                    dir('elohim-app') {
                        script {
                            def doorwayHost = env.RESOLVED_DOORWAY_HOST
                            def testPathId = params.TEST_PATH_ID
                            def testTags = params.TEST_TAGS

                            echo "Fetching features from: ${doorwayHost}"
                            echo "Test path: ${testPathId}"

                            sh """
                                node scripts/fetch-bdd-features.js \\
                                    --doorway-url "${doorwayHost}" \\
                                    --test-path-id "${testPathId}" \\
                                    --output-dir "cypress/e2e/features/dynamic" \\
                                    ${testTags ? "--tags '${testTags}'" : ''}
                            """

                            // Verify features were fetched
                            def featureCount = sh(
                                script: 'find cypress/e2e/features/dynamic -name "*.feature" 2>/dev/null | wc -l || echo "0"',
                                returnStdout: true
                            ).trim()

                            echo "ğŸ“ Fetched ${featureCount} dynamic feature files"

                            if (featureCount == '0') {
                                echo 'âš ï¸ No dynamic features fetched - continuing with static features only'
                            }
                        }
                    }
                }
            }
        }

        stage('Execute BDD Tests') {
            steps {
                container('builder') {
                    dir('elohim-app') {
                        script {
                            runBDDTests(
                                params.TARGET_HOST,
                                env.RESOLVED_DOORWAY_HOST,
                                params.TEST_TAGS
                            )
                        }
                    }
                }
            }
        }

        stage('Publish Reports') {
            steps {
                container('builder') {
                    dir('elohim-app') {
                        script {
                            publishBDDReports(params.TARGET_HOST)
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            container('builder') {
                dir('elohim-app') {
                    sh '''
                        # Cleanup dynamic features
                        rm -rf cypress/e2e/features/dynamic/*.feature 2>/dev/null || true
                        echo "Cleanup complete"
                    '''
                }
            }
        }
        success {
            echo """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… BDD TESTS PASSED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Target: ${params.TARGET_HOST}
Tests: ${params.TEST_TAGS ?: 'All'}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
        }
        failure {
            echo """
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âŒ BDD TESTS FAILED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Target: ${params.TARGET_HOST}
Tests: ${params.TEST_TAGS ?: 'All'}

Check the Cucumber report for details.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            """
        }
    }
}
