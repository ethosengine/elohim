#!/usr/bin/env sh
# Pre-push hook: Runs project-specific checks before allowing push.
# Bypass: HUSKY=0 git push  (or: git push --no-verify)
#
# Detects which projects changed and runs `just gate` in each.
# Each project's justfile defines its own quality checks:
#   elohim-app/              → build + unit tests
#   doorway/                 → cargo fmt + clippy + tests
#   doorway-app/             → eslint + build
#   sophia/                  → pnpm lint + typecheck + test
#   holochain/elohim-storage → cargo fmt + clippy + tests
#   elohim-node/             → cargo fmt + clippy + tests
#   elohim-library/          → tsc type-check + jest tests
#   genesis/                 → schema validation + tests
#   orchestrator/            → Jenkinsfile linting (any *Jenkinsfile* change)
#
# Falls back to inline commands if `just` is not installed.
# This prevents pushing broken code that wastes CI time.

# ── Load toolchains (git hooks run in minimal shell) ────────────
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" && nvm use default --silent

# Rustup (cargo fmt, clippy, tests for doorway)
[ -d "$HOME/.cargo/bin" ] && export PATH="$HOME/.cargo/bin:$PATH"

ZERO_SHA="0000000000000000000000000000000000000000"

# ── Change Detection ──────────────────────────────────────────────

CHANGED=""
while read -r LOCAL_REF LOCAL_SHA REMOTE_REF REMOTE_SHA; do
  # Skip delete pushes
  if [ "$LOCAL_SHA" = "$ZERO_SHA" ]; then
    continue
  fi

  # Determine what changed
  if [ "$REMOTE_SHA" = "$ZERO_SHA" ]; then
    # New branch - check recent commits against remote
    NEW_CHANGED=$(git diff --name-only HEAD~10 HEAD 2>/dev/null || echo "")
  else
    NEW_CHANGED=$(git diff --name-only "$REMOTE_SHA" "$LOCAL_SHA" 2>/dev/null || echo "")
  fi

  # Accumulate changed files across all refs
  if [ -n "$NEW_CHANGED" ]; then
    CHANGED=$(printf '%s\n%s' "$CHANGED" "$NEW_CHANGED")
  fi
done

# Nothing changed — let it through
if [ -z "$CHANGED" ]; then
  exit 0
fi

# ── Project Detection ─────────────────────────────────────────────

PROJECTS=""

# doorway-app must be checked BEFORE doorway (prefix overlap)
if echo "$CHANGED" | grep -q "^doorway-app/"; then
  PROJECTS="$PROJECTS doorway-app"
fi
if echo "$CHANGED" | grep "^doorway/" | grep -qv "^doorway-app/"; then
  PROJECTS="$PROJECTS doorway"
fi
if echo "$CHANGED" | grep -q "^elohim-app/"; then
  PROJECTS="$PROJECTS elohim-app"
fi
if echo "$CHANGED" | grep -q "^sophia/"; then
  PROJECTS="$PROJECTS sophia"
fi
if echo "$CHANGED" | grep -q "^holochain/elohim-storage/"; then
  PROJECTS="$PROJECTS elohim-storage"
fi
if echo "$CHANGED" | grep -q "^elohim-node/"; then
  PROJECTS="$PROJECTS elohim-node"
fi
if echo "$CHANGED" | grep -q "^elohim-library/"; then
  PROJECTS="$PROJECTS elohim-library"
fi
if echo "$CHANGED" | grep -q "^genesis/"; then
  PROJECTS="$PROJECTS genesis"
fi
# Any Jenkinsfile change triggers orchestrator lint
if echo "$CHANGED" | grep -q "Jenkinsfile"; then
  PROJECTS="$PROJECTS orchestrator"
fi

# Trim leading space
PROJECTS=$(echo "$PROJECTS" | sed 's/^ //')

# No project source changes — let it through
if [ -z "$PROJECTS" ]; then
  exit 0
fi

# ── Gate Runner ──────────────────────────────────────────────────
#
# Each project has a justfile with a `gate` recipe that defines its
# quality checks. The fallback paths below are kept for environments
# where `just` is not installed.

run_gate() {
  PROJECT_NAME="$1"
  PROJECT_DIR="$2"

  cd "$PROJECT_DIR" || return 1

  if command -v just >/dev/null 2>&1 && [ -f justfile ]; then
    echo "[$PROJECT_NAME] Running quality gate via just..."
    just gate 2>&1
    rc=$?
  else
    echo "[$PROJECT_NAME] just not found, using fallback..."
    case "$PROJECT_NAME" in
      elohim-app)
        npx ng build --configuration=development 2>&1 && \
        npx ng test --watch=false --browsers=ChromeHeadlessCI 2>&1
        rc=$?
        ;;
      doorway|elohim-node)
        cargo fmt --check 2>&1 && \
        RUSTFLAGS="" cargo clippy -- -D warnings 2>&1 && \
        RUSTFLAGS="" cargo test --lib --bins 2>&1
        rc=$?
        ;;
      doorway-app)
        npx eslint src --ext .ts,.html 2>&1 && \
        npx ng build --configuration=development 2>&1
        rc=$?
        ;;
      sophia)
        pnpm lint 2>&1 && pnpm typecheck 2>&1 && pnpm test -- --ci 2>&1
        rc=$?
        ;;
      elohim-storage)
        cargo fmt --check 2>&1 && \
        RUSTFLAGS='--cfg getrandom_backend="custom"' cargo clippy -- -D warnings 2>&1 && \
        RUSTFLAGS='--cfg getrandom_backend="custom"' cargo test 2>&1
        rc=$?
        ;;
      elohim-library)
        npx eslint projects/elohim-service/src projects/lamad-ui/src projects/html5-app-plugin/src 2>&1 && \
        (cd projects/elohim-service && npx tsc --noEmit) 2>&1 && \
        npx jest --config projects/elohim-service/jest.config.js --ci 2>&1
        rc=$?
        ;;
      genesis)
        npm run validate 2>&1 && npx vitest run 2>&1
        rc=$?
        ;;
      orchestrator)
        npx npm-groovy-lint --path '..' --files '**/*Jenkinsfile*' --ignorepattern '**/node_modules/**' --failon error 2>&1
        rc=$?
        ;;
      *)
        echo "  Unknown project: $PROJECT_NAME"
        rc=1
        ;;
    esac
  fi

  cd "$OLDPWD" || true
  return $rc
}

# ── Run Gates ─────────────────────────────────────────────────────

PROJECT_COUNT=$(echo "$PROJECTS" | wc -w | tr -d ' ')
DISPLAY_LIST=$(echo "$PROJECTS" | tr ' ' ', ')

echo ""
echo "============================================"
echo "  PRE-PUSH GATE: Changes detected"
echo "============================================"
echo "  Projects: $DISPLAY_LIST"
echo ""

TOTAL_START=$(date +%s)
FAILED=""
RESULTS=""
INDEX=0

for PROJECT in $PROJECTS; do
  INDEX=$((INDEX + 1))
  PROJECT_START=$(date +%s)

  # Map project name to directory
  case "$PROJECT" in
    elohim-storage)  PROJECT_DIR="holochain/elohim-storage" ;;
    genesis)         PROJECT_DIR="genesis/seeder" ;;
    *)               PROJECT_DIR="$PROJECT" ;;
  esac

  run_gate "$PROJECT" "$PROJECT_DIR"
  GATE_EXIT=$?

  PROJECT_END=$(date +%s)
  PROJECT_ELAPSED=$((PROJECT_END - PROJECT_START))

  if [ $GATE_EXIT -ne 0 ]; then
    echo "$PROJECT: FAILED (${PROJECT_ELAPSED}s)"
    FAILED="$FAILED $PROJECT"
  else
    echo "$PROJECT: PASSED (${PROJECT_ELAPSED}s)"
  fi
  echo ""

  RESULTS="$RESULTS  $PROJECT: $([ $GATE_EXIT -eq 0 ] && echo PASSED || echo FAILED) (${PROJECT_ELAPSED}s)\n"
done

TOTAL_END=$(date +%s)
TOTAL_ELAPSED=$((TOTAL_END - TOTAL_START))

# Trim leading space from FAILED
FAILED=$(echo "$FAILED" | sed 's/^ //')

if [ -n "$FAILED" ]; then
  echo "============================================"
  echo "  PRE-PUSH GATE: FAILED (${TOTAL_ELAPSED}s)"
  echo "============================================"
  echo "  Failed: $FAILED"
  echo ""
  echo "  Fix errors before pushing."
  echo "  Bypass: HUSKY=0 git push"
  echo "============================================"
  exit 1
fi

echo "============================================"
echo "  PRE-PUSH GATE: ALL CLEAR (${TOTAL_ELAPSED}s)"
echo "============================================"
echo ""

exit 0
