#!/usr/bin/env sh
# Pre-push hook: Runs project-specific checks before allowing push.
# Bypass: HUSKY=0 git push  (or: git push --no-verify)
#
# Detects which projects changed and runs appropriate gates:
#   elohim-app/  → build + unit tests
#   doorway/     → cargo fmt + clippy + tests
#   doorway-app/ → eslint + build
#   sophia/      → pnpm lint + typecheck + test
#
# This prevents pushing broken code that wastes CI time.

ZERO_SHA="0000000000000000000000000000000000000000"

# ── Change Detection ──────────────────────────────────────────────

CHANGED=""
while read -r LOCAL_REF LOCAL_SHA REMOTE_REF REMOTE_SHA; do
  # Skip delete pushes
  if [ "$LOCAL_SHA" = "$ZERO_SHA" ]; then
    continue
  fi

  # Determine what changed
  if [ "$REMOTE_SHA" = "$ZERO_SHA" ]; then
    # New branch - check recent commits against remote
    NEW_CHANGED=$(git diff --name-only HEAD~10 HEAD 2>/dev/null || echo "")
  else
    NEW_CHANGED=$(git diff --name-only "$REMOTE_SHA" "$LOCAL_SHA" 2>/dev/null || echo "")
  fi

  # Accumulate changed files across all refs
  if [ -n "$NEW_CHANGED" ]; then
    CHANGED=$(printf '%s\n%s' "$CHANGED" "$NEW_CHANGED")
  fi
done

# Nothing changed — let it through
if [ -z "$CHANGED" ]; then
  exit 0
fi

# ── Project Detection ─────────────────────────────────────────────

PROJECTS=""

# doorway-app must be checked BEFORE doorway (prefix overlap)
if echo "$CHANGED" | grep -q "^doorway-app/"; then
  PROJECTS="$PROJECTS doorway-app"
fi
if echo "$CHANGED" | grep "^doorway/" | grep -qv "^doorway-app/"; then
  PROJECTS="$PROJECTS doorway"
fi
if echo "$CHANGED" | grep -q "^elohim-app/"; then
  PROJECTS="$PROJECTS elohim-app"
fi
if echo "$CHANGED" | grep -q "^sophia/"; then
  PROJECTS="$PROJECTS sophia"
fi

# Trim leading space
PROJECTS=$(echo "$PROJECTS" | sed 's/^ //')

# No project source changes — let it through
if [ -z "$PROJECTS" ]; then
  exit 0
fi

# ── Gate Functions ────────────────────────────────────────────────

gate_elohim_app() {
  echo "[elohim-app 1/2] Building..."
  cd elohim-app || return 1
  npx ng build --configuration=development 2>&1
  rc=$?
  cd ..
  if [ $rc -ne 0 ]; then return 1; fi

  echo "[elohim-app 2/2] Running unit tests..."
  cd elohim-app || return 1
  npx ng test --watch=false --browsers=ChromeHeadlessCI 2>&1
  rc=$?
  cd ..
  return $rc
}

gate_doorway() {
  echo "[doorway 1/3] Checking formatting..."
  cd doorway || return 1
  cargo fmt --check 2>&1
  rc=$?
  cd ..
  if [ $rc -ne 0 ]; then return 1; fi

  echo "[doorway 2/3] Running clippy..."
  cd doorway || return 1
  RUSTFLAGS="" cargo clippy -- -D warnings 2>&1
  rc=$?
  cd ..
  if [ $rc -ne 0 ]; then return 1; fi

  echo "[doorway 3/3] Running tests..."
  cd doorway || return 1
  RUSTFLAGS="" cargo test --lib --bins 2>&1
  rc=$?
  cd ..
  return $rc
}

gate_doorway_app() {
  echo "[doorway-app 1/2] Running ESLint..."
  cd doorway-app || return 1
  npx eslint src --ext .ts,.html 2>&1
  rc=$?
  cd ..
  if [ $rc -ne 0 ]; then return 1; fi

  echo "[doorway-app 2/2] Building..."
  cd doorway-app || return 1
  npx ng build --configuration=development 2>&1
  rc=$?
  cd ..
  return $rc
}

gate_sophia() {
  echo "[sophia 1/3] Running lint..."
  cd sophia || return 1
  pnpm lint 2>&1
  rc=$?
  cd ..
  if [ $rc -ne 0 ]; then return 1; fi

  echo "[sophia 2/3] Running typecheck..."
  cd sophia || return 1
  pnpm typecheck 2>&1
  rc=$?
  cd ..
  if [ $rc -ne 0 ]; then return 1; fi

  echo "[sophia 3/3] Running tests..."
  cd sophia || return 1
  pnpm test -- --ci 2>&1
  rc=$?
  cd ..
  return $rc
}

# ── Run Gates ─────────────────────────────────────────────────────

PROJECT_COUNT=$(echo "$PROJECTS" | wc -w | tr -d ' ')
DISPLAY_LIST=$(echo "$PROJECTS" | tr ' ' ', ')

echo ""
echo "============================================"
echo "  PRE-PUSH GATE: Changes detected"
echo "============================================"
echo "  Projects: $DISPLAY_LIST"
echo ""

TOTAL_START=$(date +%s)
FAILED=""
RESULTS=""
INDEX=0

for PROJECT in $PROJECTS; do
  INDEX=$((INDEX + 1))
  PROJECT_START=$(date +%s)

  case "$PROJECT" in
    elohim-app)  gate_elohim_app  ;;
    doorway)     gate_doorway     ;;
    doorway-app) gate_doorway_app ;;
    sophia)      gate_sophia      ;;
  esac
  GATE_EXIT=$?

  PROJECT_END=$(date +%s)
  PROJECT_ELAPSED=$((PROJECT_END - PROJECT_START))

  if [ $GATE_EXIT -ne 0 ]; then
    echo "$PROJECT: FAILED (${PROJECT_ELAPSED}s)"
    FAILED="$FAILED $PROJECT"
  else
    echo "$PROJECT: PASSED (${PROJECT_ELAPSED}s)"
  fi
  echo ""

  RESULTS="$RESULTS  $PROJECT: $([ $GATE_EXIT -eq 0 ] && echo PASSED || echo FAILED) (${PROJECT_ELAPSED}s)\n"
done

TOTAL_END=$(date +%s)
TOTAL_ELAPSED=$((TOTAL_END - TOTAL_START))

# Trim leading space from FAILED
FAILED=$(echo "$FAILED" | sed 's/^ //')

if [ -n "$FAILED" ]; then
  echo "============================================"
  echo "  PRE-PUSH GATE: FAILED (${TOTAL_ELAPSED}s)"
  echo "============================================"
  echo "  Failed: $FAILED"
  echo ""
  echo "  Fix errors before pushing."
  echo "  Bypass: HUSKY=0 git push"
  echo "============================================"
  exit 1
fi

echo "============================================"
echo "  PRE-PUSH GATE: ALL CLEAR (${TOTAL_ELAPSED}s)"
echo "============================================"
echo ""

exit 0
