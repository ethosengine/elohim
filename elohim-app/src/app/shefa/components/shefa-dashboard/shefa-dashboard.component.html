<!-- Shefa Dashboard: Operator visibility into compute, data protection, and economics -->

<div class="shefa-dashboard" [class]="'display-' + mergedConfig.displayMode">
  <!-- Loading State -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner">
      <div class="spinner-ring"></div>
      <p>Initializing dashboard...</p>
    </div>
  </div>

  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="header-title">
        <h1>Shefa Dashboard</h1>
        <p class="subtitle">Your node, your digital presence, your community</p>
      </div>

      <!-- Status Badge -->
      <div class="status-badge" [ngClass]="getStatusClass()">
        <span class="status-dot"></span>
        <span class="status-text">{{ getStatusText() }}</span>
      </div>

      <!-- Location & Uptime -->
      <div class="header-stats">
        <div class="stat">
          <span class="label">Location</span>
          <span class="value">{{ getNodeLocation() }}</span>
        </div>
        <div class="stat">
          <span class="label">Uptime</span>
          <span class="value">{{ getUptimePercent() | number: '1.1-1' }}%</span>
          <span class="reliability">{{ getReliabilityLabel() }}</span>
        </div>
        <div class="stat">
          <span class="label">Last Update</span>
          <span class="value">{{ getTimeSinceUpdate() }}</span>
        </div>
      </div>

      <!-- Header Actions -->
      <div class="header-actions">
        <button class="btn-icon" (click)="toggleConfigPanel()" title="Settings">
          ‚öôÔ∏è
        </button>
        <button class="btn-icon" [matMenuTriggerFor]="exportMenu" title="Export">
          üì•
        </button>
      </div>
    </div>

    <!-- Config Panel (Collapsible) -->
    <div class="config-panel" *ngIf="showConfigPanel">
      <h3>Dashboard Configuration</h3>

      <div class="config-group">
        <label>Display Mode</label>
        <div class="button-group">
          <button
            *ngFor="let mode of ['compact', 'detailed', 'monitoring']"
            [class.active]="mergedConfig.displayMode === mode"
            (click)="setDisplayMode(mode as any)"
            class="btn-small"
          >
            {{ mode | titlecase }}
          </button>
        </div>
      </div>

      <div class="config-group">
        <label>Visible Panels</label>
        <div class="checkbox-group">
          <label>
            <input
              type="checkbox"
              [checked]="mergedConfig.visiblePanels.computeMetrics"
              (change)="togglePanelVisibility('computeMetrics')"
            />
            Compute Metrics
          </label>
          <label>
            <input
              type="checkbox"
              [checked]="mergedConfig.visiblePanels.familyProtection"
              (change)="togglePanelVisibility('familyProtection')"
            />
            Family Protection
          </label>
          <label>
            <input
              type="checkbox"
              [checked]="mergedConfig.visiblePanels.tokenEarnings"
              (change)="togglePanelVisibility('tokenEarnings')"
            />
            Token Earnings
          </label>
          <label>
            <input
              type="checkbox"
              [checked]="mergedConfig.visiblePanels.economicEvents"
              (change)="togglePanelVisibility('economicEvents')"
            />
            Economic Events
          </label>
          <label>
            <input
              type="checkbox"
              [checked]="mergedConfig.visiblePanels.constitutionalLimits"
              (change)="togglePanelVisibility('constitutionalLimits')"
            />
            Constitutional Limits
          </label>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="dashboard-content" *ngIf="!isLoading && dashboardState$ | async as state">
    <!-- Alert Banner -->
    <div class="alerts-banner" *ngIf="getCriticalAlerts().length > 0">
      <div class="alert-item critical" *ngFor="let alert of getCriticalAlerts()">
        <span class="icon">‚ö†Ô∏è</span>
        <span class="message">{{ alert.message }}</span>
        <span class="action">{{ alert.recommendedAction }}</span>
      </div>
    </div>

    <!-- Panel Navigation (if detailed mode) -->
    <nav class="panel-nav" *ngIf="mergedConfig.displayMode === 'detailed'">
      <button
        *ngIf="isComputeMetricsVisible()"
        class="nav-btn"
        [class.active]="selectedPanel === 'compute'"
        (click)="selectPanel('compute')"
      >
        üíª Compute
      </button>
      <button
        *ngIf="isFamilyProtectionVisible()"
        class="nav-btn"
        [class.active]="selectedPanel === 'protection'"
        (click)="selectPanel('protection')"
      >
        üõ°Ô∏è Protection
      </button>
      <button
        *ngIf="isTokenEarningsVisible()"
        class="nav-btn"
        [class.active]="selectedPanel === 'tokens'"
        (click)="selectPanel('tokens')"
      >
        üí∞ Tokens
      </button>
      <button
        *ngIf="isEconomicEventsVisible()"
        class="nav-btn"
        [class.active]="selectedPanel === 'events'"
        (click)="selectPanel('events')"
      >
        üìä Events
      </button>
      <button
        *ngIf="isConstitutionalLimitsVisible()"
        class="nav-btn"
        [class.active]="selectedPanel === 'limits'"
        (click)="selectPanel('limits')"
      >
        ‚öñÔ∏è Limits
      </button>
    </nav>

    <!-- Panels Grid / Detailed View -->
    <div class="panels-container" [class]="'mode-' + mergedConfig.displayMode">
      <!-- Compute Metrics Panel -->
      <div class="panel compute-panel" *ngIf="isComputeMetricsVisible() && (selectedPanel === 'compute' || mergedConfig.displayMode !== 'detailed')">
        <div class="panel-header">
          <h2>üíª Compute Metrics</h2>
          <span class="panel-subtitle">Real-time node performance</span>
        </div>

        <div class="panel-content">
          <!-- CPU Metric -->
          <div class="metric">
            <div class="metric-label">CPU Usage</div>
            <div class="metric-bar">
              <div class="bar-background">
                <div class="bar-fill" [style.width.%]="getCpuUsage()"></div>
              </div>
              <span class="metric-value">{{ getCpuUsage() | number: '1.1-1' }}%</span>
            </div>
            <div class="metric-detail">
              {{ state.computeMetrics.cpu.available | number: '1.1-1' }} / {{ state.computeMetrics.cpu.totalCores | number: '1.1-1' }} cores
              <span *ngIf="state.computeMetrics.cpu.temperature">
                | {{ state.computeMetrics.cpu.temperature }}¬∞C
              </span>
            </div>
          </div>

          <!-- Memory Metric -->
          <div class="metric">
            <div class="metric-label">Memory Usage</div>
            <div class="metric-bar">
              <div class="bar-background">
                <div class="bar-fill" [style.width.%]="getMemoryUsage()"></div>
              </div>
              <span class="metric-value">{{ getMemoryUsage() | number: '1.1-1' }}%</span>
            </div>
            <div class="metric-detail">
              {{ state.computeMetrics.memory.usedGB | number: '1.1-1' }} / {{ state.computeMetrics.memory.totalGB | number: '1.1-1' }} GB
            </div>
          </div>

          <!-- Storage Metric -->
          <div class="metric">
            <div class="metric-label">Storage Usage</div>
            <div class="metric-bar">
              <div class="bar-background">
                <div class="bar-fill" [style.width.%]="getStorageUsage()"></div>
              </div>
              <span class="metric-value">{{ getStorageUsage() | number: '1.1-1' }}%</span>
            </div>
            <div class="metric-detail">
              {{ state.computeMetrics.storage.usedGB | number: '1.1-1' }} / {{ state.computeMetrics.storage.totalGB | number: '1.1-1' }} GB
              <div class="storage-breakdown">
                <span>Holochain: {{ state.computeMetrics.storage.breakdown.holochain }}GB</span>
                <span>Cache: {{ state.computeMetrics.storage.breakdown.cache }}GB</span>
                <span>Custodian Data: {{ state.computeMetrics.storage.breakdown.custodianData }}GB</span>
                <span>User Apps: {{ state.computeMetrics.storage.breakdown.userApplications }}GB</span>
              </div>
            </div>
          </div>

          <!-- Network Metric -->
          <div class="metric">
            <div class="metric-label">Network</div>
            <div class="network-stats">
              <div class="network-stat">
                <span class="label">Bandwidth</span>
                <span class="value">{{ state.computeMetrics.network.bandwidth.usedUpstreamMbps | number: '1.1-1' }} / {{ state.computeMetrics.network.bandwidth.upstreamMbps | number: '1.1-1' }} Mbps up</span>
              </div>
              <div class="network-stat">
                <span class="label">Latency</span>
                <span class="value">
                  p50: {{ state.computeMetrics.network.latency.p50 }}ms | p95: {{ state.computeMetrics.network.latency.p95 }}ms | p99: {{ state.computeMetrics.network.latency.p99 }}ms
                </span>
              </div>
              <div class="network-stat">
                <span class="label">Connections</span>
                <span class="value">
                  {{ state.computeMetrics.network.connections.total }} total ({{ state.computeMetrics.network.connections.holochain }} DHT, {{ state.computeMetrics.network.connections.cache }} cache, {{ state.computeMetrics.network.connections.custodian }} custodian)
                </span>
              </div>
            </div>
          </div>

          <!-- Load Average -->
          <div class="metric">
            <div class="metric-label">System Load</div>
            <div class="load-average">
              <span>1m: {{ state.computeMetrics.loadAverage.oneMinute | number: '1.2-2' }}</span>
              <span>5m: {{ state.computeMetrics.loadAverage.fiveMinutes | number: '1.2-2' }}</span>
              <span>15m: {{ state.computeMetrics.loadAverage.fifteenMinutes | number: '1.2-2' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Family-Community Protection Panel -->
      <div class="panel protection-panel" *ngIf="isFamilyProtectionVisible() && (selectedPanel === 'protection' || mergedConfig.displayMode !== 'detailed')">
        <div class="panel-header">
          <h2>üõ°Ô∏è Data Protection</h2>
          <span class="panel-subtitle">Who's protecting your data?</span>
        </div>

        <div class="panel-content">
          <!-- Protection Status -->
          <div class="protection-status" [ngClass]="getProtectionLevelClass()">
            <div class="status-main">
              <span class="protection-level">{{ state.familyCommunityProtection.protectionLevel | titlecase }}</span>
              <span class="custodian-count">{{ getTotalCustodians() }} custodian(s)</span>
            </div>
            <div class="recovery-info">
              <span class="label">Recovery Time:</span>
              <span class="value">{{ state.familyCommunityProtection.estimatedRecoveryTime }}</span>
            </div>
          </div>

          <!-- Redundancy Info -->
          <div class="redundancy-info">
            <h4>Redundancy Strategy</h4>
            <div class="strategy-details">
              <span class="strategy-type">{{ state.familyCommunityProtection.redundancy.strategy | titlecase }}</span>
              <span class="factor">
                Redundancy Factor: {{ state.familyCommunityProtection.redundancy.redundancyFactor }}-of-{{ getTotalCustodians() }}
              </span>
              <span class="threshold">
                Recovery Threshold: {{ state.familyCommunityProtection.redundancy.recoveryThreshold }} shard(s)
              </span>
            </div>
          </div>

          <!-- Geographic Distribution -->
          <div class="geographic-distribution">
            <h4>Geographic Distribution</h4>
            <div class="regions-list">
              <div class="region-item" *ngFor="let region of state.familyCommunityProtection.geographicDistribution">
                <span class="region-name">{{ region.region }}, {{ region.country || 'Unknown' }}</span>
                <span class="region-stats">
                  {{ region.custodianCount }} custodian(s) | {{ region.dataShards }} shards | Redundancy: {{ region.redundancy }}
                </span>
                <div class="risk-factors" *ngIf="region.riskFactors.length > 0">
                  <span class="risk-badge" *ngFor="let risk of region.riskFactors">{{ risk }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Custodian List -->
          <div class="custodian-list">
            <h4>Data Custodians</h4>
            <div class="custodians">
              <div class="custodian-card" *ngFor="let custodian of state.familyCommunityProtection.custodians">
                <div class="custodian-header">
                  <span class="name">{{ custodian.name }}</span>
                  <span class="type-badge" [ngClass]="'type-' + custodian.type">{{ custodian.type }}</span>
                </div>
                <div class="custodian-info">
                  <span class="location" *ngIf="custodian.location">
                    üìç {{ custodian.location.region }}, {{ custodian.location.country }}
                  </span>
                  <span class="storage">üì¶ {{ custodian.dataStored.totalGB }} GB ({{ custodian.dataStored.shardCount }} shards)</span>
                  <span class="trust-level">
                    ‚≠ê Trust: {{ custodian.trustLevel }}/100
                  </span>
                </div>
                <div class="custodian-health">
                  <div class="health-bar">
                    <div class="health-fill" [style.width.%]="custodian.health.upPercent"></div>
                  </div>
                  <span class="health-text">{{ custodian.health.upPercent | number: '1.1-1' }}% uptime</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Infrastructure Token Earnings Panel -->
      <div class="panel tokens-panel" *ngIf="isTokenEarningsVisible() && (selectedPanel === 'tokens' || mergedConfig.displayMode !== 'detailed')">
        <div class="panel-header">
          <h2>üí∞ Infrastructure Tokens</h2>
          <span class="panel-subtitle">How much compute are you earning?</span>
        </div>

        <div class="panel-content">
          <!-- Token Balance -->
          <div class="token-balance">
            <div class="balance-main">
              <span class="amount">{{ getTokenBalance() | number: '1.2-2' }}</span>
              <span class="unit">tokens</span>
            </div>
            <div class="balance-secondary">
              <span class="value">‚âà ${{ state.infrastructureTokens.balance.estimatedValue.value | number: '1.2-2' }} {{ state.infrastructureTokens.balance.estimatedValue.currency }}</span>
            </div>
          </div>

          <!-- Earning Rate -->
          <div class="earning-rate">
            <h4>Earning Rate</h4>
            <div class="rate-details">
              <div class="rate-main">
                {{ getTokenEarningRate() | number: '1.4-4' }} tokens/hour
              </div>
              <div class="rate-breakdown">
                <span>Based on:</span>
                <span class="breakdown-item">
                  {{ state.infrastructureTokens.earningRate.basedOn.cpuAllocation }}% CPU allocation
                </span>
                <span class="breakdown-item">
                  {{ state.infrastructureTokens.earningRate.basedOn.storageAllocation }}% Storage allocation
                </span>
                <span class="breakdown-item">
                  {{ state.infrastructureTokens.earningRate.basedOn.bandwidthAllocation }}% Bandwidth allocation
                </span>
              </div>
              <div class="estimated-monthly">
                <span class="label">Estimated Monthly:</span>
                <span class="value">{{ getEstimatedMonthlyEarnings() | number: '1.0-0' }} tokens</span>
              </div>
            </div>
          </div>

          <!-- Token Decay (Demurrage) -->
          <div class="token-decay">
            <h4>Token Circulation (Demurrage)</h4>
            <div class="decay-info">
              <span class="decay-rate">
                {{ state.infrastructureTokens.decay.demurrageRate }}% monthly decay
              </span>
              <span class="decay-reason">
                (Encourages circulation and prevents hoarding)
              </span>
              <div class="projected-decay">
                <span class="label">Projected balance next month:</span>
                <span class="value">{{ state.infrastructureTokens.decay.projectedNextMonth.tokens | number: '1.2-2' }} tokens</span>
              </div>
            </div>
          </div>

          <!-- Exchange Rates -->
          <div class="exchange-rates">
            <h4>Cross-Swimlane Exchange Rates</h4>
            <div class="rates-list">
              <div class="rate-item" *ngFor="let rate of state.infrastructureTokens.exchangeRates">
                <span class="from">{{ rate.from }}</span>
                <span class="arrow">‚Üí</span>
                <span class="to">{{ rate.to }}</span>
                <span class="rate-value">1 : {{ rate.rate | number: '1.2-2' }}</span>
                <span class="source">({{ rate.source }})</span>
              </div>
            </div>
          </div>

          <!-- Token History -->
          <div class="token-history">
            <h4>Token History</h4>
            <div class="history-list">
              <span class="history-item">Last 24h: {{ state.infrastructureTokens.tokenHistory.last24Hours | number: '1.2-2' }}</span>
              <span class="history-item">Last 7d: {{ state.infrastructureTokens.tokenHistory.last7Days | number: '1.2-2' }}</span>
              <span class="history-item">Last 30d: {{ state.infrastructureTokens.tokenHistory.last30Days | number: '1.2-2' }}</span>
              <span class="history-item">All Time: {{ state.infrastructureTokens.tokenHistory.allTime | number: '1.2-2' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Economic Events Panel -->
      <div class="panel events-panel" *ngIf="isEconomicEventsVisible() && (selectedPanel === 'events' || mergedConfig.displayMode !== 'detailed')">
        <div class="panel-header">
          <h2>üìä Recent Economic Events</h2>
          <span class="panel-subtitle">Compute flows and transactions</span>
        </div>

        <div class="panel-content">
          <div class="events-list">
            <div class="event-item" *ngFor="let event of state.economicEvents; let i = index">
              <div class="event-time">{{ event.timestamp | date: 'short' }}</div>
              <div class="event-type" [ngClass]="'event-' + event.eventType">
                {{ event.eventType | titlecase }}
              </div>
              <div class="event-quantity">
                {{ event.quantity.value | number: '1.2-2' }} {{ event.quantity.unit }}
              </div>
              <div class="event-note">{{ event.note }}</div>
              <div class="event-tokens" *ngIf="event.tokensMinted">
                <span class="tokens-minted">+{{ event.tokensMinted | number: '1.2-2' }} tokens</span>
              </div>
            </div>
          </div>
          <div class="no-events" *ngIf="state.economicEvents.length === 0">
            <p>No recent economic events</p>
          </div>
        </div>
      </div>

      <!-- Constitutional Limits Panel -->
      <div class="panel limits-panel" *ngIf="isConstitutionalLimitsVisible() && (selectedPanel === 'limits' || mergedConfig.displayMode !== 'detailed')">
        <div class="panel-header">
          <h2>‚öñÔ∏è Constitutional Limits</h2>
          <span class="panel-subtitle">Dignity floor & ceiling enforcement</span>
        </div>

        <div class="panel-content">
          <!-- Dignity Floor -->
          <div class="limits-section dignity-floor">
            <h4>Dignity Floor (Minimum Entitlements)</h4>
            <div class="limit-status" [ngClass]="'status-' + state.constitutionalLimits.dignityFloor.status">
              <span class="status-label">{{ state.constitutionalLimits.dignityFloor.status | titlecase }}</span>
              <span class="status-percent">{{ state.constitutionalLimits.dignityFloor.percentOfFloor | number: '1.1-1' }}%</span>
            </div>
            <div class="floor-details">
              <div class="floor-item">
                <span class="label">CPU:</span>
                <span class="value">{{ state.constitutionalLimits.dignityFloor.computeMinCores }} core(s)</span>
              </div>
              <div class="floor-item">
                <span class="label">Memory:</span>
                <span class="value">{{ state.constitutionalLimits.dignityFloor.computeMinMemoryGB }} GB</span>
              </div>
              <div class="floor-item">
                <span class="label">Storage:</span>
                <span class="value">{{ state.constitutionalLimits.dignityFloor.computeMinStorageGB }} GB</span>
              </div>
              <div class="floor-item">
                <span class="label">Bandwidth:</span>
                <span class="value">{{ state.constitutionalLimits.dignityFloor.computeMinBandwidthMbps }} Mbps</span>
              </div>
            </div>
          </div>

          <!-- Ceiling Limit -->
          <div class="limits-section ceiling-limit">
            <h4>Ceiling Limit (Wise Stewardship Bound)</h4>
            <div class="limit-status" [ngClass]="'status-' + state.constitutionalLimits.ceilingLimit.status">
              <span class="status-label">{{ state.constitutionalLimits.ceilingLimit.status | titlecase }}</span>
              <span class="status-percent">{{ state.constitutionalLimits.ceilingLimit.percentOfCeiling | number: '1.1-1' }}%</span>
            </div>
            <div class="ceiling-details">
              <div class="ceiling-item">
                <span class="label">Max CPU:</span>
                <span class="value">{{ state.constitutionalLimits.ceilingLimit.computeMaxCores }} core(s)</span>
              </div>
              <div class="ceiling-item">
                <span class="label">Max Memory:</span>
                <span class="value">{{ state.constitutionalLimits.ceilingLimit.computeMaxMemoryGB }} GB</span>
              </div>
              <div class="ceiling-item">
                <span class="label">Max Storage:</span>
                <span class="value">{{ state.constitutionalLimits.ceilingLimit.computeMaxStorageGB }} GB</span>
              </div>
              <div class="ceiling-item">
                <span class="label">Token Ceiling:</span>
                <span class="value">{{ state.constitutionalLimits.ceilingLimit.tokenAccumulationCeiling | number: '1.0-0' }} tokens</span>
              </div>
            </div>
          </div>

          <!-- Safe Zone -->
          <div class="safe-zone">
            <h4>Safe Operating Zone (Floor to Ceiling)</h4>
            <div class="zone-bars">
              <div class="zone-bar">
                <span class="label">CPU</span>
                <div class="zone-visual">
                  <div class="zone-fill" [style.width.%]="state.constitutionalLimits.safeZone.cpu"></div>
                </div>
                <span class="value">{{ state.constitutionalLimits.safeZone.cpu | number: '1.1-1' }}%</span>
              </div>
              <div class="zone-bar">
                <span class="label">Memory</span>
                <div class="zone-visual">
                  <div class="zone-fill" [style.width.%]="state.constitutionalLimits.safeZone.memory"></div>
                </div>
                <span class="value">{{ state.constitutionalLimits.safeZone.memory | number: '1.1-1' }}%</span>
              </div>
              <div class="zone-bar">
                <span class="label">Storage</span>
                <div class="zone-visual">
                  <div class="zone-fill" [style.width.%]="state.constitutionalLimits.safeZone.storage"></div>
                </div>
                <span class="value">{{ state.constitutionalLimits.safeZone.storage | number: '1.1-1' }}%</span>
              </div>
              <div class="zone-bar">
                <span class="label">Bandwidth</span>
                <div class="zone-visual">
                  <div class="zone-fill" [style.width.%]="state.constitutionalLimits.safeZone.bandwidth"></div>
                </div>
                <span class="value">{{ state.constitutionalLimits.safeZone.bandwidth | number: '1.1-1' }}%</span>
              </div>
            </div>
          </div>

          <!-- Alerts -->
          <div class="limit-alerts" *ngIf="state.constitutionalLimits.alerts.length > 0">
            <h4>Alerts</h4>
            <div class="alerts-list">
              <div class="alert-card" *ngFor="let alert of state.constitutionalLimits.alerts" [ngClass]="'severity-' + alert.severity">
                <div class="alert-title">{{ alert.type | titlecase }}</div>
                <div class="alert-message">{{ alert.message }}</div>
                <div class="alert-action">{{ alert.recommendedAction }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Export Menu -->
  <mat-menu #exportMenu="matMenu">
    <button mat-menu-item (click)="exportDashboard('json')">üìÑ Export as JSON</button>
    <button mat-menu-item (click)="exportDashboard('csv')">üìä Export as CSV</button>
  </mat-menu>
</div>
