<div class="doorway-picker">
  <!-- Header -->
  <div class="picker-header">
    <h2 class="picker-title">{{ titleText() }}</h2>
    <p class="picker-subtitle">{{ subtitleText() }}</p>
  </div>

  <!-- Filters -->
  <div class="picker-filters">
    <!-- Search -->
    <div class="search-wrapper">
      <span class="material-icons search-icon">search</span>
      <input
        type="text"
        class="search-input"
        placeholder="Search doorways..."
        [ngModel]="searchQuery()"
        (ngModelChange)="searchQuery.set($event)"
      />
      @if (searchQuery()) {
        <button
          class="search-clear"
          type="button"
          (click)="searchQuery.set('')"
          aria-label="Clear search"
        >
          <span class="material-icons">close</span>
        </button>
      }
    </div>

    <!-- Region Filter -->
    <div class="region-filter">
      <label class="filter-label">Region:</label>
      <select
        class="region-select"
        [ngModel]="selectedRegion()"
        (ngModelChange)="selectedRegion.set($event)"
      >
        <option value="all">All Regions</option>
        @for (region of availableRegions(); track region) {
          <option [value]="region">{{ getRegionDisplayName(region) }}</option>
        }
      </select>
    </div>

    <!-- Custom Doorway Toggle -->
    <button
      type="button"
      class="custom-toggle"
      (click)="toggleCustomInput()"
      [class.active]="showCustomInput()"
    >
      <span class="material-icons">{{ showCustomInput() ? 'list' : 'add_link' }}</span>
      {{ showCustomInput() ? 'Show List' : 'Custom URL' }}
    </button>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Discovering doorways...</p>
    </div>
  }

  <!-- Error State -->
  @if (error() && !isLoading()) {
    <div class="error-state" role="alert">
      <span class="material-icons">error_outline</span>
      <p>{{ error() }}</p>
      <button type="button" class="retry-btn" (click)="loadDoorways()">
        <span class="material-icons">refresh</span>
        Retry
      </button>
    </div>
  }

  <!-- Custom URL Input -->
  @if (showCustomInput()) {
    <div class="custom-doorway">
      <div class="custom-input-wrapper">
        <label for="custom-url" class="custom-label">
          Enter a doorway URL
        </label>
        <input
          id="custom-url"
          type="url"
          class="custom-input"
          placeholder="https://doorway.example.com"
          [ngModel]="customUrl()"
          (ngModelChange)="customUrl.set($event)"
          [disabled]="customValidating()"
        />
        <button
          type="button"
          class="validate-btn"
          (click)="validateAndSelectCustom()"
          [disabled]="customValidating() || !customUrl()"
        >
          @if (customValidating()) {
            <div class="btn-spinner"></div>
          } @else {
            <span class="material-icons">check</span>
          }
          {{ customValidating() ? 'Validating...' : 'Connect' }}
        </button>
      </div>
      @if (customError()) {
        <p class="custom-error">{{ customError() }}</p>
      }
    </div>
  }

  <!-- Doorways Grid -->
  @if (!showCustomInput() && !isLoading()) {
    <div class="doorways-grid">
      @for (doorway of filteredDoorways(); track trackByDoorway($index, doorway)) {
        <button
          type="button"
          class="doorway-card"
          [class.selected]="selectedId() === doorway.id"
          [class.offline]="doorway.status === 'offline'"
          [class.degraded]="doorway.status === 'degraded'"
          [disabled]="doorway.status === 'offline' || !doorway.registrationOpen"
          (click)="selectDoorway(doorway)"
        >
          <!-- Status Badge -->
          <div class="status-badge" [style.backgroundColor]="getStatusDisplay(doorway.status).color">
            <span class="material-icons status-icon">{{ getStatusDisplay(doorway.status).icon }}</span>
          </div>

          <!-- Doorway Info -->
          <div class="doorway-info">
            <h3 class="doorway-name">{{ doorway.name }}</h3>
            <p class="doorway-operator">by {{ doorway.operator }}</p>
            <p class="doorway-description">{{ doorway.description }}</p>
          </div>

          <!-- Meta Info -->
          <div class="doorway-meta">
            <span class="meta-item region">
              <span class="material-icons">public</span>
              {{ getRegionDisplayName(doorway.region) }}
            </span>
            <span class="meta-item latency" [ngClass]="getLatencyClass(doorway.latencyMs)">
              <span class="material-icons">speed</span>
              {{ formatLatency(doorway.latencyMs) }}
            </span>
            @if (doorway.userCount) {
              <span class="meta-item users">
                <span class="material-icons">people</span>
                {{ doorway.userCount | number }}
              </span>
            }
          </div>

          <!-- Features -->
          @if (doorway.features.length > 0) {
            <div class="doorway-features">
              @for (feature of doorway.features.slice(0, 3); track feature) {
                <span class="feature-tag" [title]="getFeatureDisplay(feature).label">
                  <span class="material-icons">{{ getFeatureDisplay(feature).icon }}</span>
                </span>
              }
              @if (doorway.features.length > 3) {
                <span class="feature-more">+{{ doorway.features.length - 3 }}</span>
              }
            </div>
          }

          <!-- Registration Status -->
          @if (!doorway.registrationOpen) {
            <div class="registration-closed">
              <span class="material-icons">lock</span>
              Registration Closed
            </div>
          }

          <!-- Selected Indicator -->
          @if (selectedId() === doorway.id) {
            <div class="selected-indicator">
              <span class="material-icons">check_circle</span>
              Selected
            </div>
          }
        </button>
      } @empty {
        <div class="empty-state">
          <span class="material-icons">dns</span>
          <p>No doorways match your search</p>
          <button type="button" class="clear-filters" (click)="searchQuery.set(''); selectedRegion.set('all')">
            Clear filters
          </button>
        </div>
      }
    </div>
  }

  <!-- Footer Actions -->
  <div class="picker-footer">
    <button type="button" class="cancel-btn" (click)="cancel()">
      Cancel
    </button>
    <p class="footer-hint">
      <span class="material-icons">info</span>
      You can change your doorway later in settings
    </p>
  </div>
</div>
