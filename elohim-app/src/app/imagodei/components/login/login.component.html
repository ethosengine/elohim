<div class="login-container">
  <!-- Step 1: Doorway Selection -->
  @if (currentStep() === 'doorway') {
    @if (isLauncher()) {
      <div class="launcher-header">
        <h1>Connect to a Doorway</h1>
        <p>Enter a doorway URL or discover nearby doorways to get started.</p>
      </div>
    }
    <app-doorway-picker
      [mode]="'login'"
      (doorwaySelected)="onDoorwaySelected($event)"
      (cancelled)="onDoorwayPickerCancelled()"
    />
  }

  <!-- Federated Identifier Input (dev browser, first-time) -->
  @if (currentStep() === 'federated') {
    <div class="federated-login">
      <div class="login-header">
        <h1>Sign In</h1>
        <p class="subtitle">Enter your Elohim identity to sign in via your doorway</p>
      </div>

      @if (error()) {
        <div class="error-banner" role="alert">
          <span class="error-icon" aria-hidden="true">&#x2715;</span>
          <span>{{ error() }}</span>
          <button
            type="button"
            class="error-dismiss"
            aria-label="Dismiss error"
            (click)="clearError()"
          >
            Dismiss
          </button>
        </div>
      }

      <form class="login-form" (ngSubmit)="onFederatedLogin()">
        <div class="form-group">
          <label for="federatedId">Your identity</label>
          <input
            id="federatedId"
            type="text"
            [(ngModel)]="federatedIdentifier"
            name="federatedId"
            placeholder="you@your-doorway.host"
            autocomplete="username"
            [disabled]="isLoading()"
          />
        </div>
        <div class="form-actions">
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="isLoading() || !federatedIdentifier.trim()"
          >
            @if (isLoading()) {
              <span class="spinner"></span>
              Connecting...
            } @else {
              Continue
            }
          </button>
        </div>
      </form>

      <div class="login-footer">
        <p class="register-prompt">
          Don't have an account?
          <a
            routerLink="/identity/register"
            [queryParams]="{ returnUrl: returnUrl }"
            class="register-link"
          >
            Create one
          </a>
        </p>
        <button type="button" class="link-button" (click)="showDoorwayBrowser()">
          Browse doorways
        </button>
      </div>
    </div>
  }

  <!-- Unlock (returning Tauri user) -->
  @if (currentStep() === 'unlock') {
    <div class="login-card">
      <div class="login-header">
        <h1>Welcome Back</h1>
        <p class="subtitle">Enter your password to unlock</p>
      </div>

      @if (error()) {
        <div class="error-banner" role="alert">
          <span class="error-icon" aria-hidden="true">&#x2715;</span>
          <span>{{ error() }}</span>
          <button
            type="button"
            class="error-dismiss"
            aria-label="Dismiss error"
            (click)="clearError()"
          >
            Dismiss
          </button>
        </div>
      }

      <form class="login-form" (ngSubmit)="onUnlock()">
        <div class="form-group">
          <label for="unlockPassword">Password</label>
          <div class="password-input-wrapper">
            <input
              id="unlockPassword"
              [type]="showPassword() ? 'text' : 'password'"
              [(ngModel)]="unlockPassword"
              name="unlockPassword"
              placeholder="Enter your password"
              required
              autocomplete="current-password"
              [disabled]="isLoading()"
            />
            <button
              type="button"
              class="password-toggle"
              (click)="togglePasswordVisibility()"
              [attr.aria-label]="showPassword() ? 'Hide password' : 'Show password'"
            >
              {{ showPassword() ? 'Hide' : 'Show' }}
            </button>
          </div>
        </div>

        <div class="form-actions">
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="isLoading() || !unlockPassword"
          >
            @if (isLoading()) {
              <span class="spinner"></span>
              Unlocking...
            } @else {
              Unlock
            }
          </button>
        </div>
      </form>

      <div class="login-footer">
        <button type="button" class="link-button" (click)="showAccountSwitcher()">
          Switch account
        </button>
        <button type="button" class="link-button" (click)="goBackToDoorway()">
          Use a different doorway
        </button>
      </div>
    </div>
  }

  <!-- Account Switcher -->
  @if (currentStep() === 'switch-account') {
    <div class="login-card">
      <app-account-switcher
        (needsRestart)="onAccountSwitchRestart()"
        (addAccount)="onAccountSwitcherAddAccount()"
        (cancelled)="onAccountSwitcherCancelled()"
      />
    </div>
  }

  <!-- Restarting (after Tauri login, conductor needs reinit) -->
  @if (currentStep() === 'restarting') {
    <div class="restarting">
      @if (isStewardResult()) {
        <div class="stewardship-badge">Steward</div>
      }
      <h2>Connected to {{ restartingDoorwayName() }}</h2>
      <p>Identity saved. Close and reopen to join the network as a peer.</p>
      <button type="button" class="btn btn-primary restart-btn" (click)="restartApp()">
        Close App
      </button>
    </div>
  }

  <!-- Redirecting to doorway OAuth -->
  @if (currentStep() === 'redirecting') {
    <div class="redirecting">
      <div class="spinner spinner-large"></div>
      <p>Redirecting to your doorway...</p>
    </div>
  }

  <!-- Step 2: Credentials -->
  @if (currentStep() === 'credentials') {
    <div class="login-card">
      <!-- Step Indicator -->
      <div class="step-indicator">
        <button
          type="button"
          class="step-back"
          (click)="goBackToDoorway()"
          aria-label="Change doorway"
        >
          <span class="material-icons">arrow_back</span>
        </button>
        <div class="step-info">
          <span class="step-label">Signing in via</span>
          <span class="step-doorway">
            {{ selectedDoorway()?.doorway?.name ?? 'Unknown Doorway' }}
          </span>
        </div>
      </div>

      <!-- Header -->
      <div class="login-header">
        <h1>Welcome Back</h1>
        <p class="subtitle">Sign in to your hosted identity</p>
      </div>

      <!-- Error Display -->
      @if (error()) {
        <div class="error-banner" role="alert">
          <span class="error-icon" aria-hidden="true">✕</span>
          <span>{{ error() }}</span>
          <button
            type="button"
            class="error-dismiss"
            aria-label="Dismiss error"
            (click)="clearError()"
          >
            Dismiss
          </button>
        </div>
      }

      <!-- Login Form -->
      <form class="login-form" (ngSubmit)="onLogin()">
        <!-- Identifier (Email/Username) -->
        <div class="form-group">
          <label for="identifier">Email or Username</label>
          <input
            id="identifier"
            type="text"
            [(ngModel)]="form.identifier"
            name="identifier"
            placeholder="you@example.com"
            required
            autocomplete="username"
            [disabled]="isLoading()"
          />
        </div>

        <!-- Password -->
        <div class="form-group">
          <label for="password">Password</label>
          <div class="password-input-wrapper">
            <input
              id="password"
              [type]="showPassword() ? 'text' : 'password'"
              [(ngModel)]="form.password"
              name="password"
              placeholder="••••••••"
              required
              autocomplete="current-password"
              [disabled]="isLoading()"
            />
            <button
              type="button"
              class="password-toggle"
              (click)="togglePasswordVisibility()"
              [attr.aria-label]="showPassword() ? 'Hide password' : 'Show password'"
            >
              {{ showPassword() ? 'Hide' : 'Show' }}
            </button>
          </div>
        </div>

        <!-- Remember Me -->
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input
              type="checkbox"
              [(ngModel)]="form.rememberMe"
              name="rememberMe"
              [disabled]="isLoading()"
            />
            <span>Remember my email</span>
          </label>
        </div>

        <!-- Submit -->
        <div class="form-actions">
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="isLoading() || !form.identifier.trim() || !form.password"
          >
            @if (isLoading()) {
              <span class="spinner"></span>
              Signing in...
            } @else {
              Sign In
            }
          </button>
        </div>
      </form>

      <!-- Footer Links -->
      <div class="login-footer">
        <p class="register-prompt">
          Don't have an account?
          <button type="button" (click)="goToRegister()" class="register-link">Create one</button>
        </p>
        <a routerLink="/" class="back-link">← Back to Home</a>
      </div>
    </div>
  }
</div>
