<div class="profile-container">
  <div class="profile-card">
    <!-- Header -->
    <div class="profile-header">
      <button type="button" class="back-button" (click)="goBack()">← Back</button>
      <h1>Your Profile</h1>
    </div>

    <!-- Loading State -->
    @if (isLoading()) {
      <div class="loading-state">
        <span class="spinner"></span>
        <span>Loading profile...</span>
      </div>
    }

    <!-- Success Message -->
    @if (successMessage()) {
      <output class="success-banner">
        <span class="success-icon">✓</span>
        <span>{{ successMessage() }}</span>
        <button type="button" class="dismiss-btn" (click)="clearMessages()">Dismiss</button>
      </output>
    }

    <!-- Error Display -->
    @if (error()) {
      <div class="error-banner" role="alert">
        <span class="error-icon">✕</span>
        <span>{{ error() }}</span>
        <button type="button" class="dismiss-btn" (click)="clearMessages()">Dismiss</button>
      </div>
    }

    <!-- Profile Content -->
    @if (!isLoading()) {
      <!-- View Mode -->
      @if (!isEditing()) {
        <!-- Profile Header (always visible) -->
        <app-profile-header
          [displayName]="displayName()"
          [mode]="mode()"
          [profile]="profile()"
          [did]="did()"
          [canEdit]="canEdit()"
          (editProfile)="startEditing()"
        />

        <!-- Tab Navigation -->
        <div class="tab-bar" role="tablist" aria-label="Profile sections">
          <button
            type="button"
            role="tab"
            class="tab"
            [class.active]="activeTab() === 'identity'"
            [attr.aria-selected]="activeTab() === 'identity'"
            (click)="selectTab('identity')"
          >
            <span class="material-icons tab-icon">person</span>
            Identity
          </button>
          <button
            type="button"
            role="tab"
            class="tab"
            [class.active]="activeTab() === 'network'"
            [attr.aria-selected]="activeTab() === 'network'"
            (click)="selectTab('network')"
          >
            <span class="material-icons tab-icon">lan</span>
            Network
          </button>
          <button
            type="button"
            role="tab"
            class="tab"
            [class.active]="activeTab() === 'data'"
            [attr.aria-selected]="activeTab() === 'data'"
            (click)="selectTab('data')"
          >
            <span class="material-icons tab-icon">shield</span>
            Data & Privacy
          </button>
        </div>

        <!-- Tab Panels -->

        <!-- Identity Tab -->
        @if (activeTab() === 'identity') {
          <div class="tab-panel" role="tabpanel" aria-label="Identity">
            @if (profile(); as p) {
              <app-profile-identity-section [profile]="p" />
            }

            <app-profile-discovery-section
              [results]="allDiscoveryResults()"
              (navigateToDiscovery)="navigateToDiscovery()"
            />

            @if (isNetworkUser()) {
              <app-profile-attestations-section [attestations]="attestations()" />
            } @else {
              @if (attestations().length === 0) {
                <div class="empty-state-card">
                  <span class="material-icons empty-state-icon">verified</span>
                  <p>Join the network to earn attestations and build your reputation.</p>
                  <a routerLink="/identity/register" class="btn btn-secondary">Join Network</a>
                </div>
              }
            }

            <!-- Contextual Links -->
            <div class="context-links-section">
              <span class="section-title">Manage in Context</span>
              <div class="context-links">
                <a routerLink="/shefa" class="context-link">
                  <span class="context-icon material-icons">memory</span>
                  <div class="context-info">
                    <strong>Compute & Nodes</strong>
                    <span>Manage your stewarded compute resources and infrastructure tokens</span>
                  </div>
                  <span class="material-icons">chevron_right</span>
                </a>
                <a routerLink="/lamad/human" class="context-link">
                  <span class="context-icon material-icons">school</span>
                  <div class="context-info">
                    <strong>Learning Profile</strong>
                    <span>View your learning paths, progress, and achievements</span>
                  </div>
                  <span class="material-icons">chevron_right</span>
                </a>
              </div>
            </div>
          </div>
        }

        <!-- Network Tab -->
        @if (activeTab() === 'network') {
          <div class="tab-panel" role="tabpanel" aria-label="Network">
            <app-profile-agency-section
              [agencyInfo]="agencyInfo()"
              [agencyState]="agencyState()"
              [connectionStatus]="connectionStatus()"
              [canUpgrade]="canUpgrade()"
              [nextStageInfo]="nextStageInfo()"
              [nextStageLabel]="nextStageLabel()"
              [isTauriApp]="isTauriApp()"
              [graduationStatus]="graduationStatus()"
              [graduationError]="graduationError()"
              [isGraduationEligible]="isGraduationEligible()"
              (confirmGraduation)="confirmGraduation($event)"
            />

            @if (mode() === 'hosted' && hostingAccount(); as acct) {
              <app-profile-hosting-section
                [account]="acct"
                [doorwayUrl]="activeDoorway()?.url ?? null"
              />
            }

            @if (isNetworkUser()) {
              <app-profile-doorways-section
                [doorways]="registeredDoorways()"
                [activeDoorwayId]="activeDoorway()?.id ?? null"
                [identityMode]="mode()"
                [registrationContext]="doorwayRegistrationContext()"
                (setAsPrimary)="setDoorwayAsPrimary($event)"
                (validateDoorway)="validateDoorway($event)"
                (addDoorway)="addDoorway($event)"
              />

              <app-profile-network-section
                [agencyState]="agencyState()"
                [connectionStatus]="connectionStatus()"
                [edgeNodeInfo]="edgeNodeInfo()"
                (reconnect)="reconnect()"
              />
            } @else {
              <div class="empty-state-card">
                <span class="material-icons empty-state-icon">cloud_off</span>
                <p>Connect to a doorway to view your network details and manage connections.</p>
                <a routerLink="/identity/register" class="btn btn-secondary">Join Network</a>
              </div>
            }
          </div>
        }

        <!-- Data & Privacy Tab -->
        @if (activeTab() === 'data') {
          <div class="tab-panel" role="tabpanel" aria-label="Data and Privacy">
            <app-profile-data-section
              [isAuthenticated]="isAuthenticated()"
              [hostingCost]="identityState().hostingCost"
              [nodeOperatorIncome]="identityState().nodeOperatorIncome"
              [keyBackup]="identityState().keyBackup"
              (exportData)="exportData()"
            />
          </div>
        }
      }

      <!-- Edit Mode -->
      @if (isEditing()) {
        <form class="profile-edit" (ngSubmit)="saveProfile()">
          <div class="form-group">
            <label for="displayName">Display Name *</label>
            <input
              id="displayName"
              type="text"
              [(ngModel)]="form.displayName"
              name="displayName"
              required
              maxlength="50"
              [disabled]="isSaving()"
            />
          </div>

          <div class="form-group">
            <label for="bio">Bio</label>
            <textarea
              id="bio"
              [(ngModel)]="form.bio"
              name="bio"
              rows="3"
              maxlength="500"
              [disabled]="isSaving()"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="affinities">Interests</label>
            <input
              id="affinities"
              type="text"
              [(ngModel)]="form.affinities"
              name="affinities"
              placeholder="philosophy, technology, community..."
              [disabled]="isSaving()"
            />
            <span class="hint">Comma-separated</span>
          </div>

          <div class="form-group">
            <label for="location">Location</label>
            <input
              id="location"
              type="text"
              [(ngModel)]="form.location"
              name="location"
              maxlength="100"
              [disabled]="isSaving()"
            />
          </div>

          <div class="form-group">
            <fieldset class="reach-options">
              <legend class="form-label">Visibility</legend>
              @for (option of reachOptions; track option.value) {
                <label class="reach-option" [class.selected]="form.profileReach === option.value">
                  <input
                    type="radio"
                    [(ngModel)]="form.profileReach"
                    name="profileReach"
                    [value]="option.value"
                    [disabled]="isSaving()"
                  />
                  <div class="reach-content">
                    <strong>{{ option.label }}</strong>
                    <span>{{ option.description }}</span>
                  </div>
                </label>
              }
            </fieldset>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              (click)="cancelEditing()"
              [disabled]="isSaving()"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="btn btn-primary"
              [disabled]="isSaving() || !form.displayName.trim()"
            >
              @if (isSaving()) {
                <span class="spinner"></span>
                Saving...
              } @else {
                Save Changes
              }
            </button>
          </div>
        </form>
      }
    }
  </div>
</div>
