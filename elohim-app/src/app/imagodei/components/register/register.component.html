<div class="register-container">
  <!-- Step 1: Doorway Selection -->
  @if (currentStep() === 'doorway') {
    <app-doorway-picker
      (doorwaySelected)="onDoorwaySelected($event)"
      (cancelled)="onDoorwayPickerCancelled()"
    />
  }

  <!-- Step 2: Credentials -->
  @if (currentStep() === 'credentials') {
    <div class="register-card">
      <!-- Step Indicator -->
      <div class="step-indicator">
        <button
          type="button"
          class="step-back"
          (click)="goBackToDoorway()"
          aria-label="Change doorway"
        >
          <span class="material-icons">arrow_back</span>
        </button>
        <div class="step-info">
          <span class="step-label">Registering with</span>
          <span class="step-doorway">
            {{ selectedDoorway()?.doorway?.name ?? 'Unknown Doorway' }}
          </span>
        </div>
      </div>

      <!-- Header -->
      <div class="register-header">
        <h1>Create Your Identity</h1>
        <p class="subtitle">Set up your profile and credentials</p>
      </div>

      <!-- Connection Status -->
      @if (!isConnected()) {
        <div class="status-banner warning">
          <span class="status-icon">⚠</span>
          <span>Connecting to network...</span>
        </div>
      }

      <!-- Migration Banner -->
      @if (hasSession() && canMigrate()) {
        <div class="migration-banner">
          <div class="migration-header">
            <span class="migration-icon">✓</span>
            <strong>Your Progress Will Be Saved</strong>
          </div>
          <p>Your session progress will be automatically migrated when you create your identity.</p>
          @if (sessionStats()) {
            <p class="session-stats">{{ getSessionStatsDisplay() }}</p>
          }
        </div>
      }

      <!-- Error Display -->
      @if (error()) {
        <div class="error-banner" role="alert">
          <span class="error-icon">✕</span>
          <span>{{ error() }}</span>
          <button type="button" class="error-dismiss" (click)="clearError()">Dismiss</button>
        </div>
      }

      <!-- Registration Form -->
      <form class="register-form" (ngSubmit)="onRegister()">
        <!-- Display Name -->
        <div class="form-group">
          <label for="displayName">Display Name *</label>
          <input
            id="displayName"
            type="text"
            [(ngModel)]="form.displayName"
            name="displayName"
            placeholder="How should we call you?"
            required
            maxlength="50"
            [disabled]="isRegistering()"
          />
          <span class="hint">This is how you'll appear to others</span>
        </div>

        <!-- Bio -->
        <div class="form-group">
          <label for="bio">Bio</label>
          <textarea
            id="bio"
            [(ngModel)]="form.bio"
            name="bio"
            placeholder="Tell us a bit about yourself..."
            rows="3"
            maxlength="500"
            [disabled]="isRegistering()"
          ></textarea>
          <span class="hint">Optional - share what brings you here</span>
        </div>

        <!-- Affinities -->
        <div class="form-group">
          <label for="affinities">Interests</label>
          <input
            id="affinities"
            type="text"
            [(ngModel)]="form.affinities"
            name="affinities"
            placeholder="philosophy, technology, community..."
            [disabled]="isRegistering()"
          />
          <span class="hint">Comma-separated topics you're drawn to</span>
        </div>

        <!-- Location -->
        <div class="form-group">
          <label for="location">Location</label>
          <input
            id="location"
            type="text"
            [(ngModel)]="form.location"
            name="location"
            placeholder="City, Country"
            maxlength="100"
            [disabled]="isRegistering()"
          />
          <span class="hint">Optional - helps connect you with nearby community</span>
        </div>

        <!-- Profile Reach -->
        <div class="form-group">
          <fieldset class="reach-options">
            <legend class="form-label">Profile Visibility</legend>
            @for (option of reachOptions; track option.value) {
              <label class="reach-option" [class.selected]="form.profileReach === option.value">
                <input
                  type="radio"
                  [(ngModel)]="form.profileReach"
                  name="profileReach"
                  [value]="option.value"
                  [disabled]="isRegistering()"
                />
                <div class="reach-content">
                  <strong>{{ option.label }}</strong>
                  <span>{{ option.description }}</span>
                </div>
              </label>
            }
          </fieldset>
        </div>

        <!-- Account Credentials Section -->
        <div class="form-section">
          <h2 class="section-title">Account Credentials</h2>
          <p class="section-description">
            Create login credentials to access your identity from any device.
          </p>

          <!-- Email -->
          <div class="form-group">
            <label for="email">Email *</label>
            <input
              id="email"
              type="email"
              [(ngModel)]="form.email"
              name="email"
              placeholder="you@example.com"
              required
              autocomplete="email"
              [disabled]="isRegistering()"
            />
            <span class="hint">Used for login - we won't share this</span>
          </div>

          <!-- Password -->
          <div class="form-group">
            <label for="password">Password *</label>
            <div class="password-input-wrapper">
              <input
                id="password"
                [type]="showPassword() ? 'text' : 'password'"
                [(ngModel)]="form.password"
                name="password"
                placeholder="Minimum 8 characters"
                required
                minlength="8"
                autocomplete="new-password"
                [disabled]="isRegistering()"
              />
              <button
                type="button"
                class="password-toggle"
                (click)="togglePasswordVisibility()"
                [attr.aria-label]="showPassword() ? 'Hide password' : 'Show password'"
              >
                {{ showPassword() ? 'Hide' : 'Show' }}
              </button>
            </div>
            <span class="hint">Minimum 8 characters</span>
          </div>

          <!-- Confirm Password -->
          <div class="form-group">
            <label for="confirmPassword">Confirm Password *</label>
            <input
              id="confirmPassword"
              [type]="showPassword() ? 'text' : 'password'"
              [(ngModel)]="form.confirmPassword"
              name="confirmPassword"
              placeholder="Re-enter your password"
              required
              autocomplete="new-password"
              [disabled]="isRegistering()"
            />
          </div>
        </div>

        <!-- Submit -->
        <div class="form-actions">
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="
              isRegistering() ||
              !isConnected() ||
              !form.displayName.trim() ||
              !form.email.trim() ||
              !form.password ||
              form.password !== form.confirmPassword
            "
          >
            @if (isRegistering()) {
              <span class="spinner"></span>
              Creating Identity...
            } @else {
              Create Identity
            }
          </button>
        </div>
      </form>

      <!-- Footer Links -->
      <div class="register-footer">
        <p class="login-prompt">
          Already have an account?
          <button type="button" (click)="goToLogin()" class="login-link">Sign in</button>
        </p>
        <p class="terms-text">
          By joining, you agree to participate in good faith with the community.
        </p>
        <a routerLink="/" class="back-link">← Back to Home</a>
      </div>
    </div>
  }
</div>
