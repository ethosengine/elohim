<div class="graph-explorer">
  <!-- Header with breadcrumbs and controls -->
  <header class="explorer-header">
    <nav class="breadcrumbs">
      @for (crumb of breadcrumbs; track crumb.id; let last = $last) {
        @if (!last) {
          <button class="crumb" (click)="navigateToBreadcrumb(crumb)">
            {{ crumb.title }}
          </button>
          <span class="crumb-separator">/</span>
        } @else {
          <span class="crumb current">{{ crumb.title }}</span>
        }
      }
    </nav>

    <div class="controls">
      <!-- View mode toggle -->
      <div class="view-mode-toggle">
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'path-hierarchy'"
          (click)="setViewMode('path-hierarchy')"
          title="View by learning path structure"
        >
          <span class="icon">&#9672;</span>
          Hierarchy
        </button>
        <button
          class="toggle-btn"
          [class.active]="viewMode === 'overview'"
          (click)="setViewMode('overview')"
          title="View flat overview"
        >
          <span class="icon">&#9679;</span>
          Overview
        </button>
      </div>

      @if (returnContext) {
        <button class="control-btn return-to-path" (click)="returnToPath()" title="Return to path">
          <span class="icon">&#8592;</span>
          Return to Path
        </button>
      }
      <button class="control-btn" (click)="resetZoom()" title="Reset zoom">
        <span class="icon">&#8634;</span>
        Reset
      </button>
      <button class="control-btn" routerLink="/lamad" title="Back to paths">
        <span class="icon">&#8592;</span>
        Paths
      </button>
    </div>
  </header>

  <!-- Loading state -->
  @if (isLoading) {
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading knowledge graph...</p>
    </div>
  }

  <!-- Error state -->
  @if (error) {
    <div class="error-state">
      <h2>Unable to load graph</h2>
      <p>{{ error }}</p>
      <button class="btn btn-primary" (click)="loadPathHierarchy(currentPathId)">Retry</button>
    </div>
  }

  <!-- Graph container -->
  <div
    #graphContainer
    class="graph-container"
    [class.hidden]="isLoading || error"
  ></div>

  <!-- Node tooltip / info panel -->
  @if (hoveredNode || selectedNode) {
    @let node = selectedNode || hoveredNode;
    <div class="node-tooltip" [class.selected]="selectedNode" [class.cluster]="node?.isCluster">
      <div class="tooltip-header">
        @if (node?.isCluster) {
          <span class="tooltip-type cluster-type">{{ getClusterTypeLabel(node?.clusterType ?? null) }}</span>
        } @else {
          <span class="tooltip-type">{{ node?.contentType }}</span>
        }
        <span
          class="tooltip-state"
          [class]="'state-' + node?.state"
        >
          {{ getStateLabel(node?.state || '') }}
        </span>
      </div>

      <h3 class="tooltip-title">{{ node?.title }}</h3>

      @if (node?.description) {
        <p class="tooltip-description">{{ node?.description }}</p>
      }

      <!-- Cluster-specific info -->
      @if (node?.isCluster) {
        <div class="cluster-info">
          <div class="cluster-stats">
            <div class="stat">
              <span class="stat-value">{{ node?.totalConceptCount }}</span>
              <span class="stat-label">concepts</span>
            </div>
            @if (node && node.totalConceptCount > 0) {
              <div class="stat">
                <span class="stat-value">{{ node.completedConceptCount }}</span>
                <span class="stat-label">completed</span>
              </div>
              <div class="stat progress-stat">
                <span class="stat-value">{{ ((node.completedConceptCount / node.totalConceptCount) * 100) | number:'1.0-0' }}%</span>
                <span class="stat-label">progress</span>
              </div>
            }
            @if (node && node.externalConnectionCount > 0) {
              <div class="stat connections-stat">
                <span class="stat-value">{{ node.externalConnectionCount }}</span>
                <span class="stat-label">connections</span>
              </div>
            }
          </div>

          <!-- Child count indicator -->
          @if (node && node.childClusterIds.length > 0) {
            <p class="cluster-children">
              <span class="children-icon">&#9662;</span>
              {{ node.childClusterIds.length }} {{ node.clusterType === 'chapter' ? 'modules' : node.clusterType === 'module' ? 'sections' : 'items' }}
            </p>
          }
        </div>
      }

      @if (node?.state === 'locked') {
        <div class="tooltip-locked">
          <span class="lock-icon">ðŸ”’</span>
          Complete the Manifesto first to unlock
        </div>
      }

      @if (selectedNode && selectedNode.state !== 'locked') {
        <div class="tooltip-actions">
          @if (selectedNode.isCluster) {
            <!-- Cluster actions -->
            @if (isClusterLoading(selectedNode)) {
              <button class="btn btn-primary btn-small" disabled>
                <span class="btn-spinner"></span>
                Loading...
              </button>
            } @else if (canExpand(selectedNode)) {
              <button class="btn btn-primary btn-small" (click)="expandCluster(selectedNode.id)">
                <span class="expand-icon">+</span>
                Expand
              </button>
            } @else if (isExpanded(selectedNode)) {
              <button class="btn btn-secondary btn-small" (click)="collapseCluster(selectedNode.id)">
                <span class="collapse-icon">-</span>
                Collapse
              </button>
            }
          } @else {
            <!-- Concept actions -->
            <button class="btn btn-primary btn-small" (click)="navigateToContent(selectedNode.id)">
              View Content
            </button>
          }
        </div>
      }
    </div>
  }

  <!-- Legend -->
  <div class="graph-legend" [class.expanded]="viewMode === 'path-hierarchy'">
    <h4>Legend</h4>
    <div class="legend-items">
      <!-- Cluster levels (only in hierarchy mode) -->
      @if (viewMode === 'path-hierarchy') {
        <div class="legend-section">
          <span class="legend-section-title">Hierarchy</span>
          <div class="legend-item">
            <span class="legend-cluster chapter"></span>
            <span>Chapter</span>
          </div>
          <div class="legend-item">
            <span class="legend-cluster module"></span>
            <span>Module</span>
          </div>
          <div class="legend-item">
            <span class="legend-cluster section"></span>
            <span>Section</span>
          </div>
        </div>

        <div class="legend-section">
          <span class="legend-section-title">Connections</span>
          <div class="legend-item">
            <span class="legend-arrow"></span>
            <span>Learning Path</span>
          </div>
        </div>
      }

      <div class="legend-section">
        <span class="legend-section-title">Progress</span>
        <div class="legend-item">
          <span class="legend-dot unseen"></span>
          <span>Not Started</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot in-progress"></span>
          <span>In Progress</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot proficient"></span>
          <span>Completed</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot recommended"></span>
          <span>Recommended</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot locked"></span>
          <span>Locked</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Instructions -->
  <div class="instructions">
    <p>
      @if (viewMode === 'path-hierarchy') {
        <strong>Click</strong> to select &bull;
        <strong>Double-click</strong> cluster to expand &bull;
        <strong>Drag</strong> to reposition &bull;
        <strong>Scroll</strong> to zoom
      } @else {
        <strong>Click</strong> a node to select &bull;
        <strong>Double-click</strong> to navigate &bull;
        <strong>Drag</strong> to reposition &bull;
        <strong>Scroll</strong> to zoom
      }
    </p>
  </div>
</div>
