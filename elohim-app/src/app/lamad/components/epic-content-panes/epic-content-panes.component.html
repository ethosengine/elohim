<div class="epic-panes-container" *ngIf="epic">
  <!-- Header Section -->
  <div class="epic-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="epic-title">{{ epic.title }}</h1>
        <div class="epic-meta">
          <span class="category-badge" *ngIf="epic.metadata.category">
            {{ epic.metadata.category }}
          </span>
          <span class="version-badge" *ngIf="epic.metadata.version">
            v{{ epic.metadata.version }}
          </span>
        </div>
      </div>

      <div class="affinity-section">
        <app-affinity-circle
          [affinity]="affinity"
          [size]="60"
          class="affinity-display">
        </app-affinity-circle>
        <div class="affinity-controls">
          <button class="affinity-btn decrease" (click)="decreaseAffinity()" title="Decrease understanding">
            −
          </button>
          <button class="affinity-btn increase" (click)="increaseAffinity()" title="Increase understanding">
            +
          </button>
          <button class="affinity-btn mastered" (click)="markMastered()" title="Mark as mastered">
            ✓
          </button>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button
        *ngFor="let tab of tabs"
        class="tab-button"
        [class.active]="activeTab === tab.id"
        (click)="selectTab(tab.id)">
        <span class="tab-icon">{{ tab.icon }}</span>
        <span class="tab-label">{{ tab.label }}</span>
        <span class="tab-count" *ngIf="tab.count !== undefined">({{ tab.count }})</span>
      </button>
    </div>
  </div>

  <!-- Pane Content -->
  <div class="pane-content">
    <!-- Overview Pane -->
    <div class="pane overview-pane" *ngIf="activeTab === 'overview'">
      <div class="pane-header">
        <h2>Epic Overview</h2>
        <p class="epic-description" *ngIf="epic.description">{{ epic.description }}</p>
      </div>

      <div class="epic-metadata" *ngIf="epic.metadata.authors && epic.metadata.authors.length > 0">
        <div class="metadata-item">
          <strong>Authors:</strong>
          <span>{{ epic.metadata.authors.join(', ') }}</span>
        </div>
      </div>

      <div class="markdown-content" [innerHTML]="renderMarkdown(epic.content)">
      </div>
    </div>

    <!-- Features Pane -->
    <div class="pane features-pane" *ngIf="activeTab === 'features'">
      <div class="pane-header">
        <h2>Features Implementing This Epic</h2>
        <p class="pane-description">
          These features provide the technical implementation of this epic's vision.
        </p>
      </div>

      <div class="empty-state" *ngIf="features.length === 0">
        <p>No features have been created for this epic yet.</p>
      </div>

      <div class="feature-grid" *ngIf="features.length > 0">
        <button
          *ngFor="let feature of features"
          class="feature-card"
          [class]="getFeatureStatusClass(feature)"
          (click)="viewFeature(feature)"
          type="button">
          <div class="card-header">
            <h3 class="feature-title">{{ feature.title }}</h3>
            <span class="status-indicator" *ngIf="feature.metadata['testStatus']">
              {{ feature.metadata['testStatus'].status }}
            </span>
          </div>
          <p class="feature-description">{{ feature.metadata['featureDescription'] }}</p>
          <div class="card-footer">
            <span class="scenario-count" *ngIf="feature.metadata['scenarioIds']">
              {{ feature.metadata['scenarioIds'].length }} scenario{{ feature.metadata['scenarioIds'].length !== 1 ? 's' : '' }}
            </span>
            <span class="category-tag" *ngIf="feature.metadata.category">
              {{ feature.metadata.category }}
            </span>
          </div>
        </button>
      </div>
    </div>

    <!-- Scenarios Pane -->
    <div class="pane scenarios-pane" *ngIf="activeTab === 'scenarios'">
      <div class="pane-header">
        <h2>Test Scenarios</h2>
        <p class="pane-description">
          Scenarios that validate the functionality described in this epic.
        </p>
      </div>

      <div class="empty-state" *ngIf="scenarios.length === 0">
        <p>No scenarios have been created yet.</p>
      </div>

      <div class="scenario-list" *ngIf="scenarios.length > 0">
        <button
          *ngFor="let scenario of scenarios"
          class="scenario-card"
          [class]="getScenarioStatusClass(scenario)"
          (click)="viewScenario(scenario)"
          type="button">
          <div class="card-header">
            <div class="scenario-type-badge">{{ scenario.metadata['scenarioType'] }}</div>
            <h3 class="scenario-title">{{ scenario.title }}</h3>
          </div>
          <div class="scenario-steps" *ngIf="scenario.metadata['steps']">
            <div class="step-summary">
              {{ scenario.metadata['steps'].length }} step{{ scenario.metadata['steps'].length !== 1 ? 's' : '' }}
            </div>
            <div class="step-preview" *ngIf="scenario.metadata['steps'].length > 0">
              <code>{{ scenario.metadata['steps'][0].keyword }} {{ scenario.metadata['steps'][0].text }}</code>
            </div>
          </div>
          <div class="card-footer" *ngIf="scenario.metadata['testStatus']">
            <span class="test-status">
              Status: {{ scenario.metadata['testStatus'].status }}
            </span>
            <span class="last-run" *ngIf="scenario.metadata['testStatus'].lastRun">
              Last run: {{ scenario.metadata['testStatus'].lastRun | date: 'short' }}
            </span>
          </div>
        </button>
      </div>
    </div>

    <!-- Related Epics Pane -->
    <div class="pane related-pane" *ngIf="activeTab === 'related'">
      <div class="pane-header">
        <h2>Related Epics</h2>
        <p class="pane-description">
          Other epics that connect to or complement this one.
        </p>
      </div>

      <div class="empty-state" *ngIf="relatedEpics.length === 0">
        <p>No related epics found.</p>
      </div>

      <div class="related-epic-grid" *ngIf="relatedEpics.length > 0">
        <button
          *ngFor="let relatedEpic of relatedEpics"
          class="epic-card"
          (click)="viewRelatedEpic(relatedEpic)"
          type="button">
          <div class="card-header">
            <h3 class="epic-title">{{ relatedEpic.title }}</h3>
            <span class="category-badge" *ngIf="relatedEpic.metadata.category">
              {{ relatedEpic.metadata.category }}
            </span>
          </div>
          <p class="epic-description">{{ relatedEpic.description }}</p>
          <div class="card-footer">
             <!-- Feature count might be unavailable or needing computation -->
            <span class="feature-count" *ngIf="relatedEpic.metadata['featureIds']">
              {{ relatedEpic.metadata['featureIds'].length }} feature{{ relatedEpic.metadata['featureIds'].length !== 1 ? 's' : '' }}
            </span>
          </div>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="loading-state" *ngIf="!epic">
  <div class="spinner"></div>
  <p>Loading epic content...</p>
</div>
