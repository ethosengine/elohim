<div class="lamad-home-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading learning path...</p>
  </div>

  <!-- Main Three-Panel Layout -->
  <div *ngIf="!isLoading" class="three-panel-layout">

    <!-- Mobile Sidebar Backdrop -->
    <button class="sidebar-backdrop"
         *ngIf="isSidebarOpen"
         (click)="closeSidebar()"
         (keydown.escape)="closeSidebar()"
         type="button"
         aria-label="Close sidebar">
    </button>

    <!-- LEFT SIDEBAR: Navigation Menu -->
    <aside class="nav-sidebar" [class.open]="isSidebarOpen">
      <div class="sidebar-header">
        <h2 class="sidebar-title">Elohim</h2>
        <button class="close-sidebar-btn" (click)="toggleSidebar()">‚úï</button>
      </div>

      <nav class="path-nav">
        <!-- Overview / Home Link -->
        <button class="path-item overview-item"
                [class.selected]="!selectedNode && viewState === 'root'"
                (click)="goHome()"
                type="button">
          <span class="path-icon">üìä</span>
          <span class="path-title">Overview</span>
        </button>

        <div class="nav-divider"></div>
        
        <!-- Dynamic Section Label -->
        <div class="nav-section-label">
          <ng-container *ngIf="viewState === 'root'">Epics</ng-container>
          <ng-container *ngIf="viewState === 'drilldown' && activeDrillDown">
            {{ activeDrillDown.parent.title }} / {{ activeDrillDown.type }}
          </ng-container>
        </div>
        
        <!-- Back Button for Drilldown -->
        <button *ngIf="viewState === 'drilldown'"
                class="path-item back-item"
                (click)="goUp()"
                type="button">
          <span class="path-icon">‚Üê</span>
          <span class="path-title">Back to Epics</span>
        </button>

        <button *ngFor="let pathNode of sidebarNodes; let i = index"
                class="path-item"
                [class.selected]="selectedNode?.id === pathNode.node.id"
                (click)="selectNode(pathNode.node)"
                (keydown.enter)="selectNode(pathNode.node)"
                type="button">
          <span class="path-icon">{{ getContentTypeIcon(pathNode.node.contentType) }}</span>
          <span class="path-title">{{ pathNode.node.title }}</span>
        </button>
      </nav>
    </aside>

    <!-- RIGHT CONTENT AREA -->
    <main class="content-area">

      <!-- UNIFIED TOOLBAR -->
      <header class="lamad-toolbar">
        <!-- Left: Navigation Controls -->
        <div class="toolbar-left">
          <button class="icon-btn menu-btn" (click)="toggleSidebar()" aria-label="Toggle Sidebar">
            ‚ò∞
          </button>
          
          <!-- Breadcrumbs -->
          <div class="toolbar-breadcrumbs">
             <button class="breadcrumb-link" (click)="goHome()">Home</button>
             
             <ng-container *ngIf="viewState === 'drilldown' && activeDrillDown">
               <span class="separator">/</span>
               <button class="breadcrumb-link" (click)="selectNode(activeDrillDown.parent)">{{ activeDrillDown.parent.title }}</button>
               <span class="separator">/</span>
               <span class="current-node">{{ activeDrillDown.type }}</span>
             </ng-container>

             <ng-container *ngIf="selectedNode">
               <span class="separator">/</span>
               <span class="current-node">{{ selectedNode.title }}</span>
             </ng-container>
          </div>
        </div>

        <!-- Right: Actions -->
        <div class="toolbar-right">
          <button class="icon-btn search-btn" (click)="toggleSearch()" [class.active]="isSearchOpen" aria-label="Search">
            üîç
          </button>
        </div>
      </header>

      <!-- SEARCH OVERLAY -->
      <div class="search-overlay" *ngIf="isSearchOpen">
         <input type="text" placeholder="Search content..." class="search-input" autofocus>
         <!-- Search results would go here -->
      </div>

      <!-- AT-A-GLANCE OVERVIEW (Collapsible Panel) -->
      <section class="graph-section" [class.expanded]="isGraphExpanded">
        <div class="graph-content" *ngIf="isGraphExpanded && affinityStats">
          <div class="affinity-overview">
            <!-- Learning Path Progress Circle -->
            <div class="learning-progress-container">
               <app-affinity-circle
                 [affinity]="getPathProgress() / 100"
                 [size]="100">
               </app-affinity-circle>
               <span class="progress-label">Mastery</span>
            </div>

            <!-- Hexagon Grid -->
            <div class="hexagon-grid">
              <button *ngFor="let node of allContentNodes"
                   class="hexagon-chip"
                   [class]="'affinity-' + node.affinityLevel"
                   [title]="node.title + ' (' + getAffinityPercentage(node.affinity) + '%)'"
                   (click)="selectNode(node)"
                   type="button"
                   [attr.aria-label]="node.title">
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- CENTER: Content Viewer or Home Placeholder -->
      <section class="content-viewer">

        <!-- Home Placeholder (Root View: Epic Panes) -->
        <div *ngIf="!selectedNode && viewState === 'root'" class="home-placeholder">
           <h1 class="home-title">The Elohim Protocol</h1>
           <p class="home-subtitle">Explore the epics below to begin your journey.</p>
           
           <div class="epic-grid">
             <div *ngFor="let item of sidebarNodes" class="epic-card">
                <div class="epic-card-body" (click)="selectNode(item.node)" tabindex="0" (keydown.enter)="selectNode(item.node)">
                  <div class="epic-card-header">
                    <div class="epic-icon-container">
                      <span class="epic-icon">{{ getContentTypeIcon(item.node.contentType) }}</span>
                    </div>
                    <h2 class="epic-title">{{ item.node.title }}</h2>
                  </div>
                  <p class="epic-desc">{{ item.node.description }}</p>
                </div>
                
                <div class="epic-footer">
                   <span class="epic-category">{{ getCategoryDisplay(item.category) }}</span>
                   <div class="hex-badge" 
                        [class]="'affinity-' + item.affinityLevel"
                        [title]="'Affinity: ' + getAffinityPercentage(item.affinity) + '%'">
                   </div>
                </div>
                
                <!-- Drill Down Links -->
                <div class="epic-drilldown" *ngIf="getRelatedGrouping(item.node).length > 0">
                   <div class="drilldown-label">Explore:</div>
                   <div class="drilldown-chips">
                     <button *ngFor="let group of getRelatedGrouping(item.node)"
                             class="drilldown-chip"
                             (click)="drillDown(item.node, group.type)"
                             type="button">
                       <span class="drilldown-icon">{{ getContentTypeIcon(group.type) }}</span>
                       <span class="drilldown-count">{{ group.count }}</span>
                       <span class="drilldown-type">{{ group.type | titlecase }}</span>
                     </button>
                   </div>
                </div>
             </div>
           </div>
        </div>
        
        <!-- Drill-Down View (Filtered List) -->
        <div *ngIf="!selectedNode && viewState === 'drilldown' && activeDrillDown" class="home-placeholder drilldown-view">
           <div class="drilldown-header">
             <button class="back-btn" (click)="goUp()">‚Üê Back to Epics</button>
             <h1 class="home-title">{{ activeDrillDown.parent.title }} <span class="separator">/</span> {{ activeDrillDown.type | titlecase }}</h1>
             <p class="home-subtitle">Exploring {{ activeDrillDown.nodes.length }} items in {{ activeDrillDown.parent.title }}</p>
           </div>
           
           <div class="epic-grid">
             <button *ngFor="let node of activeDrillDown.nodes"
                  class="epic-card"
                  (click)="selectNode(node)"
                  type="button"
                  [attr.aria-label]="node.title">
                <div class="epic-card-body">
                  <div class="epic-card-header">
                    <div class="epic-icon-container">
                      <span class="epic-icon">{{ getContentTypeIcon(node.contentType) }}</span>
                    </div>
                    <h2 class="epic-title">{{ node.title }}</h2>
                  </div>
                  <p class="epic-desc">{{ node.description }}</p>
                </div>
                <div class="epic-footer">
                   <span class="epic-category">{{ getCategoryDisplay(node.metadata['category'] || 'General') }}</span>
                   <div class="hex-badge" 
                        [class]="'affinity-' + node.affinityLevel"
                        [title]="'Affinity: ' + getAffinityPercentage(node.affinity) + '%'">
                   </div>
                </div>
             </button>
           </div>
        </div>

        <!-- Selected Content -->
        <ng-container *ngIf="selectedNode">
          <!-- Content Header -->
          <header class="content-header">
            <div class="content-meta">
              <span class="content-type-badge">
                {{ getContentTypeIcon(selectedNode.contentType) }}
                {{ selectedNode.contentType }}
              </span>
              <span class="content-category" *ngIf="selectedNode.metadata?.['category']">
                {{ selectedNode.metadata['category'] }}
              </span>
            </div>

            <h1 class="content-title">{{ selectedNode.title }}</h1>

            <p class="content-description" *ngIf="selectedNode.description">
              {{ selectedNode.description }}
            </p>
          </header>

          <!-- Content Body -->
          <article class="content-body">
            <!-- Markdown Content -->
            <div *ngIf="selectedNode.contentFormat === 'markdown'"
                 class="markdown-content"
                 [innerHTML]="renderMarkdown(selectedNode.content)">
            </div>

            <!-- Gherkin Content -->
            <div *ngIf="selectedNode.contentFormat === 'gherkin'"
                 class="gherkin-content"
                 [innerHTML]="renderGherkin(selectedNode.content)">
            </div>

            <!-- Plain Text Content -->
            <div *ngIf="selectedNode.contentFormat === 'plaintext'"
                 class="plaintext-content">
              {{ selectedNode.content }}
            </div>
          </article>

          <!-- Content Footer: Navigation -->
          <footer class="content-footer">
            <button class="nav-btn prev"
                    (click)="goToPrevious()"
                    [disabled]="!hasPrevious()">
              ‚Üê Previous
            </button>

            <div class="footer-info">
              <span class="node-position">
                {{ getCurrentPosition() }} of {{ pathNodes.length }}
              </span>
            </div>

            <button class="nav-btn next"
                    (click)="goToNext()"
                    [disabled]="!hasNext()">
              Next ‚Üí
            </button>
          </footer>
        </ng-container>

      </section>

    </main>
  </div>
</div>