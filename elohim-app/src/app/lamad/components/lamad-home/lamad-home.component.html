<div class="lamad-home-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading learning path...</p>
  </div>

  <!-- Main Three-Panel Layout -->
  <div *ngIf="!isLoading" class="three-panel-layout">

    <!-- LEFT SIDEBAR: Navigation Menu -->
    <aside class="nav-sidebar">
      <div class="sidebar-header">
        <h2 class="sidebar-title">Learning Path</h2>
        <div class="path-progress">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="getPathProgress()"></div>
          </div>
          <span class="progress-text">{{ getPathProgress() | number:'1.0-0' }}% explored</span>
        </div>
      </div>

      <nav class="path-nav">
        <div *ngFor="let pathNode of pathNodes; let i = index"
             class="path-item"
             [class.selected]="selectedNode?.id === pathNode.node.id"
             [class.depth-1]="pathNode.depth === 1"
             (click)="selectNode(pathNode.node)">

          <!-- Node Info -->
          <div class="path-item-content">
            <div class="path-item-header">
              <span class="path-order">{{ i + 1 }}</span>
              <span class="path-icon">{{ getContentTypeIcon(pathNode.node.contentType) }}</span>
              <span class="path-title">{{ pathNode.node.title }}</span>
            </div>

            <!-- Affinity Indicator -->
            <div class="affinity-indicator"
                 [class.affinity-unseen]="pathNode.affinityLevel === 'unseen'"
                 [class.affinity-low]="pathNode.affinityLevel === 'low'"
                 [class.affinity-medium]="pathNode.affinityLevel === 'medium'"
                 [class.affinity-high]="pathNode.affinityLevel === 'high'">
              <div class="affinity-dot"></div>
            </div>
          </div>

          <!-- Category Badge -->
          <div class="category-badge" *ngIf="pathNode.depth === 0">
            {{ getCategoryDisplay(pathNode.category) }}
          </div>
        </div>
      </nav>

      <!-- Sidebar Footer -->
      <div class="sidebar-footer">
        <a routerLink="/lamad/map" class="sidebar-link">
          üó∫Ô∏è View Full Map
        </a>
        <a routerLink="/lamad/search" class="sidebar-link">
          üîç Search Content
        </a>
      </div>
    </aside>

    <!-- RIGHT CONTENT AREA -->
    <main class="content-area">

      <!-- TOP: Graph Visualization -->
      <section class="graph-section" [class.collapsed]="!isGraphExpanded">
        <div class="graph-header" (click)="toggleGraph()">
          <h3 class="graph-title">
            <span class="graph-icon">üìä</span>
            At-a-Glance Overview
          </h3>
          <button class="toggle-btn" [class.rotated]="!isGraphExpanded">
            ‚ñº
          </button>
        </div>

        <div class="graph-content" *ngIf="isGraphExpanded && affinityStats">
          <!-- Stats Grid -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Content</div>
              <div class="stat-value">{{ affinityStats.totalNodes }}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Explored</div>
              <div class="stat-value">{{ affinityStats.engagedNodes }}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Avg Affinity</div>
              <div class="stat-value">{{ (affinityStats.averageAffinity * 100) | number:'1.0-0' }}%</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Path Progress</div>
              <div class="stat-value">{{ getPathProgress() | number:'1.0-0' }}%</div>
            </div>
          </div>

          <!-- Affinity Distribution -->
          <div class="distribution-viz">
            <div class="distribution-bar-container">
              <div class="distribution-segment unseen"
                   [style.flex]="affinityStats.distribution.unseen"
                   [title]="'Unseen: ' + affinityStats.distribution.unseen">
              </div>
              <div class="distribution-segment low"
                   [style.flex]="affinityStats.distribution.low"
                   [title]="'Low: ' + affinityStats.distribution.low">
              </div>
              <div class="distribution-segment medium"
                   [style.flex]="affinityStats.distribution.medium"
                   [title]="'Medium: ' + affinityStats.distribution.medium">
              </div>
              <div class="distribution-segment high"
                   [style.flex]="affinityStats.distribution.high"
                   [title]="'High: ' + affinityStats.distribution.high">
              </div>
            </div>
            <div class="distribution-legend">
              <span class="legend-item">
                <span class="legend-dot unseen"></span> Unseen
              </span>
              <span class="legend-item">
                <span class="legend-dot low"></span> Low
              </span>
              <span class="legend-item">
                <span class="legend-dot medium"></span> Medium
              </span>
              <span class="legend-item">
                <span class="legend-dot high"></span> High
              </span>
            </div>
          </div>
        </div>
      </section>

      <!-- CENTER: Content Viewer -->
      <section class="content-viewer" *ngIf="selectedNode">

        <!-- Content Header -->
        <header class="content-header">
          <div class="content-meta">
            <span class="content-type-badge">
              {{ getContentTypeIcon(selectedNode.contentType) }}
              {{ selectedNode.contentType }}
            </span>
            <span class="content-category" *ngIf="selectedNode.metadata?.['category']">
              {{ selectedNode.metadata['category'] }}
            </span>
          </div>

          <h1 class="content-title">{{ selectedNode.title }}</h1>

          <p class="content-description" *ngIf="selectedNode.description">
            {{ selectedNode.description }}
          </p>

          <!-- Affinity Controls -->
          <div class="affinity-controls">
            <div class="affinity-display">
              <span class="affinity-label">Your Affinity:</span>
              <div class="affinity-circle"
                   [class.affinity-unseen]="getAffinityLevel(selectedAffinity) === 'unseen'"
                   [class.affinity-low]="getAffinityLevel(selectedAffinity) === 'low'"
                   [class.affinity-medium]="getAffinityLevel(selectedAffinity) === 'medium'"
                   [class.affinity-high]="getAffinityLevel(selectedAffinity) === 'high'">
                {{ getAffinityPercentage(selectedAffinity) }}%
              </div>
            </div>
            <div class="affinity-buttons">
              <button (click)="adjustAffinity(-0.1)"
                      [disabled]="selectedAffinity <= 0"
                      class="affinity-btn decrease">
                ‚àí
              </button>
              <button (click)="adjustAffinity(0.1)"
                      [disabled]="selectedAffinity >= 1"
                      class="affinity-btn increase">
                +
              </button>
            </div>
          </div>
        </header>

        <!-- Content Body -->
        <article class="content-body">
          <!-- Markdown Content -->
          <div *ngIf="selectedNode.contentFormat === 'markdown'"
               class="markdown-content"
               [innerHTML]="renderMarkdown(selectedNode.content)">
          </div>

          <!-- Gherkin Content -->
          <div *ngIf="selectedNode.contentFormat === 'gherkin'"
               class="gherkin-content"
               [innerHTML]="renderGherkin(selectedNode.content)">
          </div>

          <!-- Plain Text Content -->
          <div *ngIf="selectedNode.contentFormat === 'plaintext'"
               class="plaintext-content">
            {{ selectedNode.content }}
          </div>
        </article>

        <!-- Content Footer: Navigation -->
        <footer class="content-footer">
          <button class="nav-btn prev"
                  (click)="goToPrevious()"
                  [disabled]="!hasPrevious()">
            ‚Üê Previous
          </button>

          <div class="footer-info">
            <span class="node-position">
              {{ pathNodes.findIndex(pn => pn.node.id === selectedNode?.id) + 1 }} of {{ pathNodes.length }}
            </span>
          </div>

          <button class="nav-btn next"
                  (click)="goToNext()"
                  [disabled]="!hasNext()">
            Next ‚Üí
          </button>
        </footer>
      </section>

    </main>
  </div>
</div>
