<div class="path-player-container focused-view-container"
     [class.sidebar-collapsed]="!sidebarOpen"
     [class.focused-view-active]="isFocusedView">

  <!-- PATH TOOLING: Mobile Toggle -->
  <button class="sidebar-toggle" (click)="toggleSidebar()" aria-label="Toggle Navigation" [hidden]="isFocusedView">
    <span class="icon">{{ sidebarOpen ? '‚úï' : '‚ò∞' }}</span>
  </button>

  <!-- Mobile Sidebar Backdrop - click to dismiss -->
  @if (sidebarOpen) {
    <div class="sidebar-backdrop" (click)="toggleSidebar()" (keydown.escape)="toggleSidebar()" tabindex="-1"></div>
  }

  <!-- PATH TOOLING: Sidebar (Lesson-focused) -->
  <aside class="path-sidebar">
    <div class="sidebar-header">
      <a [routerLink]="['/lamad/path', pathId]" class="back-link">
        <span class="icon">‚Üê</span> Back to Overview
      </a>

      <!-- Lesson/Module Title -->
      @if (lessonContext) {
        <div class="lesson-title-wrapper">
          <span class="lesson-context">{{ getCurrentChapterTitle() }}</span>
          <h2 class="lesson-title">{{ getCurrentModuleTitle() }}</h2>
          <span class="lesson-section">{{ getCurrentSectionTitle() }}</span>
        </div>
        <div class="lesson-progress">
          <div class="lesson-progress-bar">
            <div class="lesson-progress-fill" [style.width.%]="getLessonProgressPercentage()"></div>
          </div>
          <span class="lesson-progress-text">{{ lessonContext.currentConceptIndex + 1 }} / {{ lessonContext.concepts.length }}</span>
        </div>
      } @else {
        <div class="path-title-wrapper">
          <h2 class="path-title">{{ path?.title }}</h2>
          <span class="path-progress-text">{{ getProgressPercentage() }}%</span>
        </div>
      }
    </div>

    <nav class="sidebar-nav" aria-label="Lesson navigation">
      <!-- Lesson Concepts (focused view) -->
      @if (lessonContext && lessonContext.concepts.length > 0) {
        <ul class="concept-list">
          @for (concept of lessonContext.concepts; track concept.conceptId) {
            <li class="concept-item"
                [class.current]="concept.isCurrent"
                [class.completed]="concept.isCompleted">
              <a (click)="goToConcept(concept.index)"
                 (keydown.enter)="goToConcept(concept.index)"
                 role="link"
                 tabindex="0">
                <span class="status-icon">
                  @if (concept.isCompleted) {
                    <span class="checkmark">‚úì</span>
                  } @else if (concept.isCurrent) {
                    <span class="current-indicator">‚ñ∂</span>
                  } @else {
                    <span class="circle">‚óã</span>
                  }
                </span>
                <span class="concept-icon">üí°</span>
                <span class="concept-label">{{ concept.title }}</span>
              </a>
            </li>
          }
        </ul>
      }
    </nav>

    <!-- Desktop collapse toggle -->
    <button class="sidebar-collapse-btn" (click)="toggleSidebar()" aria-label="Collapse sidebar">
      <span class="collapse-icon">¬´</span>
    </button>
  </aside>

  <!-- Desktop expand toggle (shown when collapsed) -->
  <button
    class="sidebar-expand-btn"
    *ngIf="!sidebarOpen"
    (click)="toggleSidebar()"
    aria-label="Expand sidebar">
    <span class="expand-icon">¬ª</span>
  </button>

  <!-- MAIN CONTENT AREA -->
  <main class="main-content" id="main-content">
    
    <!-- Loading State -->
    @if (isLoading) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading journey...</p>
      </div>
    }

    <!-- Error State -->
    @if (error) {
      <div class="error-state">
        <h2>Unable to load step</h2>
        <p>{{ error }}</p>
        <button class="btn btn-primary" (click)="goToPathOverview()">
          Back to Path Overview
        </button>
      </div>
    }

    <!-- Content -->
    @if (!isLoading && !error && stepView) {

      <!-- PATH TOOLING: Breadcrumbs (Chapter > Module > Section > Concept) -->
      <nav class="breadcrumbs main-breadcrumbs" aria-label="Breadcrumb navigation">
        <div class="breadcrumb-trail">
          <a routerLink="/lamad">Territory</a>
          <span class="separator">/</span>
          <a [routerLink]="['/lamad/path', pathId]">{{ path?.title }}</a>
          @if (lessonContext) {
            <span class="separator">/</span>
            <span class="crumb">{{ lessonContext.chapter.title }}</span>
            <span class="separator">/</span>
            <span class="crumb">{{ lessonContext.module.title }}</span>
            <span class="separator">/</span>
            <span class="crumb">{{ lessonContext.section.title }}</span>
          }
          <span class="separator">/</span>
          <span class="crumb current">{{ stepView.step.stepTitle }}</span>
        </div>
        <app-focused-view-toggle
          [isActive]="isFocusedView"
          (toggled)="onFocusedViewToggle($event)">
        </app-focused-view-toggle>
      </nav>

      <div class="content-scroll-container">

        <!-- PATH TOOLING: Step context from the Journey -->
        <header class="path-content-header">
          <div class="path-content-header-inner">
            <div class="content-meta">
              <span class="content-type-badge">{{ stepView.content.contentType }}</span>
              <a [routerLink]="['/lamad/resource', stepView.content.id]" class="view-resource-link">
                View Resource Details <span class="icon">&#8599;</span>
              </a>
            </div>
            <h1 class="content-title">{{ stepView.step.stepTitle }}</h1>
            @if (stepView.step.stepNarrative) {
              <p class="step-narrative">{{ stepView.step.stepNarrative }}</p>
            }
          </div>
        </header>

        <!-- CONTENT: Rendered via LessonViewComponent with exploration panel -->
        <article class="content">
          <div class="content-inner">
            @if (stepView.nestedPath) {
              <div class="nested-path-card">
                <h3>Sub-Journey: {{ stepView.nestedPath.title }}</h3>
                <p>{{ stepView.nestedPath.description }}</p>
                <div class="nested-path-meta">
                  <span class="badge">{{ stepView.nestedPath.steps.length }} Steps</span>
                  <span class="badge">{{ stepView.nestedPath.estimatedDuration }}</span>
                </div>
                <button class="btn btn-primary" [routerLink]="['/lamad/path', stepView.nestedPath.id]">
                  Start Sub-Journey
                </button>
              </div>
            } @else if (stepView.content) {
              <!-- Lesson View with exploration affordances -->
              <app-lesson-view
                [content]="stepView.content"
                [pathContext]="buildPathContext()"
                [refreshKey]="contentRefreshKey"
                explorationMode="path"
                (exploreContent)="onExploreContent($event)"
                (exploreInGraph)="onExploreInGraph()"
                (complete)="onLessonComplete($event)">
              </app-lesson-view>
            }

            <!-- Learning Objectives -->
            @if (stepView.step.learningObjectives && stepView.step.learningObjectives.length > 0) {
              <div class="learning-objectives">
                <h3><strong>Goals:</strong></h3>
                <ul>
                  @for (objective of stepView.step.learningObjectives; track objective) {
                    <li>{{ objective }}</li>
                  }
                </ul>
              </div>
            }

            <!-- Reflection Prompts -->
            @if (stepView.step.reflectionPrompts && stepView.step.reflectionPrompts.length > 0) {
              <section class="reflection-prompts">
                <h3>Reflection</h3>
                <ul>
                  @for (prompt of stepView.step.reflectionPrompts; track prompt) {
                    <li>{{ prompt }}</li>
                  }
                </ul>
              </section>
            }
          </div>
        </article>

        <!-- PATH TOOLING: Mastery tracking and step navigation -->
        <footer class="path-content-footer">
          <div class="path-content-footer-inner">
            <!-- Completion Action -->
            <div class="step-actions">
              <button class="btn btn-bloom"
                      [ngClass]="'bloom-' + currentBloomLevel"
                      (click)="markComplete()">
                <span class="bloom-content">
                  <span class="bloom-icon">
                    @if (currentBloomLevel === 'not_started') { ‚≠ï }
                    @else if (currentBloomLevel === 'create') { üåü }
                    @else { üå± }
                  </span>
                  <span class="bloom-text">
                    @if (currentBloomLevel === 'not_started') {
                      Mark as Started
                    } @else {
                      Mastery Level: <strong>{{ getBloomDisplay() }}</strong>
                    }
                  </span>
                </span>
                <span class="bloom-hint" *ngIf="currentBloomLevel !== 'create'">Tap to advance</span>
              </button>
            </div>

            <!-- Navigation -->
            <nav class="step-navigation" aria-label="Step navigation">
              <button
                class="btn btn-nav btn-prev"
                [disabled]="!stepView.hasPrevious"
                (click)="goToPrevious()"
              >
                <span class="icon">&#8592;</span>
                Previous
              </button>

              <button
                class="btn btn-nav btn-next"
                [disabled]="!stepView.hasNext"
                (click)="goToNext()"
              >
                Next
                <span class="icon">&#8594;</span>
              </button>
            </nav>
          </div>
        </footer>
      </div>
    }
  </main>
</div>
