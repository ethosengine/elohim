<div class="path-overview">
  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading path...</p>
    </div>
  }

  <!-- Error State -->
  @if (error) {
    <div class="error-state">
      <h2>Unable to load path</h2>
      <p>{{ error }}</p>
      <button class="btn btn-primary" (click)="goHome()">
        Back to Home
      </button>
    </div>
  }

  <!-- Path Content -->
  @if (!isLoading && !error && path) {
    <!-- Back Navigation -->
    <nav class="back-nav">
      <button class="btn-back" (click)="goHome()">
        <span class="icon">&#8592;</span>
        All Paths
      </button>
    </nav>

    <!-- Path Header -->
    <div class="path-header">
      <div class="path-header-content">
        <div class="path-meta">
          <span class="difficulty-badge" [class]="path.difficulty || 'beginner'">
            {{ getDifficultyDisplay() }}
          </span>
          <span class="duration" *ngIf="path.estimatedDuration">
            ‚è± {{ path.estimatedDuration }}
          </span>
        </div>

        <h1 class="path-title">{{ path.title }}</h1>
        <p class="path-description">{{ path.description }}</p>

        <div class="path-purpose" *ngIf="path.purpose">
          <strong>Goal:</strong> {{ path.purpose }}
        </div>

        <div class="path-tags" *ngIf="path.tags && path.tags.length > 0">
          <span *ngFor="let tag of path.tags" class="tag">#{{ tag }}</span>
        </div>
      </div>

      <div class="path-thumbnail-container">
        <img [src]="path.thumbnailUrl || 'assets/lamad-data/images/path-placeholder.svg'"
             [alt]="path.thumbnailAlt || path.title"
             class="path-thumbnail-image"
             (error)="onImageError($event)">
      </div>
    </div>

    <!-- Main Grid Layout -->
    <div class="overview-main">
      <!-- Territory Mastery Progress -->
      <section class="progress-section">
        <div class="progress-header">
          <h2>Territory Mastery</h2>
          <span class="progress-percent">{{ getCompletionPercentage() }}%</span>
        </div>

        <div class="territory-bar">
          <!-- Mastered Here -->
          <div class="bar-segment mastered-here" 
               [style.width.%]="pathCompletion?.stepCompletionPercentage"
               title="Mastered in this journey"></div>
          <!-- Mastered Elsewhere -->
          <div class="bar-segment mastered-elsewhere" 
               [style.width.%]="(pathCompletion?.contentCompletionPercentage - pathCompletion?.stepCompletionPercentage)"
               title="Mastered in other journeys"></div>
        </div>
        
        <div class="shared-mastery-note" *ngIf="pathCompletion?.sharedContentCompleted > 0">
          <span class="checkmark-green">‚úì</span>
          {{ pathCompletion.sharedContentCompleted }} concepts mastered in other paths!
        </div>
      </section>

      <!-- Chapter View -->
      @if (chapters.length > 0) {
        <div class="chapter-list">
          @for (item of chapters; track item.chapter.id) {
            <div class="chapter-card">
              <div class="chapter-header">
                <h3>{{ item.chapter.title }}</h3>
                <span class="chapter-meta">{{ item.metrics.completedSteps }}/{{ item.metrics.totalSteps }} Steps</span>
              </div>
              
              <!-- Progress Bar per Chapter -->
              <div class="chapter-bar-container">
                <div class="chapter-bar-fill" [style.width.%]="item.metrics.contentCompletionPercentage"></div>
              </div>

              <!-- Chapter Steps -->
              <ul class="chapter-step-list">
                @for (s of item.steps; track s.step.order) {
                  <li class="chapter-step-item"
                      [class.completed]="s.isCompleted"
                      [class.global-complete]="s.isGlobalCompletion"
                      [class.locked]="s.isLocked"
                      (click)="!s.isLocked ? goToStep(s.step.order) : null"
                      (keydown.enter)="!s.isLocked ? goToStep(s.step.order) : null"
                      [attr.role]="s.isLocked ? null : 'button'"
                      [attr.tabindex]="s.isLocked ? -1 : 0">
                    <span class="step-status-icon">
                      @if (s.isCompleted) {
                        <span class="checkmark">‚úì</span>
                      } @else if (s.isGlobalCompletion) {
                        <span class="checkmark global" title="Mastered in another journey">‚úì</span>
                      } @else if (s.isLocked) {
                        <span class="lock">üîí</span>
                      } @else {
                        <span class="circle">‚óã</span>
                      }
                    </span>
                    <span class="step-icon">{{ s.icon }}</span>
                    <span class="step-name">{{ s.step.stepTitle }}</span>
                  </li>
                }
              </ul>

              <div class="chapter-actions">
                <button class="btn btn-sm btn-secondary" (click)="startChapter(item.chapter.id)">
                  {{ item.metrics.completedSteps > 0 ? 'Continue' : 'Start' }} Chapter
                </button>
              </div>
            </div>
          }
        </div>
      } 
      <!-- Flat List Fallback -->
      @else {
        <ol class="steps-list">
          @for (s of flatSteps; track s.step.order) {
            <li
              class="step-item"
              [class.completed]="s.isCompleted"
              [class.global-complete]="s.isGlobalCompletion"
              [class.locked]="s.isLocked"
              [class.accessible]="!s.isLocked"
              (click)="!s.isLocked ? goToStep(s.step.order) : null"
              (keydown.enter)="!s.isLocked ? goToStep(s.step.order) : null"
              [attr.role]="s.isLocked ? null : 'button'"
              [attr.tabindex]="s.isLocked ? -1 : 0"
            >
              <div class="step-indicator">
                @if (s.isCompleted) {
                  <span class="checkmark">&#10003;</span>
                } @else if (s.isGlobalCompletion) {
                  <span class="checkmark global" title="Mastered in another journey">‚úì</span>
                } @else if (s.isLocked) {
                  <span class="lock">&#128274;</span>
                } @else {
                  <span class="number">{{ s.step.order + 1 }}</span>
                }
              </div>

              <div class="step-content">
                <div class="step-header-row">
                  <span class="step-icon">{{ s.icon }}</span>
                  <h3 class="step-title">{{ s.step.stepTitle }}</h3>
                </div>
                @if (!s.isLocked && s.step.stepNarrative) {
                  <p class="step-narrative">{{ s.step.stepNarrative }}</p>
                }
                @if (s.isLocked) {
                  <p class="step-locked-message">Complete previous steps to unlock</p>
                }
              </div>

              @if (!s.isLocked && !s.isCompleted) {
                <span class="step-arrow">&#8594;</span>
              }
            </li>
          }
        </ol>
      }
    </div>

    <div class="overview-sidebar">
      <!-- Action Buttons -->
      <section class="action-section">
        <div *ngIf="isCompleted()" class="completed-message">
          <span class="checkmark">&#10003;</span>
          Path Completed!
        </div>

        <button *ngIf="hasStarted() && !isCompleted()" class="btn btn-primary btn-large" (click)="continueJourney()">
          Continue Journey
        </button>

        <button *ngIf="!hasStarted()" class="btn btn-primary btn-large" (click)="beginJourney()">
          Begin Journey
        </button>

        <button class="btn btn-secondary" (click)="goHome()">Back to All Paths</button>

        <a [routerLink]="['/lamad/resource', 'path-' + pathId]" class="view-resource-link">
          <span class="icon">‚Üó</span> View as Content
        </a>
      </section>

      <!-- Concept Mastery Chips -->
      @if (conceptProgress.length > 0) {
        <section class="concepts-section">
          <h3>Concept Mastery</h3>
          <div class="concepts-grid">
            @for (concept of conceptProgress; track concept.conceptId) {
              <div class="concept-chip" [class.mastered]="concept.completionPercentage === 100">
                <div class="concept-header">
                  <span class="concept-title">{{ concept.title }}</span>
                  <span class="concept-stats">{{ concept.completedSteps }}/{{ concept.totalSteps }}</span>
                </div>
                <div class="concept-bar">
                  <div class="concept-bar-fill" [style.width.%]="concept.completionPercentage"></div>
                </div>
              </div>
            }
          </div>
        </section>
      }
    </div>



    <!-- Path Metadata Footer -->
    <footer class="path-footer">
      <div class="meta-item">
        <span class="meta-label">Created by</span>
        <span class="meta-value">{{ path.createdBy }}</span>
      </div>
      @if (path.attestationsGranted && path.attestationsGranted.length > 0) {
        <div class="meta-item">
          <span class="meta-label">Attestations</span>
          <span class="meta-value">{{ path.attestationsGranted.join(', ') }}</span>
        </div>
      }
    </footer>
  }
</div>
