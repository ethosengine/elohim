<div class="path-overview">
  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading path...</p>
    </div>
  }

  <!-- Error State -->
  @if (error) {
    <div class="error-state">
      <h2>Unable to load path</h2>
      <p>{{ error }}</p>
      <button type="button" class="btn btn-primary" (click)="goHome()">Back to Home</button>
    </div>
  }

  <!-- Path Content -->
  @if (!isLoading && !error && path) {
    <!-- Back Navigation -->
    <nav class="back-nav">
      <button type="button" class="btn-back" (click)="goHome()">
        <span class="icon">&#8592;</span>
        All Paths
      </button>
    </nav>

    <!-- Path Header -->
    <div class="path-header">
      <div class="path-header-content">
        <div class="path-meta">
          <span class="difficulty-badge" [ngClass]="path.difficulty || 'beginner'">
            {{ getDifficultyDisplay() }}
          </span>
          <span class="duration" *ngIf="path.estimatedDuration">
            ‚è± {{ path.estimatedDuration }}
          </span>
        </div>

        <h1 class="path-title">{{ path.title }}</h1>
        <p class="path-description">{{ path.description }}</p>

        <div class="path-purpose" *ngIf="path.purpose">
          <strong>Goal:</strong>
          {{ path.purpose }}
        </div>

        <div class="path-tags" *ngIf="path.tags && path.tags.length > 0">
          <span *ngFor="let tag of path.tags" class="tag">#{{ tag }}</span>
        </div>
      </div>

      <div class="path-thumbnail-container">
        <img
          [src]="path.thumbnailUrl || 'assets/images/path-placeholder.svg'"
          [alt]="path.thumbnailAlt || path.title"
          class="path-thumbnail-image"
          (error)="onImageError($event)"
        />
      </div>
    </div>

    <!-- Main Grid Layout -->
    <div class="overview-main">
      <!-- Territory Mastery Progress -->
      <section class="progress-section">
        <div class="progress-header">
          <h2>Territory Mastery</h2>
          <span class="progress-percent">{{ getCompletionPercentage() }}%</span>
        </div>

        <div class="territory-bar">
          <!-- Mastered Here -->
          <div
            class="bar-segment mastered-here"
            [style.width.%]="pathCompletion?.stepCompletionPercentage"
            title="Mastered in this journey"
          ></div>
          <!-- Mastered Elsewhere -->
          <div
            class="bar-segment mastered-elsewhere"
            [style.width.%]="
              (pathCompletion?.contentCompletionPercentage ?? 0) -
              (pathCompletion?.stepCompletionPercentage ?? 0)
            "
            title="Mastered in other journeys"
          ></div>
        </div>

        <div class="shared-mastery-note" *ngIf="(pathCompletion?.sharedContentCompleted ?? 0) > 0">
          <span class="checkmark-green">‚úì</span>
          {{ pathCompletion!.sharedContentCompleted }} concepts mastered in other paths!
        </div>
      </section>

      <!-- Chapter View (Hierarchical: Chapter ‚Üí Module ‚Üí Section ‚Üí Concepts) -->
      @if (chapters.length > 0) {
        <div class="chapter-list">
          @for (item of chapters; track item.chapter.id; let chapterIdx = $index) {
            <div class="chapter-card">
              <!-- Chapter Header -->
              <div class="chapter-header">
                <div class="chapter-header-left">
                  <span class="chapter-number">Chapter {{ chapterIdx + 1 }}</span>
                  <h3>{{ item.chapter.title }}</h3>
                  @if (item.chapter.optional) {
                    <span class="optional-badge">Optional</span>
                  }
                </div>
                <div class="chapter-header-right">
                  @if (item.chapter.attestationGranted) {
                    <span class="attestation-badge" title="Earn attestation on completion">
                      üèÜ {{ item.chapter.attestationGranted }}
                    </span>
                  }
                  @if (item.chapter.estimatedDuration) {
                    <span class="duration-badge">‚è± {{ item.chapter.estimatedDuration }}</span>
                  }
                  <span class="chapter-meta">
                    {{ item.completedConcepts }}/{{ item.totalConcepts }}
                  </span>
                  <span class="chapter-percent">{{ item.completionPercentage }}%</span>
                </div>
              </div>

              <!-- Chapter Progress Bar -->
              <div class="chapter-bar-container">
                <div class="chapter-bar-fill" [style.width.%]="item.completionPercentage"></div>
              </div>

              <!-- Chapter Body -->
              <div class="chapter-body">
                @if (item.chapter.description) {
                  <p class="chapter-description">{{ item.chapter.description }}</p>
                }

                <!-- Modules -->
                <div class="chapter-modules">
                  @for (mod of item.modules; track mod.module.id; let modIdx = $index) {
                    <div class="module-card">
                      <!-- Module Header -->
                      <div class="module-header">
                        <div class="module-header-left">
                          <h4 class="module-title">{{ modIdx + 1 }}. {{ mod.module.title }}</h4>
                          @if (mod.module.optional) {
                            <span class="optional-badge small">Optional</span>
                          }
                        </div>
                        <div class="module-header-right">
                          @if (mod.module.estimatedDuration) {
                            <span class="duration-badge small">
                              {{ mod.module.estimatedDuration }}
                            </span>
                          }
                          <span class="module-meta">
                            {{ mod.completedConcepts }}/{{ mod.totalConcepts }}
                          </span>
                        </div>
                      </div>

                      <!-- Module Progress Bar -->
                      <div class="module-bar-container">
                        <div
                          class="module-bar-fill"
                          [style.width.%]="mod.completionPercentage"
                        ></div>
                      </div>

                      <!-- Module Body -->
                      <div class="module-body">
                        @if (mod.module.description) {
                          <p class="module-description">{{ mod.module.description }}</p>
                        }

                        <!-- Learning Objectives -->
                        @if (
                          mod.module.learningObjectives && mod.module.learningObjectives.length > 0
                        ) {
                          <div class="learning-objectives">
                            <span class="objectives-label">üéØ Learning Objectives:</span>
                            <ul class="objectives-list">
                              @for (objective of mod.module.learningObjectives; track objective) {
                                <li>{{ objective }}</li>
                              }
                            </ul>
                          </div>
                        }

                        <!-- Sections -->
                        <div class="module-sections">
                          @for (sec of mod.sections; track sec.section.id; let secIdx = $index) {
                            <div class="section-card">
                              <!-- Section Header - clickable link to lesson view -->
                              <button
                                type="button"
                                class="section-header section-link"
                                (click)="goToSection(sec.concepts.at(0)?.conceptId)"
                              >
                                <div class="section-header-left">
                                  <h5 class="section-title">{{ sec.section.title }}</h5>
                                  @if (sec.section.optional) {
                                    <span class="optional-badge tiny">Optional</span>
                                  }
                                </div>
                                <div class="section-header-right">
                                  @if (sec.section.estimatedDuration) {
                                    <span class="duration-badge tiny">
                                      {{ sec.section.estimatedDuration }}
                                    </span>
                                  }
                                  <span class="section-meta">
                                    {{ sec.completedConcepts }}/{{ sec.totalConcepts }}
                                  </span>
                                  <!-- Mini progress indicator -->
                                  <div class="section-mini-progress">
                                    <div
                                      class="section-mini-fill"
                                      [style.width.%]="sec.completionPercentage"
                                    ></div>
                                  </div>
                                  <span class="section-arrow">‚Üí</span>
                                </div>
                              </button>

                              <!-- Section Body - concept list -->
                              <div class="section-body">
                                @if (sec.section.description) {
                                  <p class="section-description">{{ sec.section.description }}</p>
                                }

                                <!-- Concepts -->
                                @if (sec.concepts.length > 0) {
                                  <ul class="concept-list">
                                    @for (
                                      concept of sec.concepts;
                                      track concept.conceptId || $index
                                    ) {
                                      <li>
                                        <button
                                          type="button"
                                          class="concept-item"
                                          [ngClass]="{
                                            completed: concept.isCompleted,
                                            'global-complete': concept.isGlobalCompletion,
                                          }"
                                          (click)="goToConcept(concept.conceptId)"
                                        >
                                          <span class="concept-status-icon">
                                            @if (concept.isCompleted) {
                                              <span class="checkmark">‚úì</span>
                                            } @else if (concept.isGlobalCompletion) {
                                              <span
                                                class="checkmark global"
                                                title="Mastered in another journey"
                                              >
                                                ‚úì
                                              </span>
                                            } @else {
                                              <span class="circle">‚óã</span>
                                            }
                                          </span>
                                          <span class="concept-icon">{{ concept.icon }}</span>
                                          <span class="concept-name">{{ concept.title }}</span>
                                          @if (concept.contentType) {
                                            <span class="content-type-tag">
                                              {{ concept.contentType }}
                                            </span>
                                          }
                                        </button>
                                      </li>
                                    }
                                  </ul>
                                }
                              </div>
                            </div>
                          }
                        </div>
                      </div>
                    </div>
                  }
                </div>

                <div class="chapter-actions">
                  <button
                    type="button"
                    class="btn btn-sm btn-secondary"
                    (click)="startChapter(item.chapter.id)"
                  >
                    {{ item.completedConcepts > 0 ? 'Continue' : 'Start' }} Chapter
                  </button>
                </div>
              </div>
            </div>
          }
        </div>
      }
      <!-- Flat List Fallback -->
      @else {
        <ol class="steps-list">
          @for (s of flatSteps; track s.step.order) {
            <li
              class="step-item"
              [ngClass]="getStepClasses(s)"
              (click)="!s.isLocked ? goToStep(s.step.order) : null"
              (keydown.enter)="!s.isLocked ? goToStep(s.step.order) : null"
              [attr.role]="s.isLocked ? null : 'button'"
              [attr.tabindex]="s.isLocked ? -1 : 0"
            >
              <div class="step-indicator">
                @if (s.isCompleted) {
                  <span class="checkmark">‚úì</span>
                } @else if (s.isGlobalCompletion) {
                  <span class="checkmark global" title="Mastered in another journey">‚úì</span>
                } @else if (s.isLocked) {
                  <span class="lock">üîí</span>
                } @else {
                  <span class="number">{{ s.step.order + 1 }}</span>
                }
              </div>

              <div class="step-content">
                <div class="step-header-row">
                  <span class="step-icon">{{ s.icon }}</span>
                  <h3 class="step-title">{{ s.step.stepTitle }}</h3>
                  @if (s.masteryTier !== 'unseen') {
                    <span
                      class="mastery-badge"
                      [ngClass]="getMasteryTierClass(s.masteryTier)"
                      [title]="getMasteryTierLabel(s.masteryTier)"
                    >
                      {{ getMasteryTierIcon(s.masteryTier) }}
                      {{ getMasteryTierLabel(s.masteryTier) }}
                    </span>
                  }
                </div>
                @if (!s.isLocked && s.step.stepNarrative) {
                  <p class="step-narrative">{{ s.step.stepNarrative }}</p>
                }
                @if (s.isLocked) {
                  <p class="step-locked-message">Complete previous steps to unlock</p>
                }
              </div>

              @if (!s.isLocked && !s.isCompleted) {
                <span class="step-arrow">&#8594;</span>
              }
            </li>
          }
        </ol>
      }
    </div>

    <div class="overview-sidebar">
      <!-- Action Buttons -->
      <section class="action-section">
        <div *ngIf="isCompleted()" class="completed-message">
          <span class="checkmark">‚úì</span>
          Path Completed!
        </div>

        <button
          type="button"
          *ngIf="hasStarted() && !isCompleted()"
          class="btn btn-primary btn-large"
          (click)="continueJourney()"
        >
          Continue Journey
        </button>

        <button
          type="button"
          *ngIf="!hasStarted()"
          class="btn btn-primary btn-large"
          (click)="beginJourney()"
        >
          Begin Journey
        </button>

        <button type="button" class="btn btn-secondary" (click)="goHome()">
          Back to All Paths
        </button>

        <a [routerLink]="['/lamad/resource', 'path-' + pathId]" class="view-resource-link">
          <span class="icon">‚Üó</span>
          View as Content
        </a>
      </section>

      <!-- Concept Mastery Chips -->
      @if (conceptProgress.length > 0) {
        <section class="concepts-section">
          <h3>Concept Mastery</h3>
          <div class="concepts-grid">
            @for (concept of conceptProgress; track concept.conceptId || $index) {
              <div class="concept-chip" [class.mastered]="concept.completionPercentage === 100">
                <div class="concept-header">
                  <span class="concept-title">{{ concept.title }}</span>
                  <span class="concept-stats">
                    {{ concept.completedSteps }}/{{ concept.totalSteps }}
                  </span>
                </div>
                <div class="concept-bar">
                  <div
                    class="concept-bar-fill"
                    [style.width.%]="concept.completionPercentage"
                  ></div>
                </div>
              </div>
            }
          </div>
        </section>
      }
    </div>

    <!-- Path Metadata Footer -->
    <footer class="path-footer">
      <div class="meta-item">
        <span class="meta-label">Created by</span>
        <span class="meta-value">{{ path.createdBy }}</span>
      </div>
      @if (path.attestationsGranted && path.attestationsGranted.length > 0) {
        <div class="meta-item">
          <span class="meta-label">Attestations</span>
          <span class="meta-value">{{ path.attestationsGranted.join(', ') }}</span>
        </div>
      }
    </footer>
  }
</div>
