<div
  class="content-viewer-container focused-view-container"
  [class.focused-view-active]="isFocusedView"
>
  <!-- Loading state -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading content...</p>
  </div>

  <!-- Error state -->
  <div *ngIf="error && !isLoading" class="error-state">
    <h2>‚ö†Ô∏è {{ error }}</h2>
    <button class="btn-primary" (click)="backToHome()">Back to Lamad</button>
  </div>

  <!-- Content -->
  <div *ngIf="node && !isLoading" class="content">
    <!-- Header -->
    <div class="content-header">
      <div class="header-nav">
        <button class="back-button" (click)="backToHome()">‚Üê Back to Lamad</button>

        <!-- Return to Path button (shown when viewing from a detour) -->
        <button *ngIf="hasReturnPath" class="return-to-path-btn" (click)="returnToPath()">
          ‚Üê Return to {{ pathContext?.pathTitle }}
        </button>
      </div>

      <div class="header-main">
        <div class="content-type-badge">
          <span class="type-icon">{{ getContentTypeIcon() }}</span>
          <span class="type-label">{{ getContentTypeDisplay() }}</span>
        </div>

        <h1 class="content-title">{{ node.title }}</h1>
        <p class="content-description">{{ node.description }}</p>

        <div class="content-meta">
          <span *ngIf="getMetadataCategory()" class="meta-item">
            üìÅ {{ getMetadataCategory() }}
          </span>
          <span *ngIf="getMetadataAuthors()" class="meta-item">‚úçÔ∏è {{ getMetadataAuthors() }}</span>
          <span *ngIf="getMetadataVersion()" class="meta-item">üè∑Ô∏è v{{ getMetadataVersion() }}</span>
        </div>

        <div class="tags" *ngIf="node.tags.length > 0">
          <span *ngFor="let tag of node.tags" class="tag">#{{ tag }}</span>
        </div>

        <!-- Content actions -->
        <div class="content-actions">
          <app-content-download [node]="node"></app-content-download>
          <a
            *ngIf="canEditContent"
            [routerLink]="['/lamad/resource', node.id, 'edit']"
            class="btn-edit"
          >
            ‚úèÔ∏è Edit
          </a>
        </div>
      </div>

      <!-- Affinity controls -->
      <div class="affinity-panel">
        <div class="affinity-display">
          <div class="affinity-circle" [ngClass]="'affinity-' + getAffinityLevel()">
            {{ getAffinityPercentage() }}%
          </div>
          <div class="affinity-label">Your Affinity</div>
        </div>

        <div class="affinity-controls">
          <button class="btn-affinity" (click)="adjustAffinity(-0.1)" [disabled]="affinity <= 0">
            - Decrease
          </button>
          <button class="btn-affinity" (click)="adjustAffinity(0.1)" [disabled]="affinity >= 1">
            + Increase
          </button>
        </div>

        <div class="quick-actions">
          <button
            class="btn-quick"
            (click)="setAffinity(0.5)"
            [ngClass]="{ active: affinity >= 0.4 && affinity <= 0.6 }"
          >
            üìö Practicing
          </button>
          <button
            class="btn-quick"
            (click)="setAffinity(1.0)"
            [ngClass]="{ active: affinity > 0.9 }"
          >
            ‚úÖ Mastered
          </button>
        </div>

        <div class="affinity-bar">
          <div
            class="affinity-bar-fill"
            [style.width.%]="getAffinityPercentage()"
            [ngClass]="'affinity-' + getAffinityLevel()"
          ></div>
        </div>
      </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="viewer-tabs">
      <button
        class="tab-btn"
        (click)="setActiveTab('content')"
        [class.active]="activeTab === 'content'"
      >
        Content
      </button>
      <button
        class="tab-btn"
        (click)="setActiveTab('trust')"
        [class.active]="activeTab === 'trust'"
      >
        Attestations
      </button>
      <button
        class="tab-btn"
        (click)="setActiveTab('governance')"
        [class.active]="activeTab === 'governance'"
      >
        Governance
      </button>
      <button
        class="tab-btn"
        (click)="setActiveTab('network')"
        [class.active]="activeTab === 'network'"
      >
        Network
      </button>
    </div>

    <!-- Tab Content -->
    <div [ngSwitch]="activeTab" class="tab-content">
      <!-- Content Toolbar (fixed at top in focused view) -->
      <div class="content-toolbar">
        <app-focused-view-toggle
          [isActive]="isFocusedView"
          (toggled)="onFocusedViewToggle($event)"
        ></app-focused-view-toggle>
      </div>

      <!-- Content Tab -->
      <section *ngSwitchCase="'content'">
        <!-- Main content -->
        <div class="content-body">
          <!-- Dynamic renderer host - renders content via registered renderers -->
          <ng-container #rendererHost></ng-container>

          <!-- Fallback: Plain text content (when no renderer registered) -->
          <div
            *ngIf="!hasRegisteredRenderer && node.contentFormat === 'plaintext'"
            class="plaintext-content"
          >
            <pre>{{ getStringContent(node.content) }}</pre>
          </div>

          <!-- Fallback: HTML content (when no renderer registered) -->
          <div
            *ngIf="!hasRegisteredRenderer && node.contentFormat === 'html'"
            class="html-content"
            [innerHTML]="node.content"
          ></div>

          <!-- Fallback: Unknown format -->
          <div
            *ngIf="
              !hasRegisteredRenderer &&
              node.contentFormat !== 'plaintext' &&
              node.contentFormat !== 'html'
            "
            class="fallback-content"
          >
            <p class="fallback-notice">Content format: {{ node.contentFormat }}</p>
            <pre>{{ getStringContent(node.content) }}</pre>
          </div>
        </div>

        <!-- Contextual Feedback Section -->
        <div class="feedback-section" *ngIf="showFeedbackSection && node">
          <h2 class="feedback-section-title">üì£ Share Your Feedback</h2>

          <!-- Reaction Bar (Low Friction) -->
          <div class="reaction-section">
            <app-reaction-bar
              [contentId]="node.id"
              [allowedReactions]="allowedReactions"
              [constraints]="feedbackProfile?.emotionalReactionConstraints"
              [contentType]="mapContentTypeToProfileType(node.contentType)"
              [showCounts]="true"
            ></app-reaction-bar>
          </div>

          <!-- Graduated Feedback (Medium Friction) -->
          <div class="graduated-section">
            <app-graduated-feedback
              [contentId]="node.id"
              [context]="feedbackContext"
              [requiresReasoning]="false"
              [showAggregates]="true"
            ></app-graduated-feedback>
          </div>

          <!-- Signal Summary (when aggregates exist) -->
          <div
            class="signal-summary"
            *ngIf="aggregatedSignals && aggregatedSignals.reactionCounts.total > 0"
          >
            <div class="signal-metric">
              <span class="metric-label">Community Sentiment</span>
              <span
                class="metric-value"
                [ngClass]="{
                  positive: aggregatedSignals.sentimentScore > 0.6,
                  neutral:
                    aggregatedSignals.sentimentScore >= 0.4 &&
                    aggregatedSignals.sentimentScore <= 0.6,
                  negative: aggregatedSignals.sentimentScore < 0.4,
                }"
              >
                {{ aggregatedSignals.sentimentScore * 100 | number: '1.0-0' }}%
              </span>
            </div>
            <div class="signal-metric" *ngIf="aggregatedSignals.effectivenessScore > 0">
              <span class="metric-label">Effectiveness</span>
              <span class="metric-value">
                {{ aggregatedSignals.effectivenessScore * 100 | number: '1.0-0' }}%
              </span>
            </div>
            <div class="signal-metric">
              <span class="metric-label">Consensus</span>
              <span
                class="metric-value consensus-badge"
                [ngClass]="aggregatedSignals.consensusState.level"
              >
                {{ aggregatedSignals.consensusState.level | titlecase }}
              </span>
            </div>
          </div>
        </div>

        <!-- Appears in Paths (Wikipedia-style back-links) -->
        <div *ngIf="containingPaths.length > 0 || loadingPaths" class="paths-section">
          <h2>üìö Appears in Learning Paths</h2>
          <p class="paths-description">
            This content is part of the following curated learning journeys:
          </p>

          <div *ngIf="loadingPaths" class="paths-loading">
            <span class="spinner-small"></span>
            Loading paths...
          </div>

          <div *ngIf="!loadingPaths && containingPaths.length > 0" class="paths-list">
            <button
              *ngFor="let pathRef of containingPaths"
              class="path-card"
              (click)="navigateToPath(pathRef.pathId, pathRef.stepIndex)"
              type="button"
            >
              <div class="path-header">
                <span class="path-icon">üó∫Ô∏è</span>
                <span class="path-title">{{ pathRef.pathTitle }}</span>
              </div>
              <div class="path-meta">
                <span class="path-step">Step {{ pathRef.stepIndex + 1 }}</span>
                <span class="path-action">View in context ‚Üí</span>
              </div>
            </button>
          </div>
        </div>

        <!-- Related content -->
        <div *ngIf="relatedNodes.length > 0" class="related-section">
          <h2>üîó Related Content</h2>
          <div class="related-grid">
            <button
              *ngFor="let relatedNode of relatedNodes"
              class="related-card"
              (click)="viewRelatedContent(relatedNode)"
              (keydown.enter)="viewRelatedContent(relatedNode)"
              type="button"
            >
              <div class="related-header">
                <span class="related-type">{{ relatedNode.contentType }}</span>
                <span class="related-affinity">{{ getRelatedNodeAffinity(relatedNode.id) }}%</span>
              </div>
              <h3 class="related-title">{{ relatedNode.title }}</h3>
              <p class="related-description">{{ relatedNode.description }}</p>
            </button>
          </div>
        </div>
      </section>

      <!-- Trust/Attestations Tab -->
      <section *ngSwitchCase="'trust'">
        <div *ngIf="isLoadingTrust" class="loading-state">
          <div class="spinner"></div>
          <p>Loading trust data...</p>
        </div>

        <div *ngIf="!isLoadingTrust && !trustBadge" class="error-state">
          <p>Unable to load trust information.</p>
        </div>

        <div *ngIf="trustBadge" class="trust-tab-content">
          <!-- Main Trust Card -->
          <div class="trust-summary-card" [class]="'trust-' + trustBadge.trustLevel">
            <div class="trust-header">
              <div class="trust-score">
                <span class="score-val">{{ trustBadge.trustPercentage }}%</span>
                <span class="score-label">Trust Score</span>
              </div>
              <div class="trust-primary-badge">
                <div class="badge-icon large">{{ trustBadge.primary.icon }}</div>
                <div class="badge-details">
                  <h3>{{ trustBadge.primary.label }}</h3>
                  <p>{{ trustBadge.primary.description }}</p>
                  <div class="badge-meta" *ngIf="trustBadge.primary.grantedBy">
                    <span class="grantor">Verified by {{ trustBadge.primary.grantedBy }}</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="trust-reach">
              <strong>Reach Level:</strong>
              {{ trustBadge.reachLabel | titlecase }}
            </div>
          </div>

          <!-- Warnings -->
          <div *ngIf="trustBadge.hasWarnings" class="trust-warnings">
            <h3>‚ö†Ô∏è Content Warnings</h3>
            <div class="warning-list">
              <div *ngFor="let warning of trustBadge.warnings" class="warning-card">
                <span class="warning-icon">{{ warning.icon }}</span>
                <div class="warning-content">
                  <h4>{{ warning.label }}</h4>
                  <p>{{ warning.description }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Secondary Badges -->
          <div class="trust-badges-section" *ngIf="trustBadge.secondary.length > 0">
            <h3>Verified Attributes</h3>
            <div class="badges-grid">
              <div
                *ngFor="let badge of trustBadge.secondary"
                class="badge-card"
                [class]="'badge-' + badge.color"
              >
                <div class="badge-icon">{{ badge.icon }}</div>
                <div class="badge-info">
                  <h4>{{ badge.label }}</h4>
                  <p>{{ badge.description }}</p>
                  <span class="badge-grantor" *ngIf="badge.grantedBy">
                    {{ badge.grantedBy }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="trust-actions" *ngIf="trustBadge.actions?.length">
            <h3>Available Actions</h3>
            <div class="actions-list">
              <button
                *ngFor="let action of trustBadge.actions"
                class="btn-secondary"
                [disabled]="!action.available"
                (click)="handleAction(action)"
              >
                <span class="action-icon">{{ action.icon }}</span>
                {{ action.label }}
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Governance Tab -->
      <section *ngSwitchCase="'governance'" class="governance-tab">
        <div *ngIf="isLoadingGovernance" class="loading-state">
          <div class="spinner"></div>
          <p>Loading governance data...</p>
        </div>

        <div *ngIf="!isLoadingGovernance" class="governance-content">
          <!-- Status Card -->
          <div
            class="governance-status-card"
            [class]="'status-' + (governanceState?.status || 'unreviewed')"
          >
            <div class="status-header">
              <span class="status-icon">{{ getGovernanceStatusIcon() }}</span>
              <h3>{{ getGovernanceStatusLabel() }}</h3>
            </div>
            <div class="status-meta" *ngIf="governanceState">
              <span>Last updated: {{ formatGovernanceDate(governanceState.lastUpdated) }}</span>
            </div>

            <!-- Active Labels -->
            <div class="labels-section" *ngIf="governanceState?.labels?.length">
              <h4>Active Labels</h4>
              <div class="labels-list">
                <ng-container *ngIf="governanceState">
                  <span
                    *ngFor="let label of governanceState.labels"
                    class="label-badge"
                    [class]="'severity-' + label.severity"
                  >
                    {{ label.labelType }}
                  </span>
                </ng-container>
              </div>
            </div>
          </div>

          <!-- Challenges Section -->
          <div class="challenges-section">
            <h3>‚öñÔ∏è Challenges</h3>

            <div *ngIf="challenges.length === 0" class="empty-state">
              <p>No challenges filed against this content.</p>
              <button class="btn-secondary">File a Challenge</button>
            </div>

            <div *ngIf="challenges.length > 0" class="challenges-list">
              <div
                *ngFor="let challenge of challenges"
                class="challenge-card"
                [class]="'status-' + challenge.status"
              >
                <div class="challenge-header">
                  <span class="challenge-grounds">{{ challenge.grounds }}</span>
                  <span class="challenge-status">{{ challenge.status }}</span>
                </div>
                <p class="challenge-description">{{ challenge.description }}</p>
                <div class="challenge-meta">
                  <span>Filed: {{ formatGovernanceDate(challenge.filedAt) }}</span>
                  <span class="sla-indicator" [class]="getSlaStatus(challenge)">
                    SLA: {{ getDaysRemaining(challenge.slaDeadline) }} days remaining
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Discussions Section (Talk Page) -->
          <div class="discussions-section">
            <h3>üí¨ Discussions</h3>

            <div *ngIf="discussions.length === 0" class="empty-state">
              <p>No discussions about this content yet.</p>
              <button class="btn-secondary">Start Discussion</button>
            </div>

            <div *ngIf="discussions.length > 0" class="discussions-list">
              <div *ngFor="let discussion of discussions" class="discussion-card">
                <div class="discussion-header">
                  <span class="discussion-category">{{ discussion.category }}</span>
                  <span class="discussion-status">{{ discussion.status }}</span>
                </div>
                <h4 class="discussion-topic">{{ discussion.title }}</h4>
                <div class="discussion-meta">
                  <span>{{ discussion.messageCount }} messages</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Network Tab -->
      <section *ngSwitchCase="'network'" class="network-tab">
        <div class="network-header">
          <h3>Content Neighborhood</h3>
          <p>Explore related concepts in the knowledge graph</p>
        </div>

        <!-- Mini Graph Visualization -->
        <div class="mini-graph-container">
          <app-mini-graph
            *ngIf="node"
            [focusNodeId]="node.id"
            [depth]="1"
            [maxNodes]="20"
            [height]="350"
            (nodeSelected)="onGraphNodeSelected($event)"
            (exploreRequested)="exploreInGraph()"
          ></app-mini-graph>
        </div>

        <!-- Explore in Full Graph Button -->
        <div class="network-actions">
          <button class="btn-explore-graph" (click)="exploreInGraph()">
            <span class="icon">üî≠</span>
            Explore in Full Graph
          </button>
        </div>
      </section>
    </div>
  </div>
</div>
