<div class="content-viewer-container">
  <!-- Loading state -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading content...</p>
  </div>

  <!-- Error state -->
  <div *ngIf="error && !isLoading" class="error-state">
    <h2>âš ï¸ {{ error }}</h2>
    <button class="btn-primary" (click)="backToHome()">Back to Lamad</button>
  </div>

  <!-- Content -->
  <div *ngIf="node && !isLoading" class="content">
    <!-- Header -->
    <div class="content-header">
      <button
        class="back-button"
        (click)="backToHome()">
        â† Back to Lamad
      </button>

      <div class="header-main">
        <div class="content-type-badge">
          <span class="type-icon">{{ getContentTypeIcon() }}</span>
          <span class="type-label">{{ getContentTypeDisplay() }}</span>
        </div>

        <h1 class="content-title">{{ node.title }}</h1>
        <p class="content-description">{{ node.description }}</p>

        <div class="content-meta">
          <span *ngIf="getMetadataCategory()" class="meta-item">
            ğŸ“ {{ getMetadataCategory() }}
          </span>
          <span *ngIf="getMetadataAuthors()" class="meta-item">
            âœï¸ {{ getMetadataAuthors() }}
          </span>
          <span *ngIf="getMetadataVersion()" class="meta-item">
            ğŸ·ï¸ v{{ getMetadataVersion() }}
          </span>
        </div>

        <div class="tags" *ngIf="node.tags.length > 0">
          <span *ngFor="let tag of node.tags" class="tag">#{{ tag }}</span>
        </div>
      </div>

      <!-- Affinity controls -->
      <div class="affinity-panel">
        <div class="affinity-display">
          <div class="affinity-circle" [ngClass]="'affinity-' + getAffinityLevel()">
            {{ getAffinityPercentage() }}%
          </div>
          <div class="affinity-label">Your Affinity</div>
        </div>

        <div class="affinity-controls">
          <button class="btn-affinity" (click)="adjustAffinity(-0.1)" [disabled]="affinity <= 0">
            - Decrease
          </button>
          <button class="btn-affinity" (click)="adjustAffinity(0.1)" [disabled]="affinity >= 1">
            + Increase
          </button>
        </div>

        <div class="quick-actions">
          <button class="btn-quick" (click)="setAffinity(0.5)" [ngClass]="{'active': affinity >= 0.4 && affinity <= 0.6}">
            ğŸ“š Practicing
          </button>
          <button class="btn-quick" (click)="setAffinity(1.0)" [ngClass]="{'active': affinity > 0.9}">
            âœ… Mastered
          </button>
        </div>

        <div class="affinity-bar">
          <div
            class="affinity-bar-fill"
            [style.width.%]="getAffinityPercentage()"
            [ngClass]="'affinity-' + getAffinityLevel()">
          </div>
        </div>
      </div>
    </div>

    <!-- Main content -->
    <div class="content-body">
      <!-- Dynamic renderer host - renders content via registered renderers -->
      <ng-container #rendererHost></ng-container>

      <!-- Fallback: Plain text content (when no renderer registered) -->
      <div
        *ngIf="!hasRegisteredRenderer && node.contentFormat === 'plaintext'"
        class="plaintext-content">
        <pre>{{ getStringContent(node.content) }}</pre>
      </div>

      <!-- Fallback: HTML content (when no renderer registered) -->
      <div
        *ngIf="!hasRegisteredRenderer && node.contentFormat === 'html'"
        class="html-content"
        [innerHTML]="node.content">
      </div>

      <!-- Fallback: Unknown format -->
      <div
        *ngIf="!hasRegisteredRenderer && node.contentFormat !== 'plaintext' && node.contentFormat !== 'html'"
        class="fallback-content">
        <p class="fallback-notice">Content format: {{ node.contentFormat }}</p>
        <pre>{{ getStringContent(node.content) }}</pre>
      </div>
    </div>

    <!-- Appears in Paths (Wikipedia-style back-links) -->
    <div *ngIf="containingPaths.length > 0 || loadingPaths" class="paths-section">
      <h2>ğŸ“š Appears in Learning Paths</h2>
      <p class="paths-description">This content is part of the following curated learning journeys:</p>

      <div *ngIf="loadingPaths" class="paths-loading">
        <span class="spinner-small"></span> Loading paths...
      </div>

      <div *ngIf="!loadingPaths && containingPaths.length > 0" class="paths-list">
        <button
          *ngFor="let pathRef of containingPaths"
          class="path-card"
          (click)="navigateToPath(pathRef.pathId, pathRef.stepIndex)"
          type="button">
          <div class="path-header">
            <span class="path-icon">ğŸ—ºï¸</span>
            <span class="path-title">{{ pathRef.pathTitle }}</span>
          </div>
          <div class="path-meta">
            <span class="path-step">Step {{ pathRef.stepIndex + 1 }}</span>
            <span class="path-action">View in context â†’</span>
          </div>
        </button>
      </div>
    </div>

    <!-- Related content -->
    <div *ngIf="relatedNodes.length > 0" class="related-section">
      <h2>ğŸ”— Related Content</h2>
      <div class="related-grid">
        <button
          *ngFor="let relatedNode of relatedNodes"
          class="related-card"
          (click)="viewRelatedContent(relatedNode)"
          (keydown.enter)="viewRelatedContent(relatedNode)"
          type="button">
          <div class="related-header">
            <span class="related-type">{{ relatedNode.contentType }}</span>
            <span class="related-affinity">
              {{ getRelatedNodeAffinity(relatedNode.id) }}%
            </span>
          </div>
          <h3 class="related-title">{{ relatedNode.title }}</h3>
          <p class="related-description">{{ relatedNode.description }}</p>
        </button>
      </div>
    </div>
  </div>
</div>