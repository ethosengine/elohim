<div class="profile-page">
  <!-- Header -->
  <header class="profile-header">
    <div class="profile-avatar">
      @if (session?.avatarUrl && !isNetworkAuthenticated()) {
        <img [src]="session!.avatarUrl" [alt]="displayName()" class="avatar-image" />
      } @else {
        <div class="avatar-placeholder" [class.authenticated]="isNetworkAuthenticated()">
          {{ displayName().charAt(0) }}
        </div>
      }
    </div>

    <div class="profile-info">
      <h1 class="profile-name">{{ displayName() }}</h1>
      <div class="profile-badge" [class]="'badge-' + identityMode()">
        <span class="badge-icon">{{ modeBadgeIcon() }}</span>
        <span class="badge-text">{{ modeBadgeText() }}</span>
      </div>
      @if (bio()) {
        <p class="profile-bio">{{ bio() }}</p>
      }
      @if (location()) {
        <p class="profile-location">
          <span class="location-icon">location_on</span>
          {{ location() }}
        </p>
      }
      @if (interests().length > 0) {
        <div class="profile-interests">
          @for (interest of interests(); track interest) {
            <span class="interest-tag">{{ interest }}</span>
          }
        </div>
      }
    </div>

    <div class="profile-actions">
      <button class="btn-secondary" (click)="setActiveTab('settings')">
        <span class="btn-icon">settings</span>
        Edit Profile
      </button>
    </div>
  </header>

  <!-- Upgrade Banner - Only show for session visitors -->
  @if (!isNetworkAuthenticated()) {
    <div class="upgrade-banner">
      <div class="upgrade-content">
        <span class="upgrade-icon">cloud_sync</span>
        <div class="upgrade-text">
          <strong>Your progress is stored locally</strong>
          <p>Install the Elohim app to save your progress permanently and sync across devices.</p>
        </div>
        <button class="btn-primary">Join Network</button>
      </div>
    </div>
  }

  <!-- Tab Navigation -->
  <nav class="tab-nav">
    <button
      class="tab-btn"
      [class.active]="activeTab === 'overview'"
      (click)="setActiveTab('overview')"
    >
      Overview
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'paths'"
      (click)="setActiveTab('paths')"
    >
      Paths
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'timeline'"
      (click)="setActiveTab('timeline')"
    >
      Timeline
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'network'"
      (click)="setActiveTab('network')"
    >
      Network
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'settings'"
      (click)="setActiveTab('settings')"
    >
      Settings
    </button>
  </nav>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Overview Tab -->
    @if (activeTab === 'overview') {
      <div class="tab-panel overview-panel">
        <!-- Quick Stats -->
        <section class="stats-section">
          <h2 class="section-title">Journey Stats</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <span class="stat-value">{{ session?.stats?.nodesViewed ?? 0 }}</span>
              <span class="stat-label">Content Viewed</span>
            </div>
            <div class="stat-card">
              <span class="stat-value">{{ session?.stats?.pathsStarted ?? 0 }}</span>
              <span class="stat-label">Paths Started</span>
            </div>
            <div class="stat-card">
              <span class="stat-value">{{ session?.stats?.pathsCompleted ?? 0 }}</span>
              <span class="stat-label">Paths Completed</span>
            </div>
            <div class="stat-card">
              <span class="stat-value">{{ session?.stats?.stepsCompleted ?? 0 }}</span>
              <span class="stat-label">Steps Completed</span>
            </div>
            <div class="stat-card">
              <span class="stat-value">{{ getSessionDuration() }}</span>
              <span class="stat-label">Journey Duration</span>
            </div>
            <div class="stat-card">
              <span class="stat-value">{{ session?.stats?.sessionCount ?? 1 }}</span>
              <span class="stat-label">Sessions</span>
            </div>
          </div>
        </section>

        <!-- Mastery Overview -->
        @if (masteryStats && masteryStats.totalMasteredNodes > 0) {
          <section class="mastery-section">
            <h2 class="section-title">Mastery Progress</h2>
            <div class="mastery-summary">
              <div class="mastery-total">
                <span class="mastery-number">{{ masteryStats.totalMasteredNodes }}</span>
                <span class="mastery-label">Content Nodes Mastered</span>
              </div>
              <div class="mastery-gate">
                <span class="gate-number">{{ masteryStats.nodesAboveGate }}</span>
                <span class="gate-label">Above Attestation Gate</span>
              </div>
            </div>

            @if (masteryByLevel.length > 0) {
              <div class="mastery-breakdown">
                <h3>By Level</h3>
                <div class="level-bars">
                  @for (item of masteryByLevel; track item.level) {
                    <div class="level-bar">
                      <span class="level-label">{{ item.label }}</span>
                      <div class="level-track">
                        <div
                          class="level-fill"
                          [style.width.%]="(item.count / masteryStats.totalMasteredNodes) * 100"
                          [style.backgroundColor]="getMasteryLevelColor(item.level)"
                        ></div>
                      </div>
                      <span class="level-count">{{ item.count }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </section>
        }

        <!-- Recent Activity -->
        @if (activityHistory.length > 0) {
          <section class="recent-activity">
            <h2 class="section-title">Recent Activity</h2>
            <div class="activity-list">
              @for (activity of activityHistory.slice(-5).reverse(); track activity.timestamp) {
                <div class="activity-item">
                  <span class="activity-icon material-icons">{{ getActivityIcon(activity.type) }}</span>
                  <span class="activity-text">{{ getActivityLabel(activity.type) }}: {{ activity.resourceId }}</span>
                  <span class="activity-time">{{ formatTimestamp(activity.timestamp) }}</span>
                </div>
              }
            </div>
            <button class="btn-link" (click)="setActiveTab('timeline')">View Full Timeline</button>
          </section>
        }
      </div>
    }

    <!-- Paths Tab -->
    @if (activeTab === 'paths') {
      <div class="tab-panel paths-panel">
        @if (pathProgressList.length === 0) {
          <div class="empty-state">
            <span class="empty-icon material-icons">route</span>
            <h3>No paths started yet</h3>
            <p>Start a learning path to track your progress here.</p>
            <a routerLink="/lamad" class="btn-primary">Browse Paths</a>
          </div>
        } @else {
          <div class="path-list">
            @for (progress of pathProgressList; track progress.pathId) {
              <div class="path-card">
                <div class="path-info">
                  <h3 class="path-title">{{ progress.pathId }}</h3>
                  <div class="path-meta">
                    <span>Step {{ progress.currentStepIndex + 1 }}</span>
                    <span>{{ progress.completedStepIndices.length }} completed</span>
                  </div>
                </div>
                <div class="path-progress">
                  <div class="progress-bar">
                    <div
                      class="progress-fill"
                      [style.width.%]="getPathProgressPercentage(progress)"
                    ></div>
                  </div>
                </div>
                <div class="path-actions">
                  <a
                    [routerLink]="['/lamad/path', progress.pathId, 'step', progress.currentStepIndex]"
                    class="btn-secondary"
                  >
                    Continue
                  </a>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- Timeline Tab -->
    @if (activeTab === 'timeline') {
      <div class="tab-panel timeline-panel">
        <!-- Filter -->
        <div class="timeline-filter">
          <button
            class="filter-btn"
            [class.active]="activityFilter === 'all'"
            (click)="setActivityFilter('all')"
          >All</button>
          <button
            class="filter-btn"
            [class.active]="activityFilter === 'view'"
            (click)="setActivityFilter('view')"
          >Views</button>
          <button
            class="filter-btn"
            [class.active]="activityFilter === 'affinity'"
            (click)="setActivityFilter('affinity')"
          >Affinity</button>
          <button
            class="filter-btn"
            [class.active]="activityFilter === 'path-start'"
            (click)="setActivityFilter('path-start')"
          >Path Starts</button>
          <button
            class="filter-btn"
            [class.active]="activityFilter === 'step-complete'"
            (click)="setActivityFilter('step-complete')"
          >Steps</button>
        </div>

        @if (filteredActivities.length === 0) {
          <div class="empty-state">
            <span class="empty-icon material-icons">history</span>
            <h3>No activity yet</h3>
            <p>Your learning activity will appear here.</p>
          </div>
        } @else {
          <div class="timeline-list">
            @for (activity of filteredActivities; track activity.timestamp) {
              <div class="timeline-item">
                <div class="timeline-marker">
                  <span class="material-icons">{{ getActivityIcon(activity.type) }}</span>
                </div>
                <div class="timeline-content">
                  <span class="timeline-action">{{ getActivityLabel(activity.type) }}</span>
                  <span class="timeline-resource">{{ activity.resourceId }}</span>
                  @if (activity.metadata) {
                    <span class="timeline-meta">{{ activity.metadata | json }}</span>
                  }
                </div>
                <div class="timeline-time">{{ formatTimestamp(activity.timestamp) }}</div>
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- Network Tab -->
    @if (activeTab === 'network') {
      <div class="tab-panel network-panel">
        <!-- Sovereignty Stage Card -->
        <section class="sovereignty-stage-card">
          <div class="stage-header">
            <span class="material-icons stage-icon">{{ stageInfo().icon }}</span>
            <div class="stage-info">
              <span class="stage-badge" [class]="getStageBadgeClass()">
                {{ stageInfo().label }}
              </span>
              <span class="stage-tagline">{{ stageInfo().tagline }}</span>
            </div>
            <div class="connection-status">
              <span class="status-dot" [class]="getStatusDotClass()"></span>
              <span class="status-label">{{ connectionStatus().label }}</span>
            </div>
          </div>
          <p class="stage-description">{{ stageInfo().description }}</p>

          <!-- Stage Benefits & Limitations -->
          <div class="stage-details">
            <div class="benefits">
              <h4>Benefits</h4>
              <ul>
                @for (benefit of stageInfo().benefits; track benefit) {
                  <li>
                    <span class="material-icons benefit-icon">check_circle</span>
                    {{ benefit }}
                  </li>
                }
              </ul>
            </div>
            <div class="limitations">
              <h4>Current Limitations</h4>
              <ul>
                @for (limitation of stageInfo().limitations; track limitation) {
                  <li>
                    <span class="material-icons limitation-icon">info</span>
                    {{ limitation }}
                  </li>
                }
              </ul>
            </div>
          </div>

          <!-- Upgrade CTA -->
          @if (canUpgrade()) {
            <div class="upgrade-cta">
              <span class="material-icons">arrow_upward</span>
              <span>Ready to upgrade? Move to <strong>{{ sovereigntyState().migrationTarget }}</strong> for more control.</span>
              <button class="btn-primary">Learn About Upgrading</button>
            </div>
          }
        </section>

        <!-- Data Residency Section -->
        <section class="data-residency-section">
          <h2 class="section-title">
            <span class="material-icons">storage</span>
            Where Your Data Lives
          </h2>
          <p class="section-description">
            Understanding where your data is stored helps you make informed decisions about your digital sovereignty.
          </p>

          <div class="residency-grid">
            @for (item of sovereigntyState().dataResidency; track item.category) {
              <div class="residency-card">
                <div class="residency-header">
                  <span class="material-icons residency-icon">{{ item.icon }}</span>
                  <div class="residency-info">
                    <span class="residency-label">{{ item.label }}</span>
                    <span class="residency-location">{{ item.locationLabel }}</span>
                  </div>
                  <span class="material-icons location-icon">{{ getLocationIcon(item.location) }}</span>
                </div>
                <p class="residency-description">{{ item.description }}</p>
                <div class="residency-meta">
                  <span class="meta-item" [class.exportable]="item.exportable">
                    <span class="material-icons">{{ item.exportable ? 'download' : 'block' }}</span>
                    {{ item.exportable ? 'Exportable' : 'Not Exportable' }}
                  </span>
                  <span class="meta-item" [class.deletable]="item.deletable">
                    <span class="material-icons">{{ item.deletable ? 'delete' : 'lock' }}</span>
                    {{ item.deletable ? 'Deletable' : 'Permanent' }}
                  </span>
                  <span class="meta-item controller">
                    Controlled by: {{ item.controlledBy }}
                  </span>
                </div>
              </div>
            }
          </div>
        </section>

        <!-- Connection Details Section (when connected) -->
        @if (isConnected()) {
          <section class="connection-section">
            <h2 class="section-title">
              <span class="material-icons">lan</span>
              Connection Details
            </h2>

            <div class="connection-grid">
              <div class="connection-row">
                <span class="connection-label">Admin URL</span>
                <span class="connection-value monospace">{{ edgeNodeInfo().adminUrl }}</span>
              </div>

              @if (edgeNodeInfo().agentPubKey) {
                <div class="connection-row">
                  <span class="connection-label">Agent Public Key</span>
                  <div class="connection-value-with-copy">
                    <code class="truncated" [title]="edgeNodeInfo().agentPubKey">
                      {{ truncateHash(edgeNodeInfo().agentPubKey) }}
                    </code>
                    <button
                      class="copy-btn"
                      (click)="copyToClipboard(edgeNodeInfo().agentPubKey!)"
                      title="Copy full key"
                    >
                      <span class="material-icons">content_copy</span>
                    </button>
                  </div>
                </div>
              }

              @if (edgeNodeInfo().dnaHash) {
                <div class="connection-row">
                  <span class="connection-label">DNA Hash</span>
                  <div class="connection-value-with-copy">
                    <code class="truncated" [title]="edgeNodeInfo().dnaHash">
                      {{ truncateHash(edgeNodeInfo().dnaHash) }}
                    </code>
                    <button
                      class="copy-btn"
                      (click)="copyToClipboard(edgeNodeInfo().dnaHash!)"
                      title="Copy full hash"
                    >
                      <span class="material-icons">content_copy</span>
                    </button>
                  </div>
                </div>
              }

              @if (edgeNodeInfo().connectedAt) {
                <div class="connection-row">
                  <span class="connection-label">Connected Since</span>
                  <span class="connection-value">{{ edgeNodeInfo().connectedAt?.toLocaleString() }}</span>
                </div>
              }

              <div class="connection-row">
                <span class="connection-label">Credentials</span>
                <span class="connection-value" [class.stored]="edgeNodeInfo().hasStoredCredentials">
                  {{ edgeNodeInfo().hasStoredCredentials ? 'Stored in browser' : 'Not stored' }}
                </span>
              </div>
            </div>

            <div class="connection-actions">
              <button class="btn-secondary" (click)="reconnect()">
                <span class="material-icons">refresh</span>
                Reconnect
              </button>
            </div>
          </section>
        }

        <!-- Keys Section -->
        @if (sovereigntyState().keys.length > 0) {
          <section class="keys-section">
            <h2 class="section-title">
              <span class="material-icons">vpn_key</span>
              Your Keys
            </h2>

            <div class="keys-grid">
              @for (key of sovereigntyState().keys; track key.type) {
                <div class="key-card">
                  <div class="key-header">
                    <span class="key-label">{{ key.label }}</span>
                    <span class="key-type">{{ key.type }}</span>
                  </div>
                  <div class="key-value">
                    <code [title]="key.value">{{ key.truncated }}</code>
                    @if (key.canExport) {
                      <button
                        class="copy-btn"
                        (click)="copyToClipboard(key.value)"
                        title="Copy"
                      >
                        <span class="material-icons">content_copy</span>
                      </button>
                    }
                  </div>
                  <div class="key-actions">
                    @if (key.canExport) {
                      <span class="key-action exportable">
                        <span class="material-icons">download</span> Exportable
                      </span>
                    }
                    @if (key.canRevoke) {
                      <span class="key-action revokable">
                        <span class="material-icons">cancel</span> Revokable
                      </span>
                    }
                  </div>
                </div>
              }
            </div>
          </section>
        }

        <!-- Not Connected State -->
        @if (!isConnected() && connectionStatus().state !== 'connecting') {
          <section class="not-connected-section">
            <div class="not-connected-card">
              <span class="material-icons not-connected-icon">cloud_off</span>
              <h3>Not Connected to Network</h3>
              <p>{{ connectionStatus().description }}</p>
              <button class="btn-primary" (click)="reconnect()">
                <span class="material-icons">wifi</span>
                Connect to Network
              </button>
            </div>
          </section>
        }
      </div>
    }

    <!-- Settings Tab -->
    @if (activeTab === 'settings') {
      <div class="tab-panel settings-panel">
        <!-- Profile Edit -->
        <section class="settings-section">
          <h2 class="section-title">Profile Information</h2>

          @if (!isEditing) {
            <div class="profile-display">
              <div class="field-row">
                <span class="field-label">Display Name</span>
                <span class="field-value">{{ displayName() }}</span>
              </div>
              @if (!isNetworkAuthenticated()) {
                <div class="field-row">
                  <span class="field-label">Avatar URL</span>
                  <span class="field-value">{{ session?.avatarUrl || '(not set)' }}</span>
                </div>
              }
              <div class="field-row">
                <span class="field-label">Bio</span>
                <span class="field-value">{{ bio() || '(not set)' }}</span>
              </div>
              @if (isNetworkAuthenticated()) {
                <div class="field-row">
                  <span class="field-label">Location</span>
                  <span class="field-value">{{ location() || '(not set)' }}</span>
                </div>
                <div class="field-row">
                  <span class="field-label">Profile Visibility</span>
                  <span class="field-value">{{ profileReach() || 'community' }}</span>
                </div>
              } @else {
                <div class="field-row">
                  <span class="field-label">Locale</span>
                  <span class="field-value">{{ session?.locale || '(not set)' }}</span>
                </div>
              }
              <div class="field-row">
                <span class="field-label">{{ isNetworkAuthenticated() ? 'Affinities' : 'Interests' }}</span>
                <span class="field-value">{{ interests().join(', ') || '(not set)' }}</span>
              </div>
              <button class="btn-primary" (click)="startEditing()">Edit Profile</button>
            </div>
          } @else {
            <form class="profile-form" (submit)="saveProfile(); $event.preventDefault()">
              <div class="form-group">
                <label for="displayName">Display Name</label>
                <input
                  id="displayName"
                  type="text"
                  [(ngModel)]="editForm.displayName"
                  name="displayName"
                  placeholder="Your name"
                />
              </div>
              @if (!isNetworkAuthenticated()) {
                <div class="form-group">
                  <label for="avatarUrl">Avatar URL</label>
                  <input
                    id="avatarUrl"
                    type="url"
                    [(ngModel)]="editForm.avatarUrl"
                    name="avatarUrl"
                    placeholder="https://example.com/avatar.jpg"
                  />
                </div>
              }
              <div class="form-group">
                <label for="bio">Bio</label>
                <textarea
                  id="bio"
                  [(ngModel)]="editForm.bio"
                  name="bio"
                  rows="3"
                  placeholder="Tell us about yourself..."
                ></textarea>
              </div>
              @if (!isNetworkAuthenticated()) {
                <div class="form-group">
                  <label for="locale">Locale</label>
                  <input
                    id="locale"
                    type="text"
                    [(ngModel)]="editForm.locale"
                    name="locale"
                    placeholder="en_US"
                  />
                </div>
              }
              <div class="form-group">
                <label for="interests">{{ isNetworkAuthenticated() ? 'Affinities' : 'Interests' }} (comma-separated)</label>
                <input
                  id="interests"
                  type="text"
                  [(ngModel)]="editForm.interests"
                  name="interests"
                  placeholder="faith, technology, ethics"
                />
              </div>
              <div class="form-actions">
                <button type="submit" class="btn-primary">Save Changes</button>
                <button type="button" class="btn-secondary" (click)="cancelEditing()">Cancel</button>
              </div>
            </form>
          }
        </section>

        <!-- Data Management -->
        <section class="settings-section">
          <h2 class="section-title">Data Management</h2>
          @if (isNetworkAuthenticated()) {
            <p class="section-description">
              Your data is stored on the Elohim network. You have full control over your identity and can export your data at any time.
            </p>
          } @else {
            <p class="section-description">
              Your session data is stored locally in your browser. Export it to save a backup or transfer to another device.
            </p>
          }
          <div class="settings-actions">
            <button class="btn-secondary" (click)="exportData()">
              <span class="btn-icon">download</span>
              Export Data
            </button>
            @if (!isNetworkAuthenticated()) {
              <button class="btn-danger" (click)="resetSession()">
                <span class="btn-icon">delete</span>
                Reset Session
              </button>
            }
          </div>
        </section>

        <!-- Identity Info -->
        <section class="settings-section">
          <h2 class="section-title">{{ isNetworkAuthenticated() ? 'Identity Information' : 'Session Information' }}</h2>
          <div class="info-grid">
            @if (isNetworkAuthenticated()) {
              <div class="info-row">
                <span class="info-label">Human ID</span>
                <code class="info-value">{{ identityService.humanId() ?? 'N/A' }}</code>
              </div>
              <div class="info-row">
                <span class="info-label">Identity Mode</span>
                <span class="info-value identity-mode" [class]="'mode-' + identityMode()">{{ modeBadgeText() }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Member Since</span>
                <span class="info-value">{{ memberSince() ? formatTimestamp(memberSince()!) : 'N/A' }}</span>
              </div>
            } @else {
              <div class="info-row">
                <span class="info-label">Session ID</span>
                <code class="info-value">{{ session?.sessionId ?? 'N/A' }}</code>
              </div>
              <div class="info-row">
                <span class="info-label">Created</span>
                <span class="info-value">{{ session?.createdAt ? formatTimestamp(session!.createdAt) : 'N/A' }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Last Active</span>
                <span class="info-value">{{ session?.lastActiveAt ? formatTimestamp(session!.lastActiveAt) : 'N/A' }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Access Level</span>
                <span class="info-value">{{ session?.accessLevel ?? 'visitor' }}</span>
              </div>
            }
          </div>
        </section>
      </div>
    }
  </div>
</div>
