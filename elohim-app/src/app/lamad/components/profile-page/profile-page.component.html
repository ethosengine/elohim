<div class="profile-page">
  <!-- Header (simplified: avatar + name + mode badge only) -->
  <header class="profile-header">
    <div class="profile-avatar">
      @if (session?.avatarUrl && !isNetworkAuthenticated()) {
        <img [src]="session!.avatarUrl" [alt]="displayName()" class="avatar-image" />
      } @else {
        <div class="avatar-placeholder" [class.authenticated]="isNetworkAuthenticated()">
          {{ displayName().charAt(0) }}
        </div>
      }
    </div>

    <div class="profile-info">
      <h1 class="profile-name">{{ displayName() }}</h1>
      <div class="profile-badge" [ngClass]="'badge-' + identityMode()">
        <span class="badge-icon">{{ modeBadgeIcon() }}</span>
        <span class="badge-text">{{ modeBadgeText() }}</span>
      </div>
    </div>

    <div class="profile-actions">
      <a routerLink="/identity/profile" class="btn-link identity-link">
        <span class="btn-icon">account_circle</span>
        ImagoDeI Profile
      </a>
      <button type="button" class="btn-secondary" (click)="goToIdentityProfile()">
        <span class="btn-icon">settings</span>
        Edit Profile
      </button>
    </div>
  </header>

  <!-- Upgrade Banner - Only show for session visitors -->
  @if (!isNetworkAuthenticated()) {
    <div class="upgrade-banner">
      <div class="upgrade-content">
        <span class="upgrade-icon">cloud_sync</span>
        <div class="upgrade-text">
          <strong>Your progress is stored locally</strong>
          <p>Install the Elohim app to save your progress permanently and sync across devices.</p>
        </div>
        <button type="button" class="btn-primary" (click)="onJoinNetwork()">Join Network</button>
      </div>
    </div>
  }

  <!-- Tab Navigation (3 tabs: Overview, Paths, Timeline) -->
  <nav class="tab-nav">
    <button
      type="button"
      class="tab-btn"
      [class.active]="activeTab === 'overview'"
      (click)="setActiveTab('overview')"
    >
      Overview
    </button>
    <button
      type="button"
      class="tab-btn"
      [class.active]="activeTab === 'paths'"
      (click)="setActiveTab('paths')"
    >
      Paths
    </button>
    <button
      type="button"
      class="tab-btn"
      [class.active]="activeTab === 'timeline'"
      (click)="setActiveTab('timeline')"
    >
      Timeline
    </button>
  </nav>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Overview Tab -->
    @if (activeTab === 'overview') {
      <div class="tab-panel overview-panel">
        <!-- Resume Point Card -->
        @if (resumePoint) {
          <section class="resume-section">
            @if (resumePoint.type === 'continue_path') {
              <div class="resume-card resume-card--continue">
                <div class="resume-icon-wrapper">
                  <span class="material-icons resume-icon">play_circle</span>
                </div>
                <div class="resume-content">
                  <span class="resume-label">Continue Your Journey</span>
                  <h3 class="resume-title">{{ resumePoint.title }}</h3>
                  <p class="resume-reason">{{ resumePoint.reason }}</p>
                </div>
                <a
                  [routerLink]="['/lamad/path', resumePoint.pathId, 'step', resumePoint.stepIndex]"
                  class="resume-action"
                >
                  <span>Continue</span>
                  <span class="material-icons">arrow_forward</span>
                </a>
              </div>
            } @else {
              <div class="resume-card resume-card--explore">
                <div class="resume-icon-wrapper resume-icon-wrapper--explore">
                  <span class="material-icons resume-icon">explore</span>
                </div>
                <div class="resume-content">
                  <span class="resume-label">Start Exploring</span>
                  <h3 class="resume-title">{{ resumePoint.title }}</h3>
                  <p class="resume-reason">{{ resumePoint.reason }}</p>
                </div>
                <a routerLink="/lamad" class="resume-action resume-action--explore">
                  <span>Browse Paths</span>
                  <span class="material-icons">arrow_forward</span>
                </a>
              </div>
            }
          </section>
        }

        <!-- Quick Stats -->
        <section class="stats-section">
          <h2 class="section-title">Journey Stats</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <span class="stat-value">{{ session?.stats?.nodesViewed ?? 0 }}</span>
              <span class="stat-label">Content Viewed</span>
            </div>
            <div class="stat-card">
              <span class="stat-value">{{ session?.stats?.pathsStarted ?? 0 }}</span>
              <span class="stat-label">Paths Started</span>
            </div>
            <div class="stat-card">
              <span class="stat-value">{{ session?.stats?.pathsCompleted ?? 0 }}</span>
              <span class="stat-label">Paths Completed</span>
            </div>
            <div class="stat-card">
              <span class="stat-value">{{ session?.stats?.stepsCompleted ?? 0 }}</span>
              <span class="stat-label">Steps Completed</span>
            </div>
            <div class="stat-card">
              <span class="stat-value">{{ getSessionDuration() }}</span>
              <span class="stat-label">Journey Duration</span>
            </div>
            <div class="stat-card">
              <span class="stat-value">{{ session?.stats?.sessionCount ?? 1 }}</span>
              <span class="stat-label">Sessions</span>
            </div>
          </div>
        </section>

        <!-- Learning Economy -->
        @if (learnerProfile) {
          <section class="gamification-section">
            <h2 class="section-title">Learning Economy</h2>
            <div class="stats-grid">
              <div class="stat-card stat-card--xp">
                <span class="material-icons stat-card-icon">school</span>
                <span class="stat-value">{{ learnerProfile.totalXP | number }}</span>
                <span class="stat-label">Total XP</span>
              </div>
              <div class="stat-card stat-card--streak">
                <span
                  class="material-icons stat-card-icon"
                  [class.streak-active]="learnerProfile.streak.todayActive"
                >
                  local_fire_department
                </span>
                <span class="stat-value">{{ learnerProfile.streak.currentStreak }}</span>
                <span class="stat-label">Day Streak</span>
              </div>
              <div class="stat-card stat-card--tier">
                <span
                  class="material-icons stat-card-icon"
                  [style.color]="learnerProfile.learnerLevel.color"
                >
                  {{ learnerProfile.learnerLevel.icon }}
                </span>
                <span class="stat-value">{{ learnerProfile.learnerLevel.label }}</span>
                <span class="stat-label">Learner Level</span>
              </div>
            </div>
            <a routerLink="/lamad/me" class="dashboard-link">
              View Full Dashboard
              <span class="material-icons">arrow_forward</span>
            </a>
          </section>
        }

        <!-- Mastery Overview -->
        @if (masteryStats && masteryStats.totalMasteredNodes > 0) {
          <section class="mastery-section">
            <h2 class="section-title">Mastery Progress</h2>
            <div class="mastery-summary">
              <div class="mastery-total">
                <span class="mastery-number">{{ masteryStats.totalMasteredNodes }}</span>
                <span class="mastery-label">Content Nodes Mastered</span>
              </div>
              <div class="mastery-gate">
                <span class="gate-number">{{ masteryStats.nodesAboveGate }}</span>
                <span class="gate-label">Above Attestation Gate</span>
              </div>
            </div>

            @if (masteryByLevel.length > 0) {
              <div class="mastery-breakdown">
                <h3>By Level</h3>
                <div class="level-bars">
                  @for (item of masteryByLevel; track item.level) {
                    <div class="level-bar">
                      <span class="level-label">{{ item.label }}</span>
                      <div class="level-track">
                        <div
                          class="level-fill"
                          [style.width.%]="(item.count / masteryStats.totalMasteredNodes) * 100"
                          [style.backgroundColor]="getMasteryLevelColor(item.level)"
                        ></div>
                      </div>
                      <span class="level-count">{{ item.count }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </section>
        }

        <!-- Recent Activity -->
        @if (activityHistory.length > 0) {
          <section class="recent-activity">
            <h2 class="section-title">Recent Activity</h2>
            <div class="activity-list">
              @for (activity of activityHistory.slice(-5).reverse(); track activity.timestamp) {
                <div class="activity-item">
                  <span class="activity-icon material-icons">
                    {{ getActivityIcon(activity.type) }}
                  </span>
                  <span class="activity-text">
                    {{ getActivityLabel(activity.type) }}: {{ activity.resourceId }}
                  </span>
                  <span class="activity-time">{{ formatTimestamp(activity.timestamp) }}</span>
                </div>
              }
            </div>
            <button type="button" class="btn-link" (click)="setActiveTab('timeline')">
              View Full Timeline
            </button>
          </section>
        }
      </div>
    }

    <!-- Paths Tab -->
    @if (activeTab === 'paths') {
      <div class="tab-panel paths-panel">
        @if (
          !pathsOverview ||
          (pathsOverview.inProgress.length === 0 &&
            pathsOverview.completed.length === 0 &&
            pathsOverview.suggested.length === 0)
        ) {
          <div class="empty-state">
            <span class="empty-icon material-icons">route</span>
            <h3>No paths started yet</h3>
            <p>Start a learning path to track your progress here.</p>
            <a routerLink="/lamad" class="btn-primary">Browse Paths</a>
          </div>
        } @else {
          <!-- In Progress Section -->
          @if (pathsOverview.inProgress.length > 0) {
            <section class="paths-section">
              <div class="paths-section-header">
                <span class="material-icons paths-section-icon paths-section-icon--progress">
                  schedule
                </span>
                <h3 class="paths-section-title">In Progress</h3>
                <span class="paths-section-count">{{ pathsOverview.inProgress.length }}</span>
              </div>
              <div class="paths-grid">
                @for (path of pathsOverview.inProgress; track path.pathId) {
                  <div class="path-card path-card--in-progress">
                    <div class="path-card-header">
                      <span class="path-difficulty path-difficulty--{{ path.difficulty }}">
                        {{ path.difficulty }}
                      </span>
                    </div>
                    <h4 class="path-card-title">{{ path.title }}</h4>
                    <p class="path-card-description">{{ path.description }}</p>
                    <div class="path-card-progress">
                      <div class="progress-bar-enhanced">
                        <div
                          class="progress-fill-enhanced"
                          [style.width.%]="path.progressPercent"
                        ></div>
                      </div>
                      <span class="progress-text">
                        {{ path.completedSteps }}/{{ path.totalSteps }} steps Â·
                        {{ path.progressPercent }}%
                      </span>
                    </div>
                    <a
                      [routerLink]="['/lamad/path', path.pathId, 'step', path.currentStepIndex]"
                      class="path-card-action"
                    >
                      Continue
                      <span class="material-icons">arrow_forward</span>
                    </a>
                  </div>
                }
              </div>
            </section>
          }

          <!-- Completed Section -->
          @if (pathsOverview.completed.length > 0) {
            <section class="paths-section">
              <div class="paths-section-header">
                <span class="material-icons paths-section-icon paths-section-icon--completed">
                  emoji_events
                </span>
                <h3 class="paths-section-title">Completed</h3>
                <span class="paths-section-count">{{ pathsOverview.completed.length }}</span>
              </div>
              <div class="paths-grid">
                @for (path of pathsOverview.completed; track path.pathId) {
                  <div class="path-card path-card--completed">
                    <div class="path-card-header">
                      <span class="completion-badge">
                        <span class="material-icons">verified</span>
                        Completed
                      </span>
                    </div>
                    <h4 class="path-card-title">{{ path.title }}</h4>
                    <p class="path-card-description">{{ path.description }}</p>
                    <div class="path-card-meta">
                      <span class="meta-item">
                        <span class="material-icons">check_circle</span>
                        {{ path.totalSteps }} steps
                      </span>
                      @if (path.attestationsGranted?.length) {
                        <span class="meta-item attestation">
                          <span class="material-icons">workspace_premium</span>
                          {{ path.attestationsGranted?.length }} attestation{{
                            path.attestationsGranted?.length !== 1 ? 's' : ''
                          }}
                        </span>
                      }
                    </div>
                    <a
                      [routerLink]="['/lamad/path', path.pathId]"
                      class="path-card-action path-card-action--review"
                    >
                      Review
                      <span class="material-icons">visibility</span>
                    </a>
                  </div>
                }
              </div>
            </section>
          }

          <!-- Suggested Section -->
          @if (pathsOverview.suggested.length > 0) {
            <section class="paths-section">
              <div class="paths-section-header">
                <span class="material-icons paths-section-icon paths-section-icon--suggested">
                  auto_awesome
                </span>
                <h3 class="paths-section-title">Suggested for You</h3>
              </div>
              <div class="paths-grid">
                @for (path of pathsOverview.suggested; track path.pathId) {
                  <div class="path-card path-card--suggested">
                    <div class="path-card-header">
                      <span class="path-difficulty path-difficulty--{{ path.difficulty }}">
                        {{ path.difficulty }}
                      </span>
                    </div>
                    <h4 class="path-card-title">{{ path.title }}</h4>
                    <p class="path-card-description">{{ path.description }}</p>
                    <div class="path-card-meta">
                      <span class="meta-item">
                        <span class="material-icons">format_list_numbered</span>
                        {{ path.totalSteps }} steps
                      </span>
                    </div>
                    <a
                      [routerLink]="['/lamad/path', path.pathId]"
                      class="path-card-action path-card-action--start"
                    >
                      Start Path
                      <span class="material-icons">arrow_forward</span>
                    </a>
                  </div>
                }
              </div>
            </section>
          }
        }
      </div>
    }

    <!-- Timeline Tab -->
    @if (activeTab === 'timeline') {
      <div class="tab-panel timeline-panel">
        <!-- Timeline Header -->
        <div class="timeline-header">
          <h3 class="timeline-title">
            <span class="material-icons">auto_stories</span>
            Your Learning Journey
          </h3>
          <p class="timeline-subtitle">Milestones and progress on your path to mastery</p>
        </div>

        @if (timelineEvents.length === 0) {
          <div class="empty-state">
            <span class="empty-icon material-icons">timeline</span>
            <h3>Your journey begins here</h3>
            <p>Start exploring content to see your learning timeline.</p>
            <a routerLink="/lamad" class="btn-primary">Start Exploring</a>
          </div>
        } @else {
          <div class="timeline-enhanced">
            <div class="timeline-line"></div>
            @for (event of timelineEvents; track event.id; let i = $index) {
              <div
                class="timeline-event"
                [class.timeline-event--milestone]="event.significance === 'milestone'"
              >
                <div
                  class="timeline-event-marker"
                  [style.background]="getTimelineEventColor(event.significance)"
                >
                  <span class="material-icons">{{ getTimelineEventIcon(event.type) }}</span>
                </div>
                <div class="timeline-event-content">
                  <div class="timeline-event-header">
                    <span class="timeline-event-title">{{ event.title }}</span>
                    <span class="timeline-event-date">
                      {{ formatTimelineDate(event.timestamp) }}
                    </span>
                  </div>
                  @if (event.description) {
                    <p class="timeline-event-description">{{ event.description }}</p>
                  }
                  @if (event.resourceId) {
                    <a
                      [routerLink]="
                        event.resourceType === 'path'
                          ? ['/lamad/path', event.resourceId]
                          : ['/lamad/content', event.resourceId]
                      "
                      class="timeline-event-link"
                    >
                      View {{ event.resourceType }}
                      <span class="material-icons">open_in_new</span>
                    </a>
                  }
                </div>
              </div>
            }
          </div>
        }

        <!-- Legacy filter (if user prefers activity-level detail) -->
        <details class="timeline-legacy-toggle">
          <summary>View detailed activity log</summary>
          <div class="timeline-filter">
            <button
              type="button"
              class="filter-btn"
              [class.active]="activityFilter === 'all'"
              (click)="setActivityFilter('all')"
            >
              All
            </button>
            <button
              type="button"
              class="filter-btn"
              [class.active]="activityFilter === 'view'"
              (click)="setActivityFilter('view')"
            >
              Views
            </button>
            <button
              type="button"
              class="filter-btn"
              [class.active]="activityFilter === 'affinity'"
              (click)="setActivityFilter('affinity')"
            >
              Affinity
            </button>
            <button
              type="button"
              class="filter-btn"
              [class.active]="activityFilter === 'path-start'"
              (click)="setActivityFilter('path-start')"
            >
              Path Starts
            </button>
            <button
              type="button"
              class="filter-btn"
              [class.active]="activityFilter === 'step-complete'"
              (click)="setActivityFilter('step-complete')"
            >
              Steps
            </button>
          </div>
          @if (filteredActivities.length > 0) {
            <div class="timeline-list">
              @for (activity of filteredActivities; track activity.timestamp) {
                <div class="timeline-item">
                  <div class="timeline-marker">
                    <span class="material-icons">{{ getActivityIcon(activity.type) }}</span>
                  </div>
                  <div class="timeline-content">
                    <span class="timeline-action">{{ getActivityLabel(activity.type) }}</span>
                    <span class="timeline-resource">{{ activity.resourceId }}</span>
                  </div>
                  <div class="timeline-time">{{ formatTimestamp(activity.timestamp) }}</div>
                </div>
              }
            </div>
          }
        </details>
      </div>
    }
  </div>
</div>
