<!-- Elohim Navigator Header -->
<header class="elohim-header">
  <div class="header-content">
    <div class="left-nav-group">
      <!-- App Logo - links to context home -->
      <a [routerLink]="currentApp.route" class="app-logo-link" [title]="currentApp.name + ' Home'">
        <span class="app-icon">{{ currentApp.icon }}</span>
        <span class="app-name">{{ currentApp.name }}</span>
      </a>

      <!-- Context Switcher Button -->
      <div class="context-switcher-container">
        <button
          type="button"
          class="context-switch-btn"
          (click)="toggleContextSwitcher($event)"
          [attr.aria-expanded]="showContextSwitcher"
          aria-haspopup="true"
          title="Switch context"
        >
          <svg
            class="dropdown-arrow"
            [class.open]="showContextSwitcher"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>

        <!-- Context Switcher Dropdown -->
        <div class="context-switcher-dropdown" *ngIf="showContextSwitcher" role="menu">
          <div class="dropdown-header">
            <span class="dropdown-title">Switch to</span>
          </div>
          <div class="scrollable-content-wrapper">
            <div class="context-apps-list">
              <button
                type="button"
                *ngFor="let app of otherApps"
                class="context-app-item"
                [class.coming-soon]="!app.available"
                (click)="switchContext(app)"
                role="menuitem"
                [disabled]="!app.available"
              >
                <span class="app-item-icon">{{ app.icon }}</span>
                <div class="app-item-info">
                  <span class="app-item-name">{{ app.name }}</span>
                  <span class="app-item-tagline">{{ app.tagline }}</span>
                </div>
                <span *ngIf="!app.available" class="coming-soon-badge">Soon</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Separator -->
    <span class="header-separator">|</span>

    <!-- Protocol Link -->
    <a routerLink="/" class="protocol-link" title="Elohim Protocol">by Elohim Protocol</a>

    <!-- Center: Search (optional) -->
    <div class="search-container" *ngIf="showSearch">
      <form (ngSubmit)="onSearch()" class="search-form">
        <input
          type="text"
          [(ngModel)]="searchQuery"
          name="search"
          placeholder="Search {{ currentApp.name }}..."
          class="search-input"
        />
        <button type="submit" class="search-button" aria-label="Search">
          <svg
            class="search-icon"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </button>
      </form>
    </div>

    <!-- Right: Auth Section -->
    @if (isAuthenticated()) {
      <!-- Connection Status Indicator -->
      <app-connection-indicator></app-connection-indicator>

      <!-- Authenticated: Show Profile Bubble -->
      <div class="profile-bubble-container">
        <button
          type="button"
          class="profile-bubble"
          (click)="toggleProfileTray($event)"
          [attr.aria-expanded]="showProfileTray"
          aria-haspopup="true"
          title="Your profile and settings"
        >
          <span class="profile-avatar">{{ getInitials() }}</span>
        </button>

        <!-- Profile Tray Dropdown -->
        <div class="profile-tray" *ngIf="showProfileTray" role="menu">
          <!-- Identity Header -->
          <div class="profile-header">
            <div class="profile-avatar-large">{{ getInitials() }}</div>
            <div class="profile-info">
              <span class="profile-name">{{ authenticatedDisplayName() }}</span>
              <span class="profile-stats">
                {{ identityMode() === 'hosted' ? 'Hosted Identity' : 'Steward' }}
              </span>
            </div>
          </div>

          <div class="scrollable-content-wrapper">
            <!-- Actions -->
            <div class="profile-actions">
              <button type="button" class="profile-action" (click)="goToProfile()" role="menuitem">
                <svg
                  class="action-icon"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <span class="action-label">View Profile</span>
              </button>
              <button
                type="button"
                class="profile-action logout-action"
                (click)="onLogout()"
                role="menuitem"
              >
                <svg
                  class="action-icon"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                  <polyline points="16 17 21 12 16 7"></polyline>
                  <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                <span class="action-label">Log Out</span>
              </button>
            </div>

            <!-- Settings Section -->
            <div class="settings-section">
              <div class="settings-header">Settings</div>
              <div class="settings-row">
                <span class="settings-label">Theme</span>
                <app-theme-toggle></app-theme-toggle>
              </div>
            </div>

            <!-- Sovereignty Badge - At-a-glance sovereignty status -->
            <app-sovereignty-badge></app-sovereignty-badge>

            <!-- Footer -->
            <div class="profile-footer">
              <span class="session-indicator">
                {{ identityMode() === 'hosted' ? 'Hosted on Edge Node' : 'Steward Identity' }}
              </span>
            </div>
          </div>
        </div>
      </div>
    } @else {
      <!-- Theme Toggle for visitors (Lamad only) -->
      @if (context === 'lamad') {
        <app-theme-toggle [inline]="true"></app-theme-toggle>
      }
      <!-- Visitor: Show Login/Register Buttons -->
      <div class="auth-buttons">
        <button type="button" class="auth-btn auth-btn-link" (click)="goToLogin()">Log In</button>
        <button type="button" class="auth-btn auth-btn-primary" (click)="goToRegister()">
          Sign Up
        </button>
      </div>
    }
  </div>
</header>

<!-- Mobile Menu Backdrop -->
<div
  class="mobile-menu-backdrop"
  *ngIf="showContextSwitcher || showProfileTray"
  (click)="closeAllTrays()"
  (keydown.enter)="closeAllTrays()"
  (keydown.space)="closeAllTrays()"
  tabindex="0"
  aria-hidden="true"
></div>

<!-- Upgrade Prompt Banner -->
<div *ngIf="activeUpgradePrompt && !showUpgradeModal" class="upgrade-banner">
  <div class="upgrade-banner-content">
    <svg
      class="upgrade-icon"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <polygon
        points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
      ></polygon>
    </svg>
    <div class="upgrade-text">
      <strong>{{ activeUpgradePrompt.title }}</strong>
      <span>{{ activeUpgradePrompt.message }}</span>
    </div>
    <div class="upgrade-actions">
      <button type="button" class="btn-upgrade" (click)="onJoinNetwork()">Learn More</button>
      <button
        type="button"
        class="btn-dismiss"
        (click)="dismissUpgradePrompt()"
        aria-label="Dismiss"
      >
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- Main Content Area -->
<main class="elohim-main" id="main-content">
  <ng-content></ng-content>
</main>

<!-- Upgrade Modal -->
<dialog
  *ngIf="showUpgradeModal"
  class="modal-overlay"
  (click)="closeUpgradeModal()"
  (keydown.escape)="closeUpgradeModal()"
  open
  aria-labelledby="upgrade-modal-title"
>
  <div
    class="upgrade-modal"
    (click)="$event.stopPropagation()"
    (keydown)="$event.stopPropagation()"
  >
    <button type="button" class="modal-close" (click)="closeUpgradeModal()" aria-label="Close">
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>

    <div class="modal-header">
      <h2 id="upgrade-modal-title">Join the Elohim Network</h2>
      <p class="modal-subtitle">Save your progress permanently and connect with other learners</p>
    </div>

    <div class="modal-body">
      <div class="upgrade-benefits">
        <h3>What you'll get:</h3>
        <ul>
          <li>
            <span class="benefit-icon">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
            </span>
            <div>
              <strong>Permanent Progress</strong>
              <p>Your learning journey is stored securely, never lost</p>
            </div>
          </li>
          <li>
            <span class="benefit-icon">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M23 4v6h-6"></path>
                <path d="M1 20v-6h6"></path>
                <path
                  d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
                ></path>
              </svg>
            </span>
            <div>
              <strong>Sync Across Devices</strong>
              <p>Continue learning from any device</p>
            </div>
          </li>
          <li>
            <span class="benefit-icon">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </span>
            <div>
              <strong>Join the Community</strong>
              <p>Connect with fellow humans on the same paths</p>
            </div>
          </li>
          <li>
            <span class="benefit-icon">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="8" r="7"></circle>
                <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
              </svg>
            </span>
            <div>
              <strong>Earn Attestations</strong>
              <p>Verifiable credentials for your achievements</p>
            </div>
          </li>
          <li>
            <span class="benefit-icon">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <path
                  d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"
                ></path>
              </svg>
            </span>
            <div>
              <strong>Decentralized Network</strong>
              <p>Own your data on a peer-to-peer network</p>
            </div>
          </li>
        </ul>
      </div>

      <div class="upgrade-how">
        <h3>How it works:</h3>
        <ol>
          <li>Install the Elohim app (available soon)</li>
          <li>Your session progress migrates automatically</li>
          <li>You join the p2p network and receive updates</li>
        </ol>
      </div>

      <div class="session-summary" *ngIf="session">
        <h3>Your Current Session:</h3>
        <div class="summary-stats">
          <div class="stat">
            <span class="stat-value">{{ session.stats.nodesViewed }}</span>
            <span class="stat-label">Content Explored</span>
          </div>
          <div class="stat">
            <span class="stat-value">{{ session.stats.pathsStarted }}</span>
            <span class="stat-label">Paths Started</span>
          </div>
          <div class="stat">
            <span class="stat-value">{{ session.stats.stepsCompleted }}</span>
            <span class="stat-label">Steps Completed</span>
          </div>
        </div>
        <p class="summary-note">This progress will migrate when you join.</p>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeUpgradeModal()">
        Continue as Visitor
      </button>
      <button type="button" class="btn-primary" disabled title="Coming soon!">
        Get Notified When Available
      </button>
    </div>
  </div>
</dialog>
