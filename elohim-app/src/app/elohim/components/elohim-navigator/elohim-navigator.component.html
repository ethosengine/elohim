<!-- Elohim Navigator Header -->
<header class="elohim-header">
  <div class="header-content">
    <div class="left-nav-group">
      <!-- App Logo - links to context home -->
      <a [routerLink]="currentApp.route" class="app-logo-link" [title]="currentApp.name + ' Home'">
        <span class="app-icon">{{ currentApp.icon }}</span>
        <span class="app-name">{{ currentApp.name }}</span>
      </a>

      <!-- Context Switcher Button -->
      <div class="context-switcher-container">
        <button
          type="button"
          class="context-switch-btn"
          (click)="toggleContextSwitcher($event)"
          [attr.aria-expanded]="showContextSwitcher"
          aria-haspopup="true"
          title="Switch context"
        >
          <svg
            class="dropdown-arrow"
            [class.open]="showContextSwitcher"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>

        <!-- Context Switcher Dropdown -->
        <div class="context-switcher-dropdown" *ngIf="showContextSwitcher" role="menu">
          <div class="dropdown-header">
            <span class="dropdown-title">Switch to</span>
          </div>
          <div class="scrollable-content-wrapper">
            <div class="context-apps-list">
              <button
                type="button"
                *ngFor="let app of otherApps"
                class="context-app-item"
                [class.coming-soon]="!app.available"
                (click)="switchContext(app)"
                role="menuitem"
                [disabled]="!app.available"
              >
                <span class="app-item-icon">{{ app.icon }}</span>
                <div class="app-item-info">
                  <span class="app-item-name">{{ app.name }}</span>
                  <span class="app-item-tagline">{{ app.tagline }}</span>
                </div>
                <span *ngIf="!app.available" class="coming-soon-badge">Soon</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Separator -->
    <span class="header-separator">|</span>

    <!-- Protocol Link -->
    <a routerLink="/" class="protocol-link" title="Elohim Protocol">by Elohim Protocol</a>

    <!-- Center: Search (optional) -->
    <div class="search-container" *ngIf="showSearch">
      <form (ngSubmit)="onSearch()" class="search-form">
        <input
          type="text"
          [(ngModel)]="searchQuery"
          name="search"
          placeholder="Search {{ currentApp.name }}..."
          class="search-input"
        />
        <button type="submit" class="search-button" aria-label="Search">
          <svg
            class="search-icon"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </button>
      </form>
    </div>

    <!-- Right: Auth Section -->
    @if (isAuthenticated()) {
      <!-- Connection Status Indicator -->
      <app-connection-indicator></app-connection-indicator>

      <!-- Authenticated: Show Profile Bubble -->
      <div class="profile-bubble-container">
        <button
          type="button"
          class="profile-bubble"
          (click)="toggleProfileTray($event)"
          [attr.aria-expanded]="showProfileTray"
          aria-haspopup="true"
          title="Your profile and settings"
        >
          <span class="profile-avatar">{{ getInitials() }}</span>
        </button>

        <!-- Profile Tray Dropdown -->
        <div class="profile-tray" *ngIf="showProfileTray" role="menu">
          <!-- Identity Header - links to Imago Dei profile -->
          <button
            type="button"
            class="profile-header profile-header-link"
            (click)="goToIdentityProfile()"
            role="menuitem"
            title="Manage your identity"
          >
            <div class="profile-avatar-large">{{ getInitials() }}</div>
            <div class="profile-info">
              <span class="profile-name">{{ authenticatedDisplayName() }}</span>
              <span class="profile-identifier" *ngIf="authenticatedIdentifier()">
                {{ authenticatedIdentifier() }}
              </span>
              <span class="profile-stats">
                {{ identityMode() === 'hosted' ? 'Hosted Identity' : 'Steward' }}
              </span>
            </div>
            <svg
              class="profile-header-arrow"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>

          <div class="scrollable-content-wrapper">
            <!-- Connection Details -->
            <div class="profile-connection-details" *ngIf="doorwayUrl() || authenticatedHumanId()">
              <div class="connection-detail" *ngIf="doorwayUrl()">
                <span class="detail-label">Doorway</span>
                <span class="detail-value">{{ shortenDoorwayUrl(doorwayUrl()!) }}</span>
              </div>
              <div class="connection-detail" *ngIf="authenticatedHumanId()">
                <span class="detail-label">Human ID</span>
                <span class="detail-value monospace">
                  {{ truncateHash(authenticatedHumanId()) }}
                </span>
              </div>
            </div>

            <!-- Actions -->
            <div class="profile-actions">
              <button
                type="button"
                class="profile-action"
                (click)="goToContextProfile()"
                role="menuitem"
              >
                <span class="action-icon-emoji">{{ currentApp.icon }}</span>
                <span class="action-label">{{ contextProfileLabel }}</span>
              </button>
              <button
                type="button"
                class="profile-action logout-action"
                (click)="onLogout()"
                role="menuitem"
              >
                <svg
                  class="action-icon"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                  <polyline points="16 17 21 12 16 7"></polyline>
                  <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                <span class="action-label">Log Out</span>
              </button>
            </div>

            <!-- Settings Section -->
            <div class="settings-section">
              <div class="settings-header">Settings</div>
              <div class="settings-row">
                <span class="settings-label">Theme</span>
                <app-theme-toggle></app-theme-toggle>
              </div>
            </div>

            <!-- Agency Badge - At-a-glance agency status -->
            <app-agency-badge></app-agency-badge>

            <!-- Footer -->
            <div class="profile-footer">
              <span class="session-indicator">
                {{ identityMode() === 'hosted' ? 'Hosted on Edge Node' : 'Steward Identity' }}
              </span>
            </div>
          </div>
        </div>
      </div>
    } @else {
      <!-- Theme Toggle for visitors (Lamad only) -->
      @if (context === 'lamad') {
        <app-theme-toggle [inline]="true"></app-theme-toggle>
      }
      <!-- Visitor: Show Login/Register Buttons -->
      <div class="auth-buttons">
        <button type="button" class="auth-btn auth-btn-link" (click)="goToLogin()">Log In</button>
        <button type="button" class="auth-btn auth-btn-primary" (click)="goToRegister()">
          Sign Up
        </button>
      </div>
    }
  </div>
</header>

<!-- Mobile Menu Backdrop -->
<button
  type="button"
  class="mobile-menu-backdrop"
  *ngIf="showContextSwitcher || showProfileTray"
  (click)="closeAllTrays()"
  aria-label="Close menu"
></button>

<!-- Banner Notifications (aggregated from providers) -->
<app-alert-banner
  *ngIf="bannerAlerts.length > 0 && !showUpgradeModal"
  [alerts]="bannerAlerts"
  [displayMode]="'banner'"
  (dismissed)="onBannerDismissed($event)"
  (actionClicked)="onBannerAction($event)"
></app-alert-banner>

<!-- Main Content Area -->
<main class="elohim-main" id="main-content">
  <ng-content></ng-content>
</main>

<!-- Upgrade Modal -->
<app-upgrade-modal
  [session]="session"
  [open]="showUpgradeModal"
  (closed)="closeUpgradeModal()"
></app-upgrade-modal>
