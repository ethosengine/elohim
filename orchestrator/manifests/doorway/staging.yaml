# Doorway Staging Deployment — Agency On-Ramp
#
# Five roles in one process:
#   1. DNS/TLS gateway (stateless HTTP routing)
#   2. Bootstrap/Signal (agent discovery + WebRTC relay)
#   3. Projection cache (HTTP API for DHT content)
#   4. Identity host (custodial agent keys for hosted users)
#   5. Recovery registrar (relationship-based identity recovery)
#
# Never owns data — connects to P2P StatefulSet via ClusterIP service.
# Scaling is via the conductor pool behind doorway, not doorway replicas.
# See doorway/SCALING.md for the full model.
#
# Architecture:
#   Browser -> Ingress -> Doorway (auth + routing) -> edgenode service (conductor/storage)
#   Doorway-app (operator dashboard) served from same pod via localhost
#
# Ports:
#   - 8080: Doorway Gateway (public, authenticated)
#   - 80:   Operator Dashboard (nginx, pod-internal)
---
# Secret for Doorway Gateway API keys
apiVersion: v1
kind: Secret
metadata:
  name: elohim-doorway-staging-secrets
  namespace: elohim-staging
type: Opaque
stringData:
  # IMPORTANT: Change these in production!
  api-key-authenticated: "dev-elohim-auth-2024"
  api-key-admin: "dev-elohim-admin-2024"
  jwt-secret: "dev-jwt-secret-change-in-production-2024"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: elohim-doorway-staging
  namespace: elohim-staging
  labels:
    app: elohim-doorway
    environment: staging
spec:
  replicas: 1
  selector:
    matchLabels:
      app: elohim-doorway
      environment: staging
  template:
    metadata:
      labels:
        app: elohim-doorway
        environment: staging
    spec:
      nodeSelector:
        node-type: operations
      containers:
        # Doorway Gateway - Rust WebSocket gateway with auth, worker pool
        - name: doorway
          image: harbor.ethosengine.com/ethosengine/elohim-doorway:DOORWAY_TAG_PLACEHOLDER
          imagePullPolicy: Always
          args:
            - "--listen"
            - "0.0.0.0:8080"
            - "--conductor-url"
            - "ws://elohim-edgenode-staging:4445"
          ports:
            - name: gateway-ws
              containerPort: 8080
              protocol: TCP
          env:
            - name: DEV_MODE
              value: "true"
            - name: RUST_LOG
              value: "info,doorway=debug"
            - name: PROJECTION_WRITER
              value: "true"
            - name: CONDUCTOR_URLS
              value: "ws://elohim-edgenode-staging-0.elohim-edgenode-staging-headless:8445,ws://elohim-edgenode-staging-1.elohim-edgenode-staging-headless:8445"
            - name: CONDUCTOR_ADMIN_URL
              value: "ws://elohim-edgenode-staging:4444"
            - name: STORAGE_URL
              value: "http://elohim-edgenode-staging:8090"
            - name: THRESHOLD_URL
              value: "http://localhost:80"
            - name: NATS_URL
              value: "nats://nats.elohim-staging:4222"
            - name: MONGODB_URI
              value: "mongodb://mongodb.elohim-staging:27017"
            - name: MONGODB_DB
              value: "doorway-staging"
            - name: DOORWAY_ID
              value: "staging-elohim-host"
            - name: DOORWAY_URL
              value: "https://doorway-staging.elohim.host"
            - name: BOOTSTRAP_URL
              value: "https://doorway-staging.elohim.host/bootstrap"
            - name: SIGNAL_URL
              value: "wss://signal.doorway-staging.elohim.host"
            - name: INSTALLED_APP_ID
              value: "elohim"
            - name: HAPP_BUNDLE_PATH
              value: "/opt/holochain/elohim.happ"
            - name: FEDERATION_PEERS
              value: "https://doorway-alpha.elohim.host,https://doorway.elohim.host"
            - name: API_KEY_AUTHENTICATED
              valueFrom:
                secretKeyRef:
                  name: elohim-doorway-staging-secrets
                  key: api-key-authenticated
            - name: API_KEY_ADMIN
              valueFrom:
                secretKeyRef:
                  name: elohim-doorway-staging-secrets
                  key: api-key-admin
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: elohim-doorway-staging-secrets
                  key: jwt-secret
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 30
        # Doorway Operator Dashboard - Angular app for node operators
        # Provides: federated OAuth, node metrics, configuration UI
        - name: doorway-app
          image: harbor.ethosengine.com/ethosengine/doorway-app:DOORWAY_APP_TAG_PLACEHOLDER
          imagePullPolicy: Always
          ports:
            - name: operator-ui
              containerPort: 80
              protocol: TCP
          env:
            - name: DOORWAY_API_URL
              value: "http://localhost:8080"
          resources:
            requests:
              memory: "32Mi"
              cpu: "10m"
            limits:
              memory: "128Mi"
              cpu: "100m"
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 10
            periodSeconds: 30
---
apiVersion: v1
kind: Service
metadata:
  name: elohim-doorway-staging
  namespace: elohim-staging
  labels:
    app: elohim-doorway
    environment: staging
spec:
  type: ClusterIP
  ports:
    # Doorway Gateway (for Ingress → doorway)
    - name: gateway-ws
      port: 8080
      targetPort: 8080
      protocol: TCP
    # Doorway Operator Dashboard
    - name: operator-ui
      port: 8081
      targetPort: 80
      protocol: TCP
  selector:
    app: elohim-doorway
    environment: staging
---
# Public Ingress - routes all traffic through authenticated Doorway Gateway
# Supports: /admin, /app/*, /bootstrap/*, /api/v1/*, /operator/*
# Signal subdomain: signal.doorway-staging.elohim.host (tx5/SBD protocol)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: elohim-doorway-staging
  namespace: elohim-staging
  annotations:
    # WebSocket support for /admin, /app/*, signal subdomain
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$binary_remote_addr"
    nginx.ingress.kubernetes.io/websocket-services: "elohim-doorway-staging"
    # Required for WebSocket upgrade headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    cert-manager.io/cluster-issuer: letsencrypt-production
spec:
  ingressClassName: public
  tls:
    - hosts:
        - doorway-staging.elohim.host
        - signal.doorway-staging.elohim.host
      secretName: doorway-staging-tls
  rules:
    - host: doorway-staging.elohim.host
      http:
        paths:
          # Read-heavy paths → read replica service (PROJECTION_WRITER=false)
          - path: /api/v1/cache
            pathType: Prefix
            backend:
              service:
                name: elohim-doorway-read-staging
                port:
                  number: 8080
          - path: /store
            pathType: Prefix
            backend:
              service:
                name: elohim-doorway-read-staging
                port:
                  number: 8080
          - path: /api/blob
            pathType: Prefix
            backend:
              service:
                name: elohim-doorway-read-staging
                port:
                  number: 8080
          - path: /api/stream
            pathType: Prefix
            backend:
              service:
                name: elohim-doorway-read-staging
                port:
                  number: 8080
          # Everything else → writer service (identity host, admin, bootstrap, etc.)
          - path: /
            pathType: Prefix
            backend:
              service:
                name: elohim-doorway-staging
                port:
                  number: 8080
    - host: signal.doorway-staging.elohim.host
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: elohim-doorway-staging
                port:
                  number: 8080
