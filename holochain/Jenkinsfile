/**
 * Holochain Infrastructure Pipeline
 *
 * Builds DNA/hApp and deploys Edge Node to dev/alpha environments.
 * Triggered on changes to holochain/** directory.
 *
 * Resource Requirements (Nix + Rust/WASM compilation):
 *   - Memory: 8-16GB (Rust compiler is memory-hungry)
 *   - Disk: 30-50GB for /nix store (with Cachix, much less needed)
 *   - CPU: 4+ cores recommended for parallel compilation
 *
 * Caching Strategy:
 *   - Cachix (holochain-ci): Pre-built Holochain binaries
 *   - PVC for /nix: Persistent store across builds (avoids re-download)
 *
 * Environments:
 *   - dev: holochain-dev.elohim.host (for Che workspace development)
 *   - alpha: holochain-alpha.elohim.host (for integration testing)
 *
 * @see https://github.com/holochain/holonix
 * @see https://app.cachix.org/cache/holochain-ci
 */

def loadBuildVars() {
    def rootEnv = "${env.WORKSPACE}/build.env"
    def path = fileExists(rootEnv) ? rootEnv : 'build.env'

    if (!fileExists(path)) {
        echo "WARNING: build.env not found at ${path}, using defaults"
        def gitHash = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
        def sanitizedBranch = env.BRANCH_NAME.replaceAll('/', '-')
        return [
            BASE_VERSION: 'dev',
            GIT_COMMIT_HASH: gitHash,
            IMAGE_TAG: "dev-${sanitizedBranch}-${gitHash}",
            BRANCH_NAME: env.BRANCH_NAME
        ]
    }

    return readProperties(file: path)
}

def withBuildVars(props, Closure body) {
    withEnv([
        "BASE_VERSION=${props.BASE_VERSION ?: ''}",
        "GIT_COMMIT_HASH=${props.GIT_COMMIT_HASH ?: ''}",
        "IMAGE_TAG=${props.IMAGE_TAG ?: ''}",
        "BRANCH_NAME=${props.BRANCH_NAME ?: env.BRANCH_NAME}"
    ]) {
        body()
    }
}

pipeline {
    agent {
        kubernetes {
            cloud 'kubernetes'
            yaml '''
apiVersion: v1
kind: Pod
spec:
  serviceAccount: jenkins-deployer
  # Holochain/Nix builds need 8+ cores and 16GB RAM
  # operations node (Intel NUC i5) is best fit
  nodeSelector:
    node-type: operations
  tolerations:
    - key: "workload-type"
      operator: "Equal"
      value: "build"
      effect: "NoSchedule"
  volumes:
    - name: containerd-sock
      hostPath:
        path: /var/snap/microk8s/common/run/containerd.sock
        type: Socket
    - name: buildkit-run
      emptyDir: {}
    # Persistent Nix store - survives across builds
    # PVC created by holochain/manifests/nix-cache-pvc.yaml
    - name: nix-store
      persistentVolumeClaim:
        claimName: nix-cache-holochain
    # Cargo cache for Rust builds
    - name: cargo-cache
      persistentVolumeClaim:
        claimName: cargo-cache-holochain
  containers:
    - name: builder
      image: harbor.ethosengine.com/ethosengine/ci-builder-nix:latest
      command: [cat]
      tty: true
      resources:
        requests:
          memory: "4Gi"
          cpu: "2"
          ephemeral-storage: "5Gi"
        limits:
          memory: "8Gi"
          cpu: "4"
          ephemeral-storage: "10Gi"
      volumeMounts:
        - name: containerd-sock
          mountPath: /run/containerd/containerd.sock
        - name: buildkit-run
          mountPath: /run/buildkit
        # Note: /nix PVC mount removed - it was hiding the Nix installation from the image
        # The image has Nix pre-installed; PVC caching can be added later with proper setup
        - name: cargo-cache
          mountPath: /root/.cargo
    - name: buildkitd
      image: moby/buildkit:v0.12.5
      securityContext:
        privileged: true
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"
        limits:
          memory: "1Gi"
          cpu: "1"
      args:
        - --addr
        - unix:///run/buildkit/buildkitd.sock
        - --oci-worker=true
        - --containerd-worker=false
      volumeMounts:
        - name: containerd-sock
          mountPath: /run/containerd/containerd.sock
        - name: buildkit-run
          mountPath: /run/buildkit
'''
        }
    }

    environment {
        BRANCH_NAME = "${env.BRANCH_NAME ?: 'main'}"
        HAPP_NAME = "lamad-spike"
        // Nix PATH not inherited from Dockerfile in Jenkins shell steps
        PATH = "/nix/var/nix/profiles/default/bin:${env.PATH}"
    }

    options {
        // Nix builds can take a while, especially first time
        timeout(time: 60, unit: 'MINUTES')
        // Don't run multiple Holochain builds simultaneously (resource contention)
        disableConcurrentBuilds()
    }

    stages {
        stage('Checkout') {
            // Always checkout - required for all subsequent stages
            steps {
                container('builder') {
                    script {
                        sh 'git config --global --add safe.directory "*"'
                        checkout scm
                        sh 'git clean -fdx'
                        sh 'git reset --hard HEAD'

                        echo "Building Holochain infrastructure for branch: ${env.BRANCH_NAME}"
                    }
                }
            }
        }

        stage('Setup Version') {
            // Always setup version - required for image tagging
            steps {
                container('builder') {
                    script {
                        sh 'git config --global --add safe.directory "*"'

                        def baseVersion = readFile('VERSION').trim()
                        def gitHash = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                        def sanitizedBranch = env.BRANCH_NAME.replaceAll('/', '-')

                        def imageTag = (env.BRANCH_NAME == 'main')
                            ? baseVersion
                            : "${baseVersion}-${sanitizedBranch}-${gitHash}"

                        def buildEnvContent = """BASE_VERSION=${baseVersion}
GIT_COMMIT_HASH=${gitHash}
IMAGE_TAG=${imageTag}
BRANCH_NAME=${env.BRANCH_NAME}"""

                        writeFile file: "${env.WORKSPACE}/build.env", text: buildEnvContent
                        archiveArtifacts artifacts: 'build.env', allowEmptyArchive: false
                    }
                }
            }
        }

        stage('Setup Nix Cache') {
            // Always setup nix - required for DNA builds
            steps {
                container('builder') {
                    script {
                        echo 'Configuring Nix with Holochain Cachix...'

                        // Verify Nix is working and cache is configured
                        sh '''
                            nix --version
                            echo "Nix config:"
                            nix show-config | grep -E "(substituters|trusted-public-keys)" || true

                            echo ""
                            echo "Testing cache connectivity..."
                            nix-store --query --requisites /nix/store/*.drv 2>/dev/null | head -5 || echo "Cache ready"
                        '''
                    }
                }
            }
        }

        stage('Build DNA') {
            when {
                // Only rebuild DNA when DNA source files change
                changeset "holochain/dna/**"
            }
            steps {
                container('builder') {
                    dir('holochain/dna/lamad-spike') {
                        script {
                            echo 'Building Holochain DNA with Nix...'
                            echo 'First build may take 20-40 minutes. Subsequent builds use cache.'

                            // Enter nix shell and build
                            sh '''#!/usr/bin/env bash
                                set -euo pipefail

                                # Fix git safe.directory for containerized builds
                                export HOME="${HOME:-/root}"
                                mkdir -p "$HOME"
                                echo "[safe]" > "$HOME/.gitconfig"
                                echo "    directory = *" >> "$HOME/.gitconfig"
                                export GIT_CONFIG_GLOBAL="$HOME/.gitconfig"

                                echo "=== Entering Nix development shell ==="
                                echo "This will download/build Holochain toolchain from Cachix..."

                                # Use nix develop to enter the flake environment and build
                                nix develop --accept-flake-config --command bash -c '
                                    set -euo pipefail

                                    echo "=== Holochain toolchain ready ==="
                                    hc --version
                                    rustc --version
                                    cargo --version

                                    echo ""
                                    echo "=== Building zomes (Rust -> WASM) ==="
                                    cargo build --release --target wasm32-unknown-unknown

                                    echo ""
                                    echo "=== Packaging DNA ==="
                                    hc dna pack . -o workdir/lamad_spike.dna

                                    echo ""
                                    echo "=== Packaging hApp ==="
                                    hc app pack workdir -o lamad-spike.happ

                                    echo ""
                                    echo "=== Build artifacts ==="
                                    ls -lh lamad-spike.happ workdir/lamad_spike.dna
                                '
                            '''

                            // Archive the hApp
                            archiveArtifacts artifacts: 'lamad-spike.happ,workdir/lamad_spike.dna', allowEmptyArchive: false
                            stash name: 'happ-bundle', includes: 'lamad-spike.happ'

                            def props = loadBuildVars()

                            echo """
                            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            âœ… hApp ARTIFACT ARCHIVED
                            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                            Artifact URL (for downstream consumers):
                            ${env.BUILD_URL}artifact/holochain/dna/lamad-spike/lamad-spike.happ

                            Direct wget command:
                            wget -O lamad.happ '${env.BUILD_URL}artifact/holochain/dna/lamad-spike/lamad-spike.happ'

                            Steward Pipeline:
                            The steward pipeline will automatically fetch this artifact
                            when building for branch: ${env.BRANCH_NAME}

                            This artifact sharing saves ~35 minutes per steward build!

                            Build Details:
                            - Image Tag: ${props.IMAGE_TAG ?: 'unknown'}
                            - Branch: ${env.BRANCH_NAME}
                            - Commit: ${env.GIT_COMMIT ?: 'unknown'}
                            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            """
                        }
                    }
                }
            }
        }

        stage('Build Doorway') {
            when {
                // Build when doorway code or manifests change
                anyOf {
                    changeset "holochain/doorway/**"
                    changeset "holochain/manifests/edgenode-*.yaml"
                }
            }
            steps {
                container('builder') {
                    script {
                        def props = loadBuildVars()

                        withBuildVars(props) {
                            echo "Building Doorway Gateway: ${IMAGE_TAG}"

                            sh """#!/bin/bash
                                set -euo pipefail

                                buildctl --addr unix:///run/buildkit/buildkitd.sock debug workers > /dev/null

                                cd holochain

                                # Build Doorway using multi-stage Dockerfile (Rust build)
                                # Context is holochain/ to include crates/doorway-client
                                BUILDKIT_HOST=unix:///run/buildkit/buildkitd.sock \\
                                    nerdctl -n k8s.io build \\
                                    -t elohim-doorway:${IMAGE_TAG} \\
                                    -f doorway/Dockerfile .

                                nerdctl -n k8s.io tag elohim-doorway:${IMAGE_TAG} elohim-doorway:${GIT_COMMIT_HASH}
                            """
                        }
                    }
                }
            }
        }

        stage('Build Edge Node Image') {
            when {
                changeset "holochain/**"
            }
            steps {
                container('builder') {
                    script {
                        def props = loadBuildVars()

                        withBuildVars(props) {
                            echo "Building Edge Node image: ${IMAGE_TAG}"

                            // Get hApp bundle - try stash first, then fetch from artifacts
                            def haveHapp = false
                            try {
                                dir('holochain/edgenode') {
                                    unstash 'happ-bundle'
                                }
                                echo "hApp bundle from current build"
                                haveHapp = true
                            } catch (Exception e) {
                                echo "No hApp stashed in this build - fetching from last successful build..."
                                def artifactUrl = "https://jenkins.ethosengine.com/job/elohim-holochain/job/${env.BRANCH_NAME}/lastSuccessfulBuild/artifact/holochain/dna/lamad-spike/lamad-spike.happ"
                                def fetchResult = sh(
                                    script: "wget --timeout=30 --tries=3 -O holochain/edgenode/lamad-spike.happ '${artifactUrl}' 2>&1",
                                    returnStatus: true
                                )
                                if (fetchResult == 0) {
                                    echo "hApp bundle fetched from artifacts"
                                    haveHapp = true
                                } else {
                                    echo "WARNING: Could not fetch hApp - skipping Edge Node build"
                                }
                            }

                            if (haveHapp) {
                                sh """#!/bin/bash
                                    set -euo pipefail

                                    buildctl --addr unix:///run/buildkit/buildkitd.sock debug workers > /dev/null

                                    cd holochain/edgenode

                                    # Build custom Edge Node with config baked in
                                    BUILDKIT_HOST=unix:///run/buildkit/buildkitd.sock \\
                                        nerdctl -n k8s.io build \\
                                        -t elohim-edgenode:${IMAGE_TAG} \\
                                        -f Dockerfile .

                                    nerdctl -n k8s.io tag elohim-edgenode:${IMAGE_TAG} elohim-edgenode:${GIT_COMMIT_HASH}
                                """
                            } else {
                                echo "Skipping Edge Node image build - no hApp available"
                            }
                        }
                    }
                }
            }
        }

        stage('Build hApp Installer') {
            when {
                changeset "holochain/**"
            }
            steps {
                container('builder') {
                    script {
                        def props = loadBuildVars()

                        withBuildVars(props) {
                            echo "Building hApp Installer image: ${IMAGE_TAG}"

                            // Get hApp bundle - try stash first, then fetch from artifacts
                            def haveHapp = false
                            try {
                                dir('holochain/edgenode/scripts') {
                                    unstash 'happ-bundle'
                                }
                                echo "hApp bundle from current build"
                                haveHapp = true
                            } catch (Exception e) {
                                echo "No hApp stashed - fetching from last successful build..."
                                def artifactUrl = "https://jenkins.ethosengine.com/job/elohim-holochain/job/${env.BRANCH_NAME}/lastSuccessfulBuild/artifact/holochain/dna/lamad-spike/lamad-spike.happ"
                                def fetchResult = sh(
                                    script: "wget --timeout=30 --tries=3 -O holochain/edgenode/scripts/lamad-spike.happ '${artifactUrl}' 2>&1",
                                    returnStatus: true
                                )
                                if (fetchResult == 0) {
                                    echo "hApp bundle fetched from artifacts"
                                    haveHapp = true
                                } else {
                                    echo "WARNING: Could not fetch hApp - skipping hApp Installer build"
                                }
                            }

                            if (haveHapp) {
                                sh """#!/bin/bash
                                    set -euo pipefail

                                    buildctl --addr unix:///run/buildkit/buildkitd.sock debug workers > /dev/null

                                    cd holochain/edgenode/scripts

                                    # Build hApp installer sidecar
                                    BUILDKIT_HOST=unix:///run/buildkit/buildkitd.sock \\
                                        nerdctl -n k8s.io build \\
                                        -t elohim-happ-installer:${IMAGE_TAG} \\
                                        -f Dockerfile .

                                    nerdctl -n k8s.io tag elohim-happ-installer:${IMAGE_TAG} elohim-happ-installer:${GIT_COMMIT_HASH}
                                """
                            } else {
                                echo "Skipping hApp Installer build - no hApp available"
                            }
                        }
                    }
                }
            }
        }

        stage('Push to Harbor') {
            when {
                changeset "holochain/**"
            }
            steps {
                container('builder') {
                    script {
                        def props = loadBuildVars()

                        withBuildVars(props) {
                            withCredentials([usernamePassword(credentialsId: 'harbor-robot-registry', passwordVariable: 'HARBOR_PASSWORD', usernameVariable: 'HARBOR_USERNAME')]) {
                                sh 'echo $HARBOR_PASSWORD | nerdctl -n k8s.io login harbor.ethosengine.com -u $HARBOR_USERNAME --password-stdin'

                                // Push Edge Node image (if it was built)
                                sh """
                                    if nerdctl -n k8s.io images | grep -q "elohim-edgenode.*${IMAGE_TAG}"; then
                                        echo "Pushing Edge Node image..."
                                        nerdctl -n k8s.io tag elohim-edgenode:${IMAGE_TAG} harbor.ethosengine.com/ethosengine/elohim-edgenode:${IMAGE_TAG}
                                        nerdctl -n k8s.io tag elohim-edgenode:${IMAGE_TAG} harbor.ethosengine.com/ethosengine/elohim-edgenode:${GIT_COMMIT_HASH}

                                        nerdctl -n k8s.io push harbor.ethosengine.com/ethosengine/elohim-edgenode:${IMAGE_TAG}
                                        nerdctl -n k8s.io push harbor.ethosengine.com/ethosengine/elohim-edgenode:${GIT_COMMIT_HASH}
                                    else
                                        echo "Edge Node image not found, skipping push"
                                    fi
                                """

                                // Push Doorway image (if it was built)
                                sh """
                                    if nerdctl -n k8s.io images | grep -q "elohim-doorway.*${IMAGE_TAG}"; then
                                        echo "Pushing Doorway image..."
                                        nerdctl -n k8s.io tag elohim-doorway:${IMAGE_TAG} harbor.ethosengine.com/ethosengine/elohim-doorway:${IMAGE_TAG}
                                        nerdctl -n k8s.io tag elohim-doorway:${IMAGE_TAG} harbor.ethosengine.com/ethosengine/elohim-doorway:${GIT_COMMIT_HASH}

                                        nerdctl -n k8s.io push harbor.ethosengine.com/ethosengine/elohim-doorway:${IMAGE_TAG}
                                        nerdctl -n k8s.io push harbor.ethosengine.com/ethosengine/elohim-doorway:${GIT_COMMIT_HASH}
                                    else
                                        echo "Doorway image not found, skipping push"
                                    fi
                                """

                                // Push hApp Installer image
                                sh """
                                    if nerdctl -n k8s.io images | grep -q "elohim-happ-installer.*${IMAGE_TAG}"; then
                                        echo "Pushing hApp Installer image..."
                                        nerdctl -n k8s.io tag elohim-happ-installer:${IMAGE_TAG} harbor.ethosengine.com/ethosengine/elohim-happ-installer:${IMAGE_TAG}
                                        nerdctl -n k8s.io tag elohim-happ-installer:${IMAGE_TAG} harbor.ethosengine.com/ethosengine/elohim-happ-installer:${GIT_COMMIT_HASH}

                                        nerdctl -n k8s.io push harbor.ethosengine.com/ethosengine/elohim-happ-installer:${IMAGE_TAG}
                                        nerdctl -n k8s.io push harbor.ethosengine.com/ethosengine/elohim-happ-installer:${GIT_COMMIT_HASH}
                                    else
                                        echo "hApp Installer image not found, skipping push"
                                    fi
                                """

                                if (env.BRANCH_NAME == 'dev') {
                                    sh """
                                        if nerdctl -n k8s.io images | grep -q "elohim-edgenode.*${IMAGE_TAG}"; then
                                            nerdctl -n k8s.io tag elohim-edgenode:${IMAGE_TAG} harbor.ethosengine.com/ethosengine/elohim-edgenode:dev-latest
                                            nerdctl -n k8s.io push harbor.ethosengine.com/ethosengine/elohim-edgenode:dev-latest
                                        fi

                                        if nerdctl -n k8s.io images | grep -q "elohim-doorway.*${IMAGE_TAG}"; then
                                            nerdctl -n k8s.io tag elohim-doorway:${IMAGE_TAG} harbor.ethosengine.com/ethosengine/elohim-doorway:dev-latest
                                            nerdctl -n k8s.io push harbor.ethosengine.com/ethosengine/elohim-doorway:dev-latest
                                        fi

                                        if nerdctl -n k8s.io images | grep -q "elohim-happ-installer.*${IMAGE_TAG}"; then
                                            nerdctl -n k8s.io tag elohim-happ-installer:${IMAGE_TAG} harbor.ethosengine.com/ethosengine/elohim-happ-installer:dev-latest
                                            nerdctl -n k8s.io push harbor.ethosengine.com/ethosengine/elohim-happ-installer:dev-latest
                                        fi
                                    """
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Deploy Edge Node - Dev') {
            when {
                allOf {
                    changeset "holochain/**"
                    anyOf {
                        branch 'dev'
                        expression { return env.BRANCH_NAME ==~ /feat-.+/ }
                        expression { return env.BRANCH_NAME ==~ /claude\/.+/ }
                    }
                }
            }
            steps {
                container('builder') {
                    script {
                        def props = loadBuildVars()

                        withBuildVars(props) {
                            echo "Deploying Edge Node to Dev: ${IMAGE_TAG}"

                            sh "sed 's/BUILD_NUMBER_PLACEHOLDER/${IMAGE_TAG}/g' holochain/manifests/edgenode-dev.yaml > holochain/manifests/edgenode-dev-${IMAGE_TAG}.yaml"
                            sh "kubectl apply -f holochain/manifests/edgenode-dev-${IMAGE_TAG}.yaml"
                            sh "kubectl rollout restart deployment/elohim-edgenode-dev -n ethosengine"
                            sh "kubectl rollout status deployment/elohim-edgenode-dev -n ethosengine --timeout=300s"

                            echo "Edge Node Dev deployed: https://doorway-dev.elohim.host"
                        }
                    }
                }
            }
        }

        stage('ðŸ”§ Seed Dev Database') {
            // PROTOTYPING/DEV ONLY - Not part of production pipeline
            // Automatically resets and populates the dev holochain database AFTER deployment
            // Only runs when DNA is rebuilt (not for other holochain changes)
            // Useful for rapid prototyping iteration during development
            when {
                allOf {
                    // Only seed when DNA or seed data changes (not for other holochain modifications)
                    anyOf {
                        changeset "holochain/dna/**"
                        changeset "holochain/seeder/**"
                    }
                    // Only for dev branches (never on production)
                    anyOf {
                        branch 'dev'
                        expression { return env.BRANCH_NAME ==~ /feat-.+/ }
                        expression { return env.BRANCH_NAME ==~ /claude\/.+/ }
                    }
                }
            }
            steps {
                container('builder') {
                    script {
                        echo """
                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        ðŸ”§ SEEDING DEV DATABASE (after deployment)
                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        Purpose: Populate dev holochain with test/prototype data
                        Scope: Development/prototyping only
                        Trigger: DNA was rebuilt in this pipeline run
                        Branch: ${env.BRANCH_NAME}
                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        """

                        // Wait for deployment to be fully ready
                        sh 'sleep 10'

                        dir('holochain/seeder') {
                            sh '''#!/usr/bin/env bash
                                set -euo pipefail

                                echo "Installing seeder dependencies..."
                                npm ci

                                echo ""
                                echo "Running seeder against doorway-dev.elohim.host..."
                                HOLOCHAIN_ADMIN_URL="wss://doorway-dev.elohim.host?apiKey=dev-elohim-auth-2024" \
                                    npx tsx src/seed.ts

                                echo ""
                                echo "âœ… Seeding complete"
                            '''
                        }

                        echo """
                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        âœ… Dev database seeded with elohim content
                        Ready for prototyping!
                        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        """
                    }
                }
            }
        }

        // NOTE: Alpha edge node deployment removed.
        // Consolidated architecture: holochain-dev.elohim.host serves both alpha and staging apps.
        // holochain.elohim.host (production) deployed from main branch.

        stage('Deploy Edge Node - Prod') {
            when {
                allOf {
                    changeset "holochain/**"
                    branch 'main'
                }
            }
            steps {
                container('builder') {
                    script {
                        def props = loadBuildVars()

                        withBuildVars(props) {
                            echo "Deploying Edge Node to Production: ${IMAGE_TAG}"

                            sh "sed 's/BUILD_NUMBER_PLACEHOLDER/${IMAGE_TAG}/g' holochain/manifests/edgenode-prod.yaml > holochain/manifests/edgenode-prod-${IMAGE_TAG}.yaml"
                            sh "kubectl apply -f holochain/manifests/edgenode-prod-${IMAGE_TAG}.yaml"
                            sh "kubectl rollout restart deployment/elohim-edgenode-prod -n ethosengine"
                            sh "kubectl rollout status deployment/elohim-edgenode-prod -n ethosengine --timeout=300s"

                            echo "Edge Node Prod deployed: https://holochain.elohim.host"
                        }
                    }
                }
            }
        }

        stage('Cleanup') {
            when {
                changeset "holochain/**"
            }
            steps {
                container('builder') {
                    script {
                        def props = loadBuildVars()

                        withBuildVars(props) {
                            sh """
                                nerdctl -n k8s.io rmi elohim-edgenode:${IMAGE_TAG} || true
                                nerdctl -n k8s.io rmi harbor.ethosengine.com/ethosengine/elohim-edgenode:${IMAGE_TAG} || true
                                nerdctl -n k8s.io rmi elohim-doorway:${IMAGE_TAG} || true
                                nerdctl -n k8s.io rmi harbor.ethosengine.com/ethosengine/elohim-doorway:${IMAGE_TAG} || true
                                nerdctl -n k8s.io rmi elohim-happ-installer:${IMAGE_TAG} || true
                                nerdctl -n k8s.io rmi harbor.ethosengine.com/ethosengine/elohim-happ-installer:${IMAGE_TAG} || true
                                nerdctl -n k8s.io system prune -af --volumes || true
                            """
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Holochain infrastructure pipeline completed successfully"
        }
        failure {
            echo "Holochain infrastructure pipeline failed"
            echo "If this is a first-time build, it may need more time/resources for Nix cache population"
        }
    }
}
